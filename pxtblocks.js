let iface;var pxt;!function(t){!function(e){function i(e,i){return t.worker.getWorker(t.webConfig.workerjs).opAsync(e,i)}e.workerOpAsync=i;let o={};function s(t,e){t.push.apply(t,e)}function l(t){if(!t)throw new Error("Assertion failure")}class n{constructor(t,e,i,o,s){this.link=t,this.type=e,this.parentType=i,this.childType=o,this.isArrayType=s}}let r;function a(t){return t.link?a(t.link):t}function c(t,e){let i=a(t),o=a(e);if(l(null==i.link&&null==o.link),i==o)return;if(i.childType&&o.childType){const t=i.childType;i.childType=null,c(t,o.childType)}else i.childType&&!o.childType&&(o.childType=i.childType);if(i.parentType&&o.parentType){const t=i.parentType;i.parentType=null,c(t,o.parentType)}else!i.parentType||o.parentType||o.type||(o.parentType=i.parentType);let s=function(t,e){if(null==t||"Array"===t&&b(e))return e;if(null==e||"Array"===e&&b(t))return t;if(t==e)return t;throw new Error("cannot mix "+t+" with "+e)}(i.type,o.type);t.link=o,i.link=o,i.isArrayType=o.isArrayType,t.type=null,e.type=s}function u(t,e=!1){return new n(null,t,null,null,e)}e.Point=n,function(t){t[t.None=0]="None",t[t.Argument=1]="Argument",t[t.Assigned=2]="Assigned",t[t.Implicit=3]="Implicit"}(r=e.BlockDeclarationType||(e.BlockDeclarationType={}));const d=u("number"),p=u("boolean"),h=u("string"),m=u("void");function f(t){if(!t)return u(t);switch(t.toLowerCase()){case"number":return d;case"boolean":return p;case"string":return h;case"void":return m;default:return u(t)}}function g(t,e){if(l(null!=e),function(t){return"placeholder"==t.type||t.type===pxtc.TS_OUTPUT_TYPE}(e))return e.p||(e.p=u(null)),a(e.p);if("variables_get"==e.type)return a(F(t,e,e.getField("VAR").getText()).type);if("function_call_output"==e.type)return function(t,e){const i=e.getField("function_name").getText();return k(t,i)}(t,e);if(!e.outputConnection)return f(m.type);const i=e.outputConnection.check_&&e.outputConnection.check_.length?e.outputConnection.check_[0]:"T";if("Array"===i){if(e.outputConnection.check_.length>1)return f(e.outputConnection.check_[1]);let i;if("lists_create_with"==e.type){if(e.inputList&&e.inputList.length)for(const o of e.inputList)if(o.connection&&o.connection.targetBlock()){let e=a(g(t,o.connection.targetBlock()));if(e){if(e.parentType)return e.parentType;i=e.type?f(e.type+"[]"):u(null),C(i,e);break}}}else"argument_reporter_array"==e.type&&(i||(i=f("any[]")));return i&&(i.isArrayType=!0),i||u(null,!0)}if("T"===i){const i=t.stdCallTable[e.type],o="lists_index_get"===e.type;if(o||i&&i.comp.thisParameter){let s;if(s=o?e.inputList.find((t=>"LIST"===t.name)):e.inputList.find((t=>t.name===i.comp.thisParameter.definitionName)),s.connection&&s.connection.targetBlock()){const e=g(t,s.connection.targetBlock());if(e.childType)return e.childType;const i=b(e.type)&&"Array"!==e.type?u(e.type.substr(0,e.type.length-2)):u(null);return C(e,i),i}}return u(null)}return f(i)}function k(e,i){if(!e.userFunctionReturnValues[i]){const o=Blockly.Functions.getDefinition(i,e.workspace);let s=u("void");if(kt(o,!0))s=u("any");else{const l=[];for(const t of o.getDescendants(!1))"function_return"===t.type&&(y(e,t,"RETURN_VALUE"),l.push(g(e,T(t,"RETURN_VALUE"))));if(l.length)try{const t=u(null);for(const e of l)c(t,e);s=t}catch(l){e.diagnostics.push({blockId:o.id,message:t.Util.lf("Function '{0}' has an invalid return type",i)}),s=u("any")}}e.userFunctionReturnValues[i]=s}return e.userFunctionReturnValues[i]}function b(t){return t&&(-1!==t.indexOf("[]")||"Array"==t)}function y(t,e,i,s){const l=e.getInputTargetBlock(i);l?l.type!==pxtc.TS_OUTPUT_TYPE||l.p||(l.p=u(null)):(o[e.id]||(o[e.id]={}),o[e.id][i]||(o[e.id][i]=function(t,e,i){return{type:"placeholder",p:u(i||null),workspace:t.workspace,parentBlock_:e}}(t,e,s)))}function _(t){return"pxt_controls_for"==t.type||"pxt_controls_for_of"==t.type?T(t,"VAR"):t}function T(t,e){const i=t.getInputTargetBlock(e);return i||o[t.id]&&o[t.id][e]}function x(){o={}}function E(t,e,i,o){y(t,e,i);try{c(g(t,T(e,i)),o)}catch(t){}}function B(t,e,i){function o(t){return t.name?t.connection&&t.connection.check_&&t.connection.check_.length?t.connection.check_[0]:"T":void 0}function s(t,i){let s=t.inputList.filter((t=>"T"===o(t)));if(s.length){const o=T(t,s[0].name);if(o){const s=g(e,o),l=s.type?f(g(e,o).type+"[]"):f(null);return C(l,s),E(e,t,i,l),!0}}return!1}t&&t.filter((t=>t.isEnabled())).forEach((t=>{try{switch(t.type){case"math_op2":E(e,t,"x",f(d.type)),E(e,t,"y",f(d.type));break;case"math_op3":E(e,t,"x",f(d.type));break;case"math_arithmetic":case"logic_compare":switch(t.getFieldValue("OP")){case"ADD":case"MINUS":case"MULTIPLY":case"DIVIDE":case"LT":case"LTE":case"GT":case"GTE":case"POWER":E(e,t,"A",f(d.type)),E(e,t,"B",f(d.type));break;case"AND":case"OR":y(e,t,"A",p.type),y(e,t,"B",p.type);break;case"EQ":case"NEQ":y(e,t,"A"),y(e,t,"B");let i=g(e,T(t,"A")),o=g(e,T(t,"B"));try{c(i,o)}catch(t){}}break;case"logic_operation":y(e,t,"A",p.type),y(e,t,"B",p.type);break;case"logic_negate":y(e,t,"BOOL",p.type);break;case"controls_if":for(let i=0;i<=t.elseifCount_;++i)y(e,t,"IF"+i,p.type);break;case"pxt_controls_for":case"controls_simple_for":E(e,t,"TO",f(d.type));break;case"pxt_controls_for_of":case"controls_for_of":const i=g(e,T(t,"LIST"));C(i,F(e,t,_(t).getField("VAR").getText()).type);break;case"variables_set":case"variables_change":let l=F(e,t,t.getField("VAR").getText()).type;y(e,t,"VALUE");let n=T(t,"VALUE");if(n){let t=function(t,e){var i,o;return(null===(o=null===(i=e.outputConnection)||void 0===i?void 0:i.check_)||void 0===o?void 0:o.length)&&"Array"!==e.outputConnection.check_[0]&&"T"!==e.outputConnection.check_[0]?e.outputConnection.check_.map((t=>f(t))):[g(t,e)]}(e,n);const i=a(l);if(i.type&&t.slice(1).some((t=>t.type===i.type)))l.link=a(t[0]);else try{c(l,t[0])}catch(t){}}break;case"controls_repeat_ext":E(e,t,"TIMES",f(d.type));break;case"device_while":y(e,t,"COND",p.type);break;case"lists_index_get":E(e,t,"LIST",f("Array")),E(e,t,"INDEX",f(d.type));const r=g(e,T(t,"LIST"));C(r,g(e,t));break;case"lists_index_set":E(e,t,"LIST",f("Array")),y(e,t,"VALUE"),s(t,"LIST"),E(e,t,"INDEX",f(d.type));break;case"function_definition":k(e,t.getField("function_name").getText());break;case"function_call":case"function_call_output":t.getArguments().forEach((i=>{E(e,t,i.id,f(i.type))}));break;case pxtc.TS_RETURN_STATEMENT_TYPE:y(e,t,"RETURN_VALUE");break;case pxtc.PAUSE_UNTIL_TYPE:E(e,t,"PREDICATE",p);break;default:if(t.type in e.stdCallTable){const i=e.stdCallTable[t.type];if("ENUM_GET"===i.attrs.shim||"KIND_GET"===i.attrs.shim)return;lt(i,st(t)).forEach(((l,n)=>{const r=i.isExtensionMethod&&0===n;if(l.definitionName&&!t.getFieldValue(l.definitionName)){let i=t.inputList.find((t=>t.name==l.definitionName));if(i&&i.connection&&i.connection.check_){if(r&&"Array"===o(i)){if(s(t,l.definitionName))return}for(let o=0;o<i.connection.check_.length;o++)try{let s=i.connection.check_[o];E(e,t,l.definitionName,f(s));break}catch(t){}}}}))}}}catch(i){const o=i.block||t;o.setWarningText(i+""),e.errors.push(o)}})),e.allVariables.forEach((t=>{null==A(t.type).type&&c(t.type,f(t.type.isArrayType?"number[]":d.type))}))}function C(t,e){const i=a(t),o=a(e);i.childType?c(i.childType,o):i.type||(i.childType=o),o.parentType?c(o.parentType,i):o.type||(o.parentType=i),b(i.type)&&(i.isArrayType=!0)}function A(t,e=[]){const i=a(t);if(-1===e.indexOf(i)&&(e.push(i),!i.type||"Array"===i.type)){if(i.parentType){const t=A(i.parentType,e);if(t.type&&"Array"!==t.type)return b(t.type)?i.type=t.type.substr(0,t.type.length-2):i.type=t.type,i}if(i.childType){const t=A(i.childType,e);if(t.type)return i.type=t.type+"[]",i}}return i}function v(t){let e=t.getFieldValue("math_number_minmax"===t.type?"SLIDER":"NUM");const i=parseFloat(e);return function(t,e){isFinite(t)&&!isNaN(t)||function(t,e){let i=new Error(t);throw i.block=e,i}(lf("Number entered is either too large or too small"),e)}(i,t),i}function I(t,i,o){return e.H.mkNumberLiteral(v(i))}let N={ADD:"+",MINUS:"-",MULTIPLY:"*",DIVIDE:"/",LT:"<",LTE:"<=",GT:">",GTE:">=",AND:"&&",OR:"||",EQ:"==",NEQ:"!=",POWER:"**"};function w(t,i,o){const s=M(i.getFieldValue("NAME"),t,!0);return e.mkStmt(e.mkText(s+"()"))}function S(t,i,o,s){const l=M(i.getField("function_name").getText(),t,!0),n=!i.getInputsInline(),r=i.getArguments().map((t=>({actualName:t.name,definitionName:t.id}))).map((e=>H(t,i,e,o))),a=e.H.stdCall(l,r,n);return s?e.mkStmt(a):a}function D(t,i,o){const s=T(i,"RETURN_VALUE");return s&&"placeholder"!=s.type?e.mkStmt(e.mkText("return "),R(t,s,o)):e.mkStmt(e.mkText("return"))}function L(t){const i=t.getContent();return e.Helpers.mkMultiComment(i.trim())}function O(t){if(null==t.type&&(c(t,f(d.type)),t=a(t)),b(t.type)||t.isArrayType)return e.mkText("[]");switch(t.type){case"boolean":return e.H.mkBooleanLiteral(!1);case"number":return e.H.mkNumberLiteral(0);case"string":return e.H.mkStringLiteral("");default:return e.mkText("null")}}function R(i,o,s){let n;if(l(null!=o),i.stats[o.type]=(i.stats[o.type]||0)+1,it(o,s),"placeholder"!=o.type&&o.isEnabled&&o.isEnabled())switch(o.type){case"math_number":case"math_integer":case"math_whole_number":case"math_number_minmax":n=I(0,o);break;case"math_op2":n=function(t,i,o){let s=i.getFieldValue("op"),l=R(t,T(i,"x"),o),n=R(t,T(i,"y"),o);return e.H.mathCall(s,[l,n])}(i,o,s);break;case"math_op3":n=function(t,i,o){let s=R(t,T(i,"x"),o);return e.H.mathCall("abs",[s])}(i,o,s);break;case"math_arithmetic":case"logic_compare":case"logic_operation":n=function(t,i,o){let s=i.getFieldValue("OP"),n=T(i,"A"),r=T(i,"B"),a=[R(t,n,o),R(t,r,o)],c=g(t,n).type;if(c==h.type){if("EQ"==s)return e.H.mkSimpleCall("==",a);if("NEQ"==s)return e.H.mkSimpleCall("!=",a)}else if(c==p.type)return e.H.mkSimpleCall(N[s],a);return l(s in N),e.H.mkSimpleCall(N[s],a)}(i,o,s);break;case"math_modulo":n=function(t,i,o){let s=T(i,"DIVIDEND"),l=T(i,"DIVISOR"),n=[R(t,s,o),R(t,l,o)];return e.H.mkSimpleCall("%",n)}(i,o,s);break;case"logic_boolean":n=function(t,i,o){return e.H.mkBooleanLiteral("TRUE"==i.getFieldValue("BOOL"))}(0,o);break;case"logic_negate":n=function(t,i,o){let s=R(t,T(i,"BOOL"),o);return e.mkPrefix("!",[e.H.mkParenthesizedExpression(s)])}(i,o,s);break;case"variables_get":n=function(t,i){const o=i.getField("VAR").getText();let s=F(t,i,o);if(!s)return e.mkText(o);s.firstReference||(s.firstReference=i);return l(null!=s&&null!=s.type),e.mkText(s.escapedName)}(i,o);break;case"text":n=function(t,i,o){return e.H.mkStringLiteral(i.getFieldValue("TEXT"))}(0,o);break;case"text_join":n=function(t,i,o){let s,l=0;for(;;){const n=T(i,"ADD"+l);if(l++,!n){if(l<i.inputList.length)continue;break}const r=R(t,n,o);s=s?e.H.mkSimpleCall("+",[s,r]):0===n.type.indexOf("text")?r:e.H.mkSimpleCall("+",[e.H.mkStringLiteral(""),r])}return s||e.H.mkStringLiteral("")}(i,o,s);break;case"lists_create_with":n=function(t,i,o){let s=i.inputList.map((e=>e.connection&&e.connection.targetBlock()?R(t,e.connection.targetBlock(),o):void 0)).filter((t=>!!t));return e.H.mkArrayLiteral(s,!i.getInputsInline())}(i,o,s);break;case"lists_index_get":n=function(t,i,o){const s=R(t,T(i,"LIST"),o),l=R(t,T(i,"INDEX"),o);return e.mkGroup([s,e.mkText("["),l,e.mkText("]")])}(i,o,s);break;case"lists_index_set":n=function(t,i,o){const s=T(i,"LIST"),l=R(t,s,o),n=R(t,T(i,"INDEX"),o),r=R(t,T(i,"VALUE"),o),a=e.mkGroup([l,e.mkText("["),n,e.mkText("] = "),r]);return"lists_create_with"===s.type?K(a):a}(i,o,s);break;case"math_js_op":case"math_js_round":n=function(t,i,o){const s=i.getFieldValue("OP"),l=[R(t,T(i,"ARG0"),o)];return i.getInput("ARG1")&&l.push(R(t,T(i,"ARG1"),o)),e.H.mathCall(s,l)}(i,o,s);break;case pxtc.TS_OUTPUT_TYPE:n=function(t,i,o){return e.mkText(i.getFieldValue("EXPRESSION").trim())}(0,o);break;case"argument_reporter_boolean":case"argument_reporter_number":case"argument_reporter_string":case"argument_reporter_array":case"argument_reporter_custom":n=function(t,i,o){const s=M(i.getFieldValue("VALUE"),t);return e.mkText(s)}(i,o);break;case"function_call_output":n=S(i,o,s,!1);break;default:let r=i.stdCallTable[o.type];r?n=r.imageLiteral?j(i,o,r.imageLiteral,r.imageLiteralColumns,r.imageLiteralRows,r.namespace,r.f,lt(r,st(o)).map((t=>H(i,o,t,s)))):G(i,o,r,s):(t.reportError("blocks","unable to compile expression",{details:o.type}),n=O(g(i,o)))}else{if("Array"===a(g(i,o)).type){let t="lists_index_get"===o.parentBlock_.type;if(!t){const e=i.stdCallTable[o.parentBlock_.type];t=e&&e.isExpression}const s=e.mkText("[0]");n=t?s:K(s)}else n=O(g(i,o))}return n.id=o.id,n}function F(t,e,i){return dt(i,t.idToScope[e.id])}function M(t,e,i=!1){if(!t)return"_";if(i){if(e.renames.oldToNewFunctions[t])return e.renames.oldToNewFunctions[t]}else if(e.renames.oldToNew[t])return e.renames.oldToNew[t];let o=ts.pxtc.escapeIdentifier(t);if(e.renames.takenNames[o]){let t=2;for(;e.renames.takenNames[o+t];)t++;o+=t}return i?(e.renames.oldToNewFunctions[t]=o,e.renames.takenNames[o]=!0):e.renames.oldToNew[t]=o,o}function P(t,i,o){let s=T(i,"VALUE"),l=F(t,i,i.getField("VAR").getText());let n=t.idToScope[i.id].declaredVars[l.name]===l&&!l.firstReference&&!l.alreadyDeclared;n&&pt(i,(e=>{if("variables_get"===e.type){F(t,e,e.getField("VAR").getText())===l&&(n=!1)}}),!0);let a=R(t,s,o),c=l.escapedName+" = ";if(l.isAssigned=!0,n){l.alreadyDeclared=r.Assigned;const e=A(l.type);if(c=`let ${l.escapedName} = `,e){const i=A(g(t,s));e.type!==i.type&&(c=`let ${l.escapedName}: ${e.type} = `)}}else l.firstReference||(l.firstReference=i);return e.mkStmt(e.mkText(c),a)}function U(t,i,o){let s=T(i,"VALUE"),l=F(t,i,i.getField("VAR").getText()),n=R(t,s,o),r=e.mkText(l.escapedName);return e.mkStmt(e.mkInfix(r,"+=",n))}function V(i,o,s){const l=i.stdCallTable[o.type];return l.imageLiteral?e.mkStmt(j(i,o,l.imageLiteral,l.imageLiteralColumns,l.imageLiteralRows,l.namespace,l.f,lt(l,st(o)).map((t=>H(i,o,t,s))))):l.hasHandler?function(i,o,s,l,n,r){const a=l.map((t=>H(i,o,t,r))),c=T(o,"HANDLER"),u=Y(i,c);t.appTarget.compile&&t.appTarget.compile.emptyEventHandlerComments&&0===u.children.length&&u.children.unshift(e.mkStmt(e.mkText(`// ${pxtc.HANDLER_COMMENT}`)));let d;if($(o)&&o.mutation.getMutationType()===e.MutatorTypes.ObjectDestructuringMutator)d=o.mutation.compileMutation(i,r);else if(s.comp.handlerArgs.length){let t=function(t,e,i){return nt(t,e).map((e=>F(i,t,e[0]).escapedName))}(o,s,i);d=e.mkText(`function (${t.join(", ")})`)}return W(i,n,s.f,a,u,d,s.isExtensionMethod)}(i,o,l,function(t,e){return lt(t,st(e)).filter((t=>!!t.definitionName))}(l,o),l.namespace,s):e.mkStmt(G(i,o,l,s))}function H(i,o,s,l,n=!1){let r=o.getFieldValue(s.definitionName);if(null!=r){const l=o.getField(s.definitionName);if(l instanceof pxtblockly.FieldTextInput)return e.H.mkStringLiteral(r);if(l instanceof pxtblockly.FieldTilemap&&!l.isGreyBlock){const o=t.react.getTilemapProject(),s=l.getValue();if(s.startsWith("tilemap`"))return e.mkText(s);if(i.options.emitTilemapLiterals)try{const i=t.sprite.decodeTilemap(s,"typescript",o);if(i){const[t]=o.createNewTilemapFromData(i);return e.mkText(`tilemap\`${t}\``)}}catch(i){}}const n=i.blocksInfo.apis.byQName[s.type];if(n&&n.attributes.emitAsConstant)for(const t of Object.keys(i.blocksInfo.apis.byQName)){const o=i.blocksInfo.apis.byQName[t];if(o&&o.attributes&&o.attributes.enumIdentity===r)return e.mkText(t)}let a=e.mkText(r);return a.canIndentInside="string"==typeof r&&r.indexOf("\n")>=0,a}{y(i,o,s.definitionName);const t=T(o,s.definitionName);return n&&"lists_create_with"===t.type?K(R(i,t,l)):s.shadowOptions&&s.shadowOptions.toString&&g(i,t)!==h?e.H.mkSimpleCall("+",[e.H.mkStringLiteral(""),e.H.mkParenthesizedExpression(R(i,t,l))]):R(i,t,l)}}function G(t,i,o,s){let l;if($(i)&&i.mutation.getMutationType()===e.MutatorTypes.RestParameterMutator)l=i.mutation.compileMutation(t,s).children;else{if("ENUM_GET"===o.attrs.shim){const t=o.attrs.enumName,s=i.getFieldValue("MEMBER").replace(/^\d+/,"");return e.H.mkPropertyAccess(s,e.mkText(t))}if("KIND_GET"===o.attrs.shim){const s=t.kinds.filter((t=>t.blockId===o.attrs.blockId))[0];return e.H.mkPropertyAccess(i.getFieldValue("MEMBER"),e.mkText(s.name))}l=lt(o,st(i)).map(((e,l)=>H(t,i,e,s,o.isExtensionMethod&&0===l&&!o.isExpression)))}let n=o.namespace,r=o.f;if(o.attrs.blockAliasFor){const e=t.blocksInfo.apis.byQName[o.attrs.blockAliasFor];e&&(r=e.name,n=e.namespace)}const a=!i.getInputsInline();if(o.isIdentity)return l[0];if(o.property)return e.H.mkPropertyAccess(r,l[0]);if("@get@"==r)return e.H.mkPropertyAccess(l[1].op.replace(/.*\./,""),l[0]);if("@set@"==r)return e.H.mkAssign(e.H.mkPropertyAccess(l[1].op.replace(/.*\./,"").replace(/@set/,""),l[0]),l[2]);if("@change@"==r)return e.H.mkSimpleCall("+=",[e.H.mkPropertyAccess(l[1].op.replace(/.*\./,"").replace(/@set/,""),l[0]),l[2]]);if(o.isExtensionMethod){if(o.attrs.defaultInstance){let n;$(i)&&i.mutation.getMutationType()===e.MutatorTypes.DefaultInstanceMutator&&(n=i.mutation.compileMutation(t,s)),n?l.unshift(n):l.unshift(e.mkText(o.attrs.defaultInstance))}return e.H.extensionCall(r,l,a)}return n?e.H.namespaceCall(n,r,l,a):e.H.stdCall(r,l,a)}function W(t,i,o,s,l,n,r=!1){let a;return l.noFinalNewline=!0,a=n?e.mkGroup([n,l]):e.mkGroup([e.mkText("function ()"),l]),r?e.mkStmt(e.H.extensionCall(o,s.concat([a]),!1)):i?e.mkStmt(e.H.namespaceCall(i,o,s.concat([a]),!1)):e.mkStmt(e.H.mkCall(o,s.concat([a]),!1))}function $(t){return!!t.mutation}function j(t,i,o,s,l,n,r,a){a=void 0===a?[]:a;let c="\n";l=l||5,s=(s||5)*o;let u=i.getFieldValue("LEDS");u=u.replace(/[ `\n]+/g,"");for(let t=0;t<l;++t){for(let e=0;e<s;++e)e>0&&(c+=" "),c+="#"===u[t*s+e]?"#":".";c+="\n"}let d=e.H.mkStringLiteral(c);return d.canIndentInside=!0,e.H.namespaceCall(n,r,[d].concat(a),!1)}function X(i,o){let l;const n=[];switch(i.stats[o.type]=(i.stats[o.type]||0)+1,it(o,n),o.type){case"controls_if":l=function(t,i,o){let l=[];for(let n=0;n<=i.elseifCount_;++n){let r=R(t,T(i,"IF"+n),o),a=Y(t,T(i,"DO"+n)),c=e.mkText("if (");n>0&&(c=e.mkText("else if ("),c.glueToBlock=e.GlueMode.WithSpace),s(l,[c,r,e.mkText(")"),a])}if(i.elseCount_){let o=e.mkText("else");o.glueToBlock=e.GlueMode.WithSpace,s(l,[o,Y(t,T(i,"ELSE"))])}return l}(i,o,n);break;case"pxt_controls_for":case"controls_for":case"controls_simple_for":l=function(t,i,o){let s=T(i,"TO"),l=T(i,"DO"),n=T(i,"BY"),r=T(i,"FROM"),a=!n||n.type.match(/^math_number/)&&1==v(n),c=F(t,i,_(i).getField("VAR").getText());return[e.mkText("for (let "+c.escapedName+" = "),r?R(t,r,o):e.mkText("0"),e.mkText("; "),e.mkInfix(e.mkText(c.escapedName),"<=",R(t,s,o)),e.mkText("; "),a?e.mkText(c.escapedName+"++"):e.mkInfix(e.mkText(c.escapedName),"+=",R(t,n,o)),e.mkText(")"),Y(t,l)]}(i,o,n);break;case"pxt_controls_for_of":case"controls_for_of":l=function(t,i,o){let s=T(i,"LIST"),l=T(i,"DO"),n=F(t,i,_(i).getField("VAR").getText());return[e.mkText("for (let "+n.escapedName+" of "),R(t,s,o),e.mkText(")"),Y(t,l)]}(i,o,n);break;case"variables_set":l=[P(i,o,n)];break;case"variables_change":l=[U(i,o,n)];break;case"controls_repeat_ext":l=function(t,i,o){let s=R(t,T(i,"TIMES"),o),l=Y(t,T(i,"DO")),n="index";for(let e=2;F(t,i,n);e++)n="index"+e;return[e.mkText("for (let "+n+" = 0; "),e.mkInfix(e.mkText(n),"<",s),e.mkText("; "+n+"++)"),l]}(i,o,n);break;case"device_while":l=function(t,i,o){let s=R(t,T(i,"COND"),o),l=Y(t,T(i,"DO"));return[e.mkText("while ("),s,e.mkText(")"),l]}(i,o,n);break;case"procedures_defnoreturn":l=function(t,i,o){const s=M(i.getFieldValue("NAME"),t,!0),l=T(i,"STACK");return[e.mkText("function "+s+"() "),Y(t,l)]}(i,o);break;case"function_definition":l=function(t,i,o){const s=M(i.getField("function_name").getText(),t,!0),l=T(i,"STACK"),n=i.getArguments().map((e=>"Array"==e.type?`${M(e.name,t)}: any[]`:`${M(e.name,t)}: ${e.type}`)),r=kt(i,!1);return[e.mkText(`function ${s} (${n.join(", ")})${r?": any":""}`),Y(t,l)]}(i,o);break;case"procedures_callnoreturn":l=[w(i,o)];break;case"function_call":l=[S(i,o,n,!0)];break;case pxtc.TS_RETURN_STATEMENT_TYPE:l=[D(i,o,n)];break;case ts.pxtc.ON_START_TYPE:l=function(i,o){const s=Y(i,T(o,"HANDLER"));return t.appTarget.compile&&t.appTarget.compile.onStartText&&s&&s.children&&s.children.unshift(e.mkStmt(e.mkText(`// ${pxtc.ON_START_COMMENT}\n`))),s}(i,o).children;break;case pxtc.TS_STATEMENT_TYPE:l=function(t,i){return i.getLines().map((t=>e.mkText(t+"\n")))}(0,o);break;case pxtc.PAUSE_UNTIL_TYPE:l=function(i,o,s){const l=t.appTarget.runtime&&t.appTarget.runtime.pauseUntilBlock;t.Util.assert(!!l,"target has block enabled");const n=l.namespace,r=l.callName||"pauseUntil",a=H(i,o,{definitionName:"PREDICATE",actualName:"PREDICATE"},s),c=[e.mkGroup([e.mkText("() => "),a])];return n?[e.mkStmt(e.H.namespaceCall(n,r,c,!1))]:[e.mkStmt(e.H.mkCall(r,c,!1,!1))]}(i,o,n);break;case pxtc.TS_DEBUGGER_TYPE:l=function(t,i){if("1"==i.getFieldValue("ON_OFF"))return[e.mkText("debugger;\n")];return[]}(0,o);break;case pxtc.TS_BREAK_TYPE:l=[e.mkText("break;\n")];break;case pxtc.TS_CONTINUE_TYPE:l=[e.mkText("continue;\n")];break;default:l=i.stdCallTable[o.type]?[V(i,o,n)]:[e.mkStmt(R(i,o,n))]}let r=l[l.length-1];return r&&!r.id&&(r.id=o.id),n.length&&function(t,i){const o=[];for(const i of t)for(const t of i.split("\n"))o.push(e.mkText(`// ${t}`)),o.push(e.mkNewLine());for(const t of o.reverse())i.unshift(t)}(n,l),l.forEach((i=>{!(i.type===e.NT.Block||i.type===e.NT.Prefix&&t.Util.startsWith(i.op,"//"))||o.type==pxtc.ON_START_TYPE&&i.id||(i.id=o.id)})),l}function Y(t,i){let o=[],l=i;for(;i;)i.isEnabled()&&s(o,X(t,i)),i=i.getNextBlock();return l&&t.blockDeclarations[l.id]&&t.blockDeclarations[l.id].filter((t=>!t.alreadyDeclared)).forEach((e=>{o.unshift(ot(e,t.blocksInfo)),e.alreadyDeclared=r.Implicit})),e.mkBlock(o)}function K(t){const i=e.mkStmt(e.mkText(";"));return i.glueToBlock=e.GlueMode.NoSpace,e.mkGroup([i,t])}function q(e,i,o={}){let s=function(t,e){return{workspace:t,options:e,stdCallTable:{},userFunctionReturnValues:{},diagnostics:[],errors:[],renames:{oldToNew:{},takenNames:{},oldToNewFunctions:{}},stats:{},enums:[],kinds:[],idToScope:{},blockDeclarations:{},allVariables:[],blocksInfo:null}}(e,o);return s.blocksInfo=i,i&&(Object.keys(i.apis.byQName).forEach((t=>{const e=i.apis.byQName[t];!e.pkg||6!==e.kind&&3!==e.kind&&5!==e.kind&&4!==e.kind||(s.renames.takenNames[e.qName]=!0)})),i.enumsByName&&Object.keys(i.enumsByName).forEach((t=>s.enums.push(i.enumsByName[t]))),i.kindsByName&&Object.keys(i.kindsByName).forEach((t=>s.kinds.push(i.kindsByName[t]))),i.blocks.forEach((e=>{if(s.stdCallTable[e.attributes.blockId])return void t.reportError("blocks","function already defined",{details:e.attributes.blockId,qualifiedName:e.qName,packageName:e.pkg});s.renames.takenNames[e.namespace]=!0;const i=t.blocks.compileInfo(e),o=!!i.thisParameter;s.stdCallTable[e.attributes.blockId]={namespace:e.namespace,f:e.name,comp:i,attrs:e.attributes,isExtensionMethod:o,isExpression:e.retType&&"void"!==e.retType,imageLiteral:e.attributes.imageLiteral,imageLiteralColumns:e.attributes.imageLiteralColumns,imageLiteralRows:e.attributes.imageLiteralRows,hasHandler:t.blocks.hasHandler(e),property:!e.parameters,isIdentity:"TD_ID"==e.attributes.shim}})),e.getTopBlocks(!1).filter(ft).forEach((t=>{M("procedures_defnoreturn"===t.type?t.getFieldValue("NAME"):t.getField("function_name").getText(),s,!0)}))),s}function z(t,e){if(t.type===ts.pxtc.ON_START_TYPE)return 0;const i=e.stdCallTable[t.type],o=J(e,t),s=1+ts.pxtc.Util.codalHash16(o);return i&&i.attrs.afterOnStart?s:-s}function Q(i,o,l){try{let n=o.getAllBlocks(!1);t.react.getTilemapProject&&t.react.getTilemapProject().removeInactiveBlockAssets(n.map((t=>t.id)));let a=o.getTopBlocks(!0);a=a.sort(((t,e)=>z(t,i)-z(e,i))),function(t,e,i){e.forEach((t=>t.setEnabled(!0)));const o={};function s(t,e){o[t]?tt(e,!1):(tt(e,!0),o[t]=e)}i.forEach((e=>{const i=t.stdCallTable[e.type];if(e.type==ts.pxtc.ON_START_TYPE)s(ts.pxtc.ON_START_TYPE,e);else{if(ft(e)||i&&i.attrs.blockAllowMultiple&&!i.attrs.handlerStatement)return;if(i&&i.hasHandler&&!i.attrs.handlerStatement){s(i.attrs.blockHandlerKey||J(t,e),e)}else{let t=e;for(;t;)tt(e,!1),t=t.getNextBlock()}}}))}(i,n,a),n=n.filter((t=>t.isEnabled())),a=a.filter((t=>t.isEnabled())),function(t,e){let i,o=1;t.forEach((t=>{if(t.type===ts.pxtc.ON_START_TYPE){const o=t.getInputTargetBlock("HANDLER");o&&(i={firstStatement:o,declaredVars:{},referencedVars:[],children:[],assignedVars:[]},s(o,i,e))}})),i||(i={firstStatement:null,declaredVars:{},referencedVars:[],children:[],assignedVars:[]});return t.forEach((t=>{t.type!==ts.pxtc.ON_START_TYPE&&s(t,i,e)})),Object.keys(i.declaredVars).forEach((t=>{const e=i.declaredVars[t];delete i.declaredVars[t];(ut(i,e.id)||i).declaredVars[t]=e})),ht(i,e),ct(i,e),i;function s(t,e,i){if(i.idToScope[t.id]=e,"variables_get"===t.type){const i=l(t.getField("VAR").getText(),e);e.referencedVars.push(i.id)}else if("variables_set"===t.type||"variables_change"===t.type){const i=l(t.getField("VAR").getText(),e);e.assignedVars.push(i.id),e.referencedVars.push(i.id)}else if(t.type===pxtc.TS_STATEMENT_TYPE){const i=t.declaredVariables;if(i){i.split(",").forEach((t=>{l(t,e).alreadyDeclared=r.Argument}))}}if(function(t){return t.inputList.some((t=>t.type===Blockly.NEXT_STATEMENT))}(t)){const l=function(t,e){switch(t.type){case"pxt_controls_for":case"controls_simple_for":return[[_(t).getField("VAR").getText(),d]];case"pxt_controls_for_of":case"controls_for_of":return[[_(t).getField("VAR").getText(),u(null)]]}if($(t)){const e=t.mutation.getDeclaredVariables();if(e)return Object.keys(e).map((t=>[t,u(e[t])]))}let i=e.stdCallTable[t.type];if(i&&i.comp.handlerArgs.length)return nt(t,i);return[]}(t,i).map((t=>({name:t[0],type:t[1],id:o++})));let n=e;l.length&&(n={parent:e,firstStatement:t,declaredVars:{},referencedVars:[],assignedVars:[],children:[]},l.forEach((t=>{t.alreadyDeclared=r.Assigned,n.declaredVars[t.name]=t})),i.idToScope[t.id]=n),e!==n&&e.children.push(n),pt(t,(t=>{s(t,n,i)})),function(t,e){t.inputList.filter((t=>t.type===Blockly.NEXT_STATEMENT)).forEach((t=>{t.connection&&t.connection.targetBlock()&&e(t.connection.targetBlock())}))}(t,(t=>{const e={parent:n,firstStatement:t,declaredVars:{},referencedVars:[],assignedVars:[],children:[]};n.children.push(e),s(t,e,i)}))}else pt(t,(t=>{s(t,e,i)}));t.nextConnection&&t.nextConnection.targetBlock()&&s(t.nextConnection.targetBlock(),e,i)}function l(t,e){return e.declaredVars[t]?e.declaredVars[t]:e.parent?l(t,e.parent):(e.declaredVars[t]={name:t,type:u(null),id:o++},e.declaredVars[t])}}(a,i),B(n,i);const c=[],p=function(t,e){if(!t.length||t.some((t=>!t.rendered)))return{orphans:e,idToComments:{}};const i=t.map((t=>{const e=t.getBoundingRectangle(),i=t.getHeightWidth();return{id:t.id,x:e.left,y:e.top,width:i.width,height:i.height}})),o={orphans:[],idToComments:{}},s=20;for(const t of e){const e=t.getBoundingRectangle(),l=t.getHeightWidth(),n=e.left,r=e.top;let a;for(const t of i)(mt(n,r,l.width,l.height,t)||!a&&mt(n-s,r-s,l.width+2*s,l.height+2*s,t))&&(a=t);a?(o.idToComments[a.id]||(o.idToComments[a.id]=[]),o.idToComments[a.id].push(t)):o.orphans.push(t)}return o}(a,o.getTopComments(!0));p.orphans.forEach((t=>s(c,L(t).children))),a.forEach((t=>{if(p.idToComments[t.id]&&p.idToComments[t.id].forEach((t=>{s(c,L(t).children)})),t.type==ts.pxtc.ON_START_TYPE)s(c,X(i,t));else{const o=e.mkBlock(X(i,t));o.type==e.NT.Block?s(c,o.children):c.push(o)}}));const h=[];i.enums.forEach((t=>{const i=o.getVariablesOfType(t.name);if(i&&i.length){const o=i.map((t=>{const e=/^(\d+)([^0-9].*)$/.exec(t.name);return e?[e[2],parseInt(e[1])]:[t.name,-1]}));o.sort(((t,e)=>t[1]-e[1]));const s=[];let l=-1;o.forEach((([i,o],n)=>{let r;if(t.isBitMask){const t=Math.log2(o);t>=0&&Math.floor(t)===t&&(r=e.H.mkAssign(e.mkText(i),e.H.mkSimpleCall("<<",[e.H.mkNumberLiteral(1),e.H.mkNumberLiteral(t)])))}else if(t.isHash){const t=ts.pxtc.Util.codalHash16(i.toLowerCase());r=e.H.mkAssign(e.mkText(i),e.H.mkNumberLiteral(t))}r||(r=o===l+1?e.mkText(i):e.H.mkAssign(e.mkText(i),e.H.mkNumberLiteral(o))),s.push(r),l=o}));const n=e.mkCommaSep(s,!0);n.glueToBlock=e.GlueMode.NoSpace,h.push(e.mkGroup([e.mkText(`enum ${t.name}`),e.mkBlock([n])]))}})),i.kinds.forEach((t=>{const i=o.getVariablesOfType("KIND_"+t.name);if(i&&i.length){const o=i.map((t=>t.name)).filter((e=>-1===t.initialMembers.indexOf(e)));o.length&&h.push(e.mkGroup([e.mkText(`namespace ${t.name}`),e.mkBlock(o.map((i=>e.mkStmt(e.mkText(`export const ${i} = ${t.name}.${t.createFunctionName}()`)))))]))}}));const m=i.allVariables.filter((t=>!t.alreadyDeclared)).map((t=>ot(t,l)));return i.allVariables.filter((t=>t.alreadyDeclared===r.Implicit&&!t.isAssigned)).forEach((t=>{const e=A(t.type);"string"===e.type||"number"===e.type||"boolean"===e.type||b(e.type)||i.diagnostics.push({blockId:t.firstReference&&t.firstReference.id,message:lf("Variable '{0}' is never assigned",t.name)})})),[h.concat(m.concat(c)),i.diagnostics]}catch(t){let e=t.block;if(!e)throw t;e.setWarningText(t+""),i.errors.push(e)}finally{x()}return[null,null]}function J(t,e){if(e.type==ts.pxtc.ON_START_TYPE)return JSON.stringify({name:ts.pxtc.ON_START_TYPE});if(e.type==ts.pxtc.FUNCTION_DEFINITION_TYPE)return JSON.stringify({type:"function",name:e.getFieldValue("function_name")});return JSON.stringify(Z(e)).replace(/"id"\s*:\s*"[^"]+"/g,"")}function Z(t){const e=[],i=[];for(const o of t.inputList){for(const t of o.fieldRow)t.name&&e.push(t.getText());o.type===Blockly.INPUT_VALUE&&(o.connection.targetBlock()?i.push(Z(o.connection.targetBlock())):i.push(null))}return{type:t.type,fields:e,inputs:i}}function tt(t,e){t.setEnabled(e);const i=t.getDescendants(!1);for(const t of i)t.setEnabled(e)}function et(t,o,s){let l=e.flattenNode(o);return i("format",{format:{input:l.output,pos:1}}).then((()=>({source:l.output,sourceMap:l.sourceMap,stats:t.stats,diagnostics:s||[]})))}function it(t,e){var i;const o=null===(i=t.getCommentText)||void 0===i?void 0:i.call(t);o&&e.push(o)}function ot(t,i){const o=A(t.type);let s;s="Array"===o.type?e.mkText("[]"):O(o);let l="";if("null"==s.op||"[]"==s.op){let t=o.type;"Array"!==t&&"null[]"!==t||(t="number[]");let n=i.apis.byQName[t];n&&n.attributes.autoCreate?s=e.mkText(n.attributes.autoCreate+"()"):l=": "+t}return e.mkStmt(e.mkText("let "+t.escapedName+l+" = "),s)}function st(t){if(t.mutationToDom){const e=t.mutationToDom();if(e.hasAttribute("_expanded")){const t=parseInt(e.getAttribute("_expanded"));return isNaN(t)?0:Math.max(t,0)}}return 0}function lt({comp:t},e){const i=[];return t.thisParameter&&i.push(t.thisParameter),t.parameters.forEach((t=>{t.isOptional&&e>0?(i.push(t),--e):t.isOptional||i.push(t)})),i}function nt(t,e){let i=[];if(e.attrs.draggableParameters)for(let o=0;o<e.comp.handlerArgs.length;o++){const s=e.comp.handlerArgs[o];let l;const n=T(t,"HANDLER_DRAG_PARAM_"+s.name);if(l="reporter"===e.attrs.draggableParameters?n&&n.getFieldValue("VALUE"):n&&n.getField("VAR").getText(),null===l)break;i.push([l,u(s.type)])}else for(let o=0;o<e.comp.handlerArgs.length;o++){const s=e.comp.handlerArgs[o],l=t.getField("HANDLER_"+s.name),n=l&&l.getText();if(null===n)break;i.push([n,u(s.type)])}return i}function rt(t,e){if(-1!==t.referencedVars.indexOf(e))return!0;for(const i of t.children)if(rt(i,e))return!0;return!1}function at(t,e){if(-1!==t.assignedVars.indexOf(e))return!0;for(const i of t.children)if(at(i,e))return!0;return!1}function ct(t,e){for(const e of Object.keys(t.declaredVars)){const o=t.declaredVars[e];o.escapedName||(o.escapedName=i(e))}function i(i){if(!i)return"_";let s=ts.pxtc.escapeIdentifier(i);if(e.renames.takenNames[s]||o(s,t,i)){let l=2;for(;e.renames.takenNames[s+l]||o(s+l,t,i);)l++;s+=l}return s}function o(t,e,i){if(e){for(const o of Object.keys(e.declaredVars)){const s=e.declaredVars[o];if((i!==s.name||s.name!==s.escapedName)&&s.escapedName===t)return!0}return o(t,e.parent,i)}return!1}t.children.forEach((t=>ct(t,e)))}function ut(t,e){let i;if(-1!==t.referencedVars.indexOf(e))return t;for(const o of t.children)if(rt(o,e)){if(at(o,e))return t;if(i)return t;i=o}return i?ut(i,e):void 0}function dt(t,e){return e&&e.declaredVars[t]?e.declaredVars[t]:e&&e.parent?dt(t,e.parent):null}function pt(t,e,i=!1){t.inputList.filter((t=>t.type===Blockly.INPUT_VALUE)).forEach((t=>{t.connection&&t.connection.targetBlock()&&(e(t.connection.targetBlock()),i&&pt(t.connection.targetBlock(),e,i))}))}function ht(t,e){const i=Object.keys(t.declaredVars);if(i.length){const o=i.map((e=>t.declaredVars[e]));t.firstStatement&&(e.blockDeclarations[t.firstStatement.id]=o.concat(e.blockDeclarations[t.firstStatement.id]||[])),o.forEach((t=>e.allVariables.push(t)))}t.children.forEach((t=>ht(t,e)))}function mt(t,e,i,o,s){const l=r(t,s.x,s.x+s.width)||r(s.x,t,t+i),n=r(e,s.y,s.y+s.height)||r(s.y,e,e+o);return l&&n;function r(t,e,i){return t>=e&&t<=i}}function ft(t){return"procedures_defnoreturn"===t.type||"function_definition"===t.type}function gt(t){return t.getField("function_name").getText()}function kt(t,e){const i=gt(t),o={};return function t(s){let l;l=e?s.getDescendants(!1).filter((t=>"function_return"==t.type)).map((t=>T(t,"RETURN_VALUE"))).filter((t=>t&&"function_call_output"===t.type)):s.getDescendants(!1).filter((t=>"function_call_output"==t.type));for(const e of l){const s=gt(e);if(s===i)return!0;if(!o[s]&&(o[s]=!0,t(Blockly.Functions.getDefinition(s,e.workspace))))return!0}return!1}(t)}e.compileExpression=R,e.escapeVarName=M,e.mkEnv=q,e.compileBlockAsync=function(t,e){const i=t.workspace,o=q(i,e);B(i&&i.getAllBlocks(!1),o);const s=X(o,t);return x(),et(o,s)},e.callKey=J,e.findBlockIdByPosition=function(t,e){if(!e)return;let i,o;for(let s=0;s<t.length;++s){let l=t[s];l.startPos<=e.start&&l.endPos>=e.start+e.length&&(!i||o>l.endPos-l.startPos)&&(i=l,o=l.endPos-l.startPos)}return i?i.id:void 0},e.findBlockIdByLine=function(t,e){if(!e)return;let i,o;for(let s=0;s<t.length;++s){let l=t[s];l.startLine<=e.start&&l.endLine>e.start+e.length&&(!i||o>l.endLine-l.startLine)&&(i=l,o=l.endLine-l.startLine)}return i?i.id:void 0},e.compileAsync=function(t,e,i={}){const o=q(t,e,i),[s,l]=Q(o,t,e);return et(o,s,l)}}(t.blocks||(t.blocks={}))}(pxt||(pxt={})),function(t){!function(e){let i={};function o(t,e,o){null==i[t]&&(i[t]={field:e,validator:o})}e.initFieldEditors=function(){o("text",pxtblockly.FieldTextInput),o("note",pxtblockly.FieldNote),o("gridpicker",pxtblockly.FieldGridPicker),o("textdropdown",pxtblockly.FieldTextDropdown),o("numberdropdown",pxtblockly.FieldNumberDropdown),o("imagedropdown",pxtblockly.FieldImageDropdown),o("colorwheel",pxtblockly.FieldColorWheel),o("toggle",pxtblockly.FieldToggle),o("toggleonoff",pxtblockly.FieldToggleOnOff),o("toggleyesno",pxtblockly.FieldToggleYesNo),o("toggleupdown",pxtblockly.FieldToggleUpDown),o("toggledownup",pxtblockly.FieldToggleDownUp),o("togglehighlow",pxtblockly.FieldToggleHighLow),o("togglewinlose",pxtblockly.FieldToggleWinLose),o("colornumber",pxtblockly.FieldColorNumber),o("images",pxtblockly.FieldImages),o("sprite",pxtblockly.FieldSpriteEditor),o("animation",pxtblockly.FieldAnimationEditor),o("tilemap",pxtblockly.FieldTilemap),o("tileset",pxtblockly.FieldTileset),o("speed",pxtblockly.FieldSpeed),o("turnratio",pxtblockly.FieldTurnRatio),o("protractor",pxtblockly.FieldProtractor),o("position",pxtblockly.FieldPosition),o("melody",pxtblockly.FieldCustomMelody)},e.registerFieldEditor=o,e.createFieldEditor=function(e,o,s){if(null==i[e])return console.error(`Field editor ${e} not registered`),null;s||(s={}),t.Util.assert(null==s.lightMode,"lightMode is a reserved parameter for custom fields"),s.lightMode=t.options.light;let l=i[e];return new l.field(o,s,l.validator)}}(t.blocks||(t.blocks={}))}(pxt||(pxt={})),function(t){!function(e){e.needsDecompiledDiff=function(t,e){if(!t||!e)return!1;const i={};if(t.replace(/id="([^"]+)"/g,((t,e)=>(i[e]=!0,""))),!Object.keys(i).length)return!1;let o=0,s=0;return e.replace(/id="([^"]+)"/g,((t,e)=>(o++,i[e]&&s++,""))),o>0&&0==s},e.diffXml=function(e,i,s){return o(t.blocks.loadWorkspaceXml(e,!0),t.blocks.loadWorkspaceXml(i,!0),s)};const i="#d0d0d0";function o(o,n,r){try{return Blockly.Events.disable(),function(o,n,r){t.tickEvent("blocks.diff",{started:1}),r=r||{};const a=s();if(!o)return{ws:void 0,message:lf("All blocks are new."),added:0,deleted:0,modified:1};if(!n)return{ws:void 0,message:lf("The current blocks seem corrupted."),added:0,deleted:0,modified:1};const c=t.Util.toDictionary(o.getTopBlocks(!1),(t=>l(t,!0)));n.getTopBlocks(!1).forEach((t=>{const e=l(t,!0),i=o.getBlockById(t.id)||c[e];if(i){e==l(i,!0)&&(a("fast unmodified top ",t.id),t.dispose(!1),i.dispose(!1))}}));const u=o.getAllBlocks(!1).filter((t=>t.isEnabled())),d=o.getTopBlocks(!1).filter((t=>t.isEnabled())),p=n.getAllBlocks(!1).filter((t=>t.isEnabled()));if(a("blocks",p.map((t=>t.toDevString()))),a(p),0==u.length&&0==p.length)return t.tickEvent("blocks.diff",{moves:1}),{ws:void 0,message:lf("Some blocks were moved or changed."),added:0,deleted:0,modified:1};const h=d.filter((t=>!n.getBlockById(t.id))),m=u.filter((t=>!n.getBlockById(t.id))),f=p.filter((t=>!o.getBlockById(t.id))),g=t.blocks.initRenderingWorkspace(),k=t.blocks.saveWorkspaceXml(n,!0);t.blocks.domToWorkspaceNoEvents(Blockly.Xml.textToDom(k),g),g.getAllBlocks(!1).filter((t=>!t.isEnabled())).forEach((t=>{a("disabled ",t.toDevString()),t.dispose(!1)}));const b=t.Util.toDictionary(g.getAllBlocks(!1),(t=>t.id));a("todo blocks",b),w("start"),r.hideDeletedTopBlocks||(h.forEach((t=>{a(`deleted top ${t.toDevString()}`),I(t);const e=A(t);I(e),e.setEnabled(!1)})),w("deleted top"));f.map((t=>g.getBlockById(t.id))).filter((t=>!!t)).forEach((t=>{a(`added ${t.toDevString()}`),I(t)})),w("added");const y={};if(!r.hideDeletedBlocks){const t=m.filter((t=>!(b[t.id]||C(t)||t.outputConnection&&t.outputConnection.isConnected())));t.forEach((t=>{const e=A(t);y[t.id]=e.id,a(`deleted block ${t.toDevString()}->${e.toDevString()}`)})),t.forEach((t=>E(t)))}let _=0;if(t.Util.values(b).filter((t=>S(t))).forEach((t=>{a(`moved ${t.toDevString()}`),delete b[t.id],B(t),_++})),w("moved"),t.Util.values(b).filter((t=>D(t))).forEach((t=>{a(`changed ${t.toDevString()}`),delete b[t.id],B(t),_++})),w("changed"),g.getTopBlocks(!1).forEach((t=>{N(t)||(a(`unmodified top ${t.toDevString()}`),delete b[t.id],t.dispose(!1))})),w("cleaned"),t.Util.values(b).filter((t=>!!g.getBlockById(t.id))).forEach((t=>{L(t)})),w("unmodified"),!g.getAllBlocks(!1).length)return t.tickEvent("blocks.diff",{missed:1}),{ws:g,message:lf("Some blocks were changed."),deleted:m.length,added:f.length,modified:_};g.resize(),Blockly.svgResize(g);const T=t.blocks.renderWorkspace(r.renderOptions||{emPixels:20,layout:e.BlockLayout.Flow,aspectRatio:.5,useViewWidth:!0}),x={ws:g,svg:T,deleted:m.length,added:f.length,modified:_};return t.tickEvent("blocks.diff",{deleted:x.deleted,added:x.added,modified:x.modified}),x;function E(t){a(`stitching ${t.toDevString()}->${y[t.id]}`);const e=g.getBlockById(y[t.id]);e.setEnabled(!1),B(e),I(e);const i=t.getPreviousBlock();if(i){const o=g.getBlockById(y[i.id])||g.getBlockById(i.id);if(a(`previous ${t.id}->${e.toDevString()}: ${o.toDevString()}`),o)if(o.nextConnection)e.previousConnection.connect(o.nextConnection);else{const t=o.inputList.slice().reverse().find((t=>t.connection&&t.connection.type==Blockly.NEXT_STATEMENT));t&&e.previousConnection.connect(t.connection)}}const o=t.getNextBlock();if(o){const i=g.getBlockById(y[o.id])||g.getBlockById(o.id);i&&(a(`next ${t.id}->${e.toDevString()}: ${i.toDevString()}`),e.nextConnection.connect(i.previousConnection))}}function B(t){t.__pxt_used=!0}function C(t){return!!t.__pxt_used}function A(t){const e=Blockly.Xml.blockToDom(t,!1),i=Blockly.Xml.domToBlock(e,g);return i.nextConnection&&i.nextConnection.targetConnection&&i.nextConnection.disconnect(),i.previousConnection&&i.previousConnection.targetConnection&&i.previousConnection.disconnect(),i}function v(t){t.rendered=!1,t.inputList.forEach((e=>e.fieldRow.forEach((e=>{e.init(),e.borderRect_&&(e.borderRect_.setAttribute("fill",t.getColour()),e.borderRect_.setAttribute("stroke",t.getColourTertiary()))}))))}function I(t){t.getDescendants(!1).forEach((t=>{delete b[t.id],B(t)}))}function N(t){return!!t.getDescendants(!1).find((t=>C(t)))}function w(e){a(`${e}:`,t.Util.values(b).map((t=>t.toDevString())))}function S(t){const e=o.getBlockById(t.id);if(!e)return!1;const i=t.getPreviousBlock();if(i&&!b[i.id])return!1;const s=t.getNextBlock();if(s&&!b[s.id])return!1;const l=e.getPreviousBlock();if(!l&&!i)return!1;if(!!l!=!!i||l.id!=i.id)return!0;const n=e.getNextBlock();return!(!n&&!s)&&(!!n!=!!s||n.id!=s.id)}function D(t){let e=o.getBlockById(t.id);if(!e)return!1;const i=l(e),s=l(t);return i!=s&&(a(`old ${e.toDevString()}`,i),a(`new ${t.toDevString()}`,s),!0)}function L(t){t.setColour(i),v(t),r.statementsOnly&&(t.inputList||[]).map((t=>t.type==Blockly.INPUT_VALUE&&t.connection&&t.connection.targetBlock())).filter((t=>!!t)).forEach((t=>L(t)))}}(o,n,r)}catch(e){return t.reportException(e),{ws:void 0,message:lf("Oops, we could not diff those blocks."),error:e,deleted:0,added:0,modified:0}}finally{Blockly.Events.enable()}}function s(){return t.options.debug||window&&/diffdbg=1/.test(window.location.href)?console.log:(t,...e)=>{}}function l(t,e){const i=Blockly.Xml.blockToDom(t,!0);return n(i),r(i,(t=>{n(t),e||("next"==t.localName||"statement"==t.localName||"shadow"==t.localName)&&t.remove()})),Blockly.Xml.domToText(i)}function n(t){t.removeAttribute("id"),t.removeAttribute("x"),t.removeAttribute("y"),t.removeAttribute("deletable"),t.removeAttribute("editable"),t.removeAttribute("movable")}function r(e,i){if(e){i(e);for(const o of t.Util.toArray(e.children))r(o,i)}}e.mergeXml=function(t,e,i){return t==e?i:i==e?t:void 0},e.decompiledDiffAsync=function(e,i,l,n,r={}){const a=s(),c=i.outfiles[t.MAIN_BLOCKS];let u=n.outfiles[t.MAIN_BLOCKS];a(c),a(u);const d=t.diff.compute(e,l,{ignoreWhitespace:!0,full:!0});a(d);const p={};let h=0,m=0;d.forEach(((e,o)=>{const s=e[0],l=e.substr(2);let r=l.length;switch(s){case"-":h+=r+1;break;case"+":m+=r+1;break;default:const o=/^\s+/.exec(l);if(o){const t=o[0].length;h+=t,m+=t,r-=t}const s=t.blocks.findBlockIdByPosition(n.blockSourceMap,{start:m,length:r});if(s&&!p[s]){const o=t.blocks.findBlockIdByPosition(i.blockSourceMap,{start:h,length:r});o&&(a(e),a(`id ${h}:${l.length}>${o} ==> ${m}:${l.length}>${s}`),p[s]=o,u=u.replace(s,o))}h+=r+1,m+=r+1}}));const f=t.blocks.loadWorkspaceXml(c,!0),g=t.blocks.loadWorkspaceXml(u,!0);return r.statementsOnly=!0,o(f,g,r)}}(t.blocks||(t.blocks={}))}(pxt||(pxt={})),function(t){!function(e){function i(t,e){const i=[];for(let o=0;o<t.childNodes.length;o++){const s=t.childNodes.item(o);s.tagName===e&&i.push(s)}return i}function o(t,e){return s(t,"block","type",e).concat(s(t,"shadow","type",e))}function s(e,i,o,s){return t.Util.toArray(e.getElementsByTagName(i)).filter((t=>t.getAttribute(o)===s))}function l(t,e,i,o){const l=s(t,e,i,o);return l.length?l[0]:void 0}function n(t,i,o){var s;let n=o.getAttribute("type"),r=Blockly.Blocks[n],a=e.blockSymbol(n);if(!a||!r)return;let c=e.compileInfo(a);null===(s=a.parameters)||void 0===s||s.forEach(((e,s)=>{let n=t.apis.byQName[e.type];if(n&&6==n.kind){let t=l(o,"field","name",c.actualNameToParam[e.name].definitionName);if(t){let e=i[n.name+"."+t.textContent];e&&(t.textContent=e)}}}))}e.domToWorkspaceNoEvents=function(e,i){t.tickEvent("blocks.domtow");let o=[];try{Blockly.Events.disable(),o=Blockly.Xml.domToWorkspace(e,i),function(t){t.getAllBlocks(!1).filter((t=>!!t.getCommentText())).forEach((e=>{const i=e.getCommentText();if(/@highlight/.test(i)){const o=i.replace(/@highlight/g,"").trim();e.setCommentText(o||null),t.highlightBlock(e.id)}}))}(i)}catch(e){t.reportException(e)}finally{Blockly.Events.enable()}return o},e.clearWithoutEvents=function(e){if(t.tickEvent("blocks.clear"),e)try{Blockly.Events.disable(),e.clear(),e.clearUndo()}finally{Blockly.Events.enable()}},e.saveWorkspaceXml=function(t,e){const i=Blockly.Xml.workspaceToDom(t,!e);return Blockly.Xml.domToText(i)},e.saveBlocksXml=function(t,e){return t.getTopBlocks(!1).map((t=>Blockly.Xml.domToText(Blockly.Xml.blockToDom(t,!e))))},e.getDirectChildren=i,e.getBlocksWithType=o,e.getChildrenWithAttr=s,e.getFirstChildWithAttr=l,e.loadBlocksXml=function(t,e){let i=Blockly.Xml.textToDom(e),o=Blockly.Xml.domToBlock(i,t);if(t.getMetrics){let e=t.getMetrics(),i=o.getHeightWidth();o.moveBy(e.viewLeft+e.viewWidth/2-i.width/2,e.viewTop+e.viewHeight/2-i.height/2)}},e.loadWorkspaceXml=function(e,i=!1){const o=new Blockly.Workspace;try{const i=Blockly.Xml.textToDom(e);return t.blocks.domToWorkspaceNoEvents(i,o),o}catch(e){return i||t.reportException(e),null}},e.importXml=function(l,r,a,c=!1){try{t.blocks.initializeAndInject(a);const c=(new DOMParser).parseFromString(r,"application/xml"),d=t.patching.computePatches(l);d&&(d.filter((t=>"blockId"==t.type)).forEach((e=>Object.keys(e.map).forEach((i=>{o(c,i).forEach((o=>{o.setAttribute("type",e.map[i]),t.debug(`patched block ${i} -> ${e.map[i]}`)}))})))),d.filter((t=>"blockValue"==t.type)).forEach((e=>Object.keys(e.map).forEach((s=>{const l=s.split("."),n=l[0];l[1];o(c,n).reduce(((t,e)=>t.concat(i(e,"value"))),[]).forEach((i=>{i.setAttribute("name",e.map[s]),t.debug(`patched block value ${s} -> ${e.map[s]}`)}))})))),d.filter((t=>"userenum"==t.type)).forEach((e=>Object.keys(e.map).forEach((i=>{s(c,"variable","type",i).forEach((o=>{o.setAttribute("type",e.map[i]),t.debug(`patched enum variable type ${i} -> ${e.map[i]}`)}))})))));const p=i(c.children.item(0),"shadow");for(const t of p){const e=c.createElement("block");t.getAttributeNames().forEach((i=>e.setAttribute(i,t.getAttribute(i))));for(let i=0;i<t.childNodes.length;i++)e.appendChild(t.childNodes.item(i));t.replaceWith(e)}const h={};Object.keys(a.apis.byQName).forEach((t=>{let e=a.apis.byQName[t];7==e.kind&&(h[e.namespace+"."+(e.attributes.blockImportId||e.attributes.block||e.attributes.blockId||e.name)]=e.namespace+"."+e.name)}));const m=c.getElementsByTagName("block");for(let t=0;t<m.length;++t)n(a,h,m[t]);return function(i,s){const l=o(i,ts.pxtc.ON_START_TYPE);let n=l.length?l[0]:void 0;if(n)return void n.removeAttribute("deletable");let r=[];const a=s.blocksById;let c,u=i.firstElementChild;for(;u;){const o=u.nextElementSibling,s=u.getAttribute("type");if(!u.getAttribute("disabled")&&!u.getElementsByTagName("statement").length&&(t.blocks.buildinBlockStatements[s]||a[s]&&"void"==a[s].retType&&!e.hasArrowFunction(a[s])))if(c){const t=i.ownerDocument.createElement("next");t.appendChild(u),c.appendChild(t),u.removeAttribute("x"),u.removeAttribute("y"),c=u}else c=i.ownerDocument.createElement("statement"),c.setAttribute("name","HANDLER"),n||(n=i.ownerDocument.createElement("block"),n.setAttribute("type",ts.pxtc.ON_START_TYPE),r.push(n)),n.appendChild(c),c.appendChild(u),u.removeAttribute("x"),u.removeAttribute("y"),c=u;u=o}r.forEach((t=>i.appendChild(t)))}(c.documentElement,a),u=c.documentElement,t.U.toArray(u.querySelectorAll("block[type=procedures_defnoreturn]")).forEach((t=>{t.setAttribute("type","function_definition"),t.querySelector("field[name=NAME]").setAttribute("name","function_name")})),t.U.toArray(u.querySelectorAll("block[type=procedures_callnoreturn]")).forEach((t=>{t.setAttribute("type","function_call"),t.querySelector("field[name=NAME]").setAttribute("name","function_name")})),t.blocks.extensionBlocklyPatch&&t.blocks.extensionBlocklyPatch(l,c.documentElement),(new XMLSerializer).serializeToString(c)}catch(e){return c||t.reportException(e),r}var u}}(t.blocks||(t.blocks={}))}(pxt||(pxt={})),function(t){var e;(function(i){i.patchBlocksFromOldWorkspace=function(e,i,o){const s=t.blocks.loadWorkspaceXml(o,!0);return function(e,i,o){let s,l;i.getTopBlocks(!1).filter((t=>t.isEnabled())).forEach((n=>{const r=n.xy_;if(r&&0!=r.x&&0!=r.y){s||(s=t.blocks.mkEnv(i,e),l={},o.getTopBlocks(!1).forEach((e=>{const i=t.blocks.callKey(s,e),o=l[i]||[];o.push(e),l[i]=o})));const a=t.blocks.callKey(s,n),c=(l[a]||[]).shift();c&&(c.xy_=r.clone())}}))}(e,i,s),function(e,i){const o=Blockly.Xml.workspaceToDom(e,!0),s=Blockly.Xml.workspaceToDom(i,!0);return t.Util.toArray(o.childNodes).filter((t=>t.nodeType==Node.ELEMENT_NODE&&"block"==t.localName&&"true"==t.getAttribute("disabled"))).forEach((t=>s.appendChild(s.ownerDocument.importNode(t,!0)))),Blockly.Xml.domToText(s)}(i,s)},i.splitSvg=function(e,i,o=18){const s=i.getTopComments(!0),l=i.getTopBlocks(!0);if(s.length+l.length<2)return e;const n=document.createElement("div");function r(i,s,l,r,a,c){const u=e.cloneNode(!0),d=u.querySelector(`g.blocklyWorkspace > g.${i}`),p=u.querySelector(`g.blocklyWorkspace > g.${s}`),h=t.Util.toArray(d.querySelectorAll(`g.blocklyWorkspace > g.${i} > ${c?"."+c:"g[transform]"}`)),m=h.splice(l,1)[0];if(!m)return void t.log("missing block, did block failed to load?");h.filter((t=>t!=m)).forEach((t=>{t.parentNode.removeChild(t)})),d.removeAttribute("transform"),p.parentNode.removeChild(p),m.setAttribute("transform",`translate(${a.x}, ${a.y})`);const f=r.width/o+"em",g=r.height/o+"em";u.setAttribute("viewBox",`0 0 ${r.width} ${r.height}`),u.style.width=f,u.style.height=g,u.setAttribute("width",f),u.setAttribute("height",g),n.appendChild(u)}return n.className=`blocks-svg-list ${i.getInjectionDiv().className}`,s.forEach(((t,e)=>r("blocklyBubbleCanvas","blocklyBlockCanvas",e,t.getHeightWidth(),{x:0,y:0},"blocklyComment"))),l.forEach(((t,e)=>{const i=t.getHeightWidth(),s={x:0,y:0};t.getStartHat()&&(i.height+=o,s.y+=o),r("blocklyBlockCanvas","blocklyBubbleCanvas",e,i,s)})),n},i.verticalAlign=function(t,e){let i=0;t.getTopComments(!0).forEach((t=>{t.moveBy(0,i),i+=t.getHeightWidth().height,i+=e})),t.getTopBlocks(!0).forEach(((t,o)=>{t.getStartHat()&&(i+=e),t.moveBy(0,i),i+=t.getHeightWidth().height,i+=e}))},i.setCollapsedAll=function(t,e){t.getTopBlocks(!1).filter((t=>t.isEnabled())).forEach((t=>t.setCollapsed(e)))};const o=20;function s(e,i,o){let s;o&&(s={target:t.appTarget.id,versions:t.appTarget.versions,xml:t.blocks.saveBlocksXml(e).map((e=>t.Util.htmlEscape(e)))});const l=0|i||4;return r(e,l).then((e=>e?t.BrowserUtils.encodeToPngAsync(e.xml,{width:e.width,height:e.height,pixelDensity:l,text:o?JSON.stringify(s,null,2):null}):Promise.resolve(void 0))).catch((e=>{t.reportException(e)}))}i.flow=function(t,e){if(e){if(e.useViewWidth){const e=t.getMetrics();if(e.viewHeight>e.viewWidth)return f(t.getTopComments(!0),t.getTopBlocks(!0),void 0,e.viewWidth),void t.scroll(o,20)}f(t.getTopComments(!0),t.getTopBlocks(!0),e.ratio)}else f(t.getTopComments(!0),t.getTopBlocks(!0));t.scroll(o,20)},i.screenshotEnabled=function(){return!t.BrowserUtils.isIE()&&!t.BrowserUtils.isUwpEdge()},i.screenshotAsync=function(t,e,i){return s(t,e,i)},i.toPngAsync=s;const l="http://www.w3.org/1999/xlink",n=12e7;function r(t,e){if(!t)return Promise.resolve(void 0);const i=t.getBlocksBoundingBox(),o=t.getParentSvg().cloneNode(!0);u(o);let s=i.right-i.left,l=i.bottom-i.top,r=1;const a=s*l*Math.pow(e,2);return a>n&&(r=Math.sqrt(n/a)),d(o,i.left,i.top,s,l,r)}function a(t){return c((new XMLSerializer).serializeToString(t))}function c(t){return t.replace(new RegExp("&nbsp;","g"),"&#160;")}function u(e){t.BrowserUtils.removeClass(e,"blocklySvg"),t.BrowserUtils.addClass(e,"blocklyPreview pxt-renderer"),t.U.toArray(e.querySelectorAll(".blocklyMainBackground,.blocklyScrollbarBackground")).forEach((t=>{t&&t.parentNode.removeChild(t)})),t.U.toArray(e.querySelectorAll(".blocklyConnectionIndicator,.blocklyInputConnectionIndicator")).forEach((t=>{t&&t.parentNode.removeChild(t)})),e.removeAttribute("width"),e.removeAttribute("height"),t.U.toArray(e.querySelectorAll(".blocklyBlockCanvas,.blocklyBubbleCanvas")).forEach((t=>t.removeAttribute("transform")));const i=new DOMParser;return t.U.toArray(e.querySelectorAll(".blocklyCommentTextarea")).forEach((e=>{const o=i.parseFromString("<!doctype html><body>"+t.docs.html2Quote(e.value),"text/html");e.textContent=o.body.textContent})),e}function d(e,i,o,s,n,r){if(!e.childNodes[0])return Promise.resolve(void 0);e.removeAttribute("width"),e.removeAttribute("height"),e.removeAttribute("transform");let c=Math.round(s*(r||1)),u=Math.round(n*(r||1));const d=a(e).replace(/^\s*<svg[^>]+>/i,"").replace(/<\/svg>\s*$/i,""),f=`<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="${l}" width="${c}" height="${u}" viewBox="${i} ${o} ${s} ${n}" class="pxt-renderer">${d}</svg>`,g=(new DOMParser).parseFromString(f,"image/svg+xml"),k=g.createElementNS("http://www.w3.org/1999/xhtml","style"),b=t.Util.isUserLanguageRtl(),y=document.getElementById(`style-${b?"rtl":""}blockly.css`).href,_=t.Util.toArray(document.head.getElementsByTagName("link")).filter((e=>t.Util.endsWith(e.getAttribute("href"),"semantic.css")))[0].href;return Promise.all([t.BrowserUtils.loadAjaxAsync(y),t.BrowserUtils.loadAjaxAsync(_)]).then((e=>{var i,o;const s=t.Util.toArray(document.head.querySelectorAll("style")).filter((t=>/\.blocklySvg/.test(t.innerText)))[0];e.unshift((null===(i=document.getElementById("blockly-common-style"))||void 0===i?void 0:i.innerText)||""),e.unshift((null===(o=document.getElementById("blockly-renderer-style-pxt"))||void 0===o?void 0:o.innerText)||"");const n=(s?s.innerText:"")+"\n\n"+e.map((t=>t+"\n\n"));return k.appendChild(g.createCDATASection(n)),g.documentElement.insertBefore(k,g.documentElement.firstElementChild),function(e){h||(h={});const i=e.getElementsByTagName("image"),o=t.Util.toArray(i).filter((t=>{const e=t.getAttributeNS(l,"href");return e&&!/^data:/.test(e)})).map((t=>t)).map((e=>{const i=e.getAttributeNS(l,"href");let o=h[i];return(o?Promise.resolve(h[i]):t.BrowserUtils.loadImageAsync(e.getAttributeNS(l,"href")).then((t=>{const e=document.createElement("canvas"),s=e.getContext("2d");let l=t.width,n=t.height;return e.width=l,e.height=n,s.drawImage(t,0,0,l,n,0,0,e.width,e.height),h[i]=o=e.toDataURL("image/png"),o})).catch((e=>(t.debug(`svg render: failed to load ${i}`),"")))).then((t=>{e.setAttributeNS(l,"href",t)}))}));return Promise.all(o).then((()=>{}))}(g).then((()=>function(e){if(m||(m={}),!t.BrowserUtils.isEdge())return Promise.resolve();const i=e.getElementsByTagName("image"),o=t.Util.toArray(i).filter((t=>/^data:image\/svg\+xml/.test(t.getAttributeNS(l,"href")))).map((t=>t)).map((e=>{const i=e.getAttributeNS(l,"href"),o=parseInt(e.getAttribute("width").replace(/[^0-9]/g,"")),s=parseInt(e.getAttribute("height").replace(/[^0-9]/g,""));let n=m[i];return(n?Promise.resolve(n):t.BrowserUtils.encodeToPngAsync(i,{width:o,height:s,pixelDensity:2})).then((t=>{m[i]=t,e.setAttributeNS(l,"href",t)}))}));return Promise.all(o).then((()=>{}))}(g))).then((()=>({width:c,height:u,svg:a(g).replace('<style xmlns="http://www.w3.org/1999/xhtml">',"<style>"),xml:p(g),css:n})))}))}function p(t){const e=(new XMLSerializer).serializeToString(t);return"data:image/svg+xml;base64,"+ts.pxtc.encodeBase64(unescape(encodeURIComponent(e)))}let h,m;function f(t,i,s=1.62,l){const n=[],r={};let a;t.forEach((t=>{const e=t.data;null!=e&&(r[e]=t)})),i.sort(((t,e)=>t.isEnabled()===e.isEnabled()?t.type===e.type?0:"function_definition"===t.type?1:"function_definition"===e.type?-1:t.type.localeCompare(e.type):t.isEnabled()?-1:1)),i.forEach((t=>{const i=e.getBlockData(t).commentRefs;if(i.length){const e=[];for(let t=0;t<i.length;t++){const o=r[i[t]];o&&(e.push(g(o)),delete r[i[t]])}if(e.length)return void n.push({value:t,width:-1,height:-1,children:e})}const o=g(t);!a&&t.isEnabled()&&t.type===pxtc.ON_START_TYPE?a=o:n.push(o)})),a&&n.unshift(a),Object.keys(r).sort(((t,e)=>t.length===e.length?t>e?-1:1:t.length>e.length?-1:1)).forEach((t=>{r[t]&&n.push(g(r[t]))})),t.forEach((t=>{null==t.data&&n.push(g(t))}));let c,u=0;for(let t=0;t<n.length;t++){const e=n[t];if(e.children){const t=e.value.getHeightWidth();e.x=0,e.y=0;let i=t.width+13,o=0;for(let t=0;t<e.children.length;t++){const s=e.children[t];s.x=i,s.y=o,o+=s.height+13,e.width=Math.max(e.width,i+s.width)}e.height=Math.max(o-13,t.height)}u+=(e.height+13)*(e.width+13)}c=l>o?l-o:Math.sqrt(u)*s;let d=o,p=20,h=0;for(let t=0;t<n.length;t++){const e=n[t];if(e.children){m(e,d+e.x,p+e.y);for(let t=0;t<e.children.length;t++){const i=e.children[t];m(i,d+i.x,p+i.y)}}else m(e,d,p);d+=e.width+45,h=Math.max(h,p+e.height+45),d>c&&(d=o,p=h)}function m(t,e,i){const o=t.value.getBoundingRectangle();t.value.moveBy(e-o.left,i-o.top)}}function g(t){const e=t.getHeightWidth();return{value:t,height:e.height,width:e.width}}i.toSvgAsync=r,i.serializeNode=a,i.serializeSvgString=c,i.cleanUpBlocklySvg=u,i.blocklyToSvgAsync=d,i.documentToSvg=p})((e=t.blocks||(t.blocks={})).layout||(e.layout={}))}(pxt||(pxt={})),function(t){!function(e){const i={string:{field:"TEXT",block:"text",defaultValue:""},number:{field:"NUM",block:"math_number",defaultValue:"0"},boolean:{field:"BOOL",block:"logic_boolean",defaultValue:"false"},Array:{field:"VAR",block:"variables_get",defaultValue:"list"}};function o(t){let e=/^(?:Array<(.+)>)|(?:(.+)\[\])|(?:\[.+\])$/.exec(t);return e?e[1]?e[1]:e[2]:void 0}e.optionalDummyInputPrefix="0_optional_dummy",e.optionalInputWithFieldPrefix="0_optional_field",e.isArrayType=o,e.isTupleType=function(t){let e=/^\[(.+)\]$/.exec(t);return e?e[1].split(/,\s*/):void 0};const s=/^(string|number|boolean)$/;let l,n;function r(){return l||(l={},Object.keys(Blockly.Blocks).forEach((t=>l[t]={block:Blockly.Blocks[t]}))),l}e.builtinBlocks=r,e.buildinBlockStatements={controls_if:!0,controls_for:!0,pxt_controls_for:!0,controls_simple_for:!0,controls_repeat_ext:!0,pxt_controls_for_of:!0,controls_for_of:!0,variables_set:!0,variables_change:!0,device_while:!0};let a={};function c(t,e,s,l){let n;if(l=l||e.defaultValue,!(s=s||e.shadowBlockId)&&e.range&&(s="math_number_minmax"),n=l&&'"'==l.slice(0,1)?JSON.parse(l):l,"number"==e.type&&"value"==s){const t=document.createElement("field");return t.setAttribute("name",e.definitionName),t.appendChild(document.createTextNode("0")),t}const r="variables_get"==s,a="text"==s,c=document.createElement("value");c.setAttribute("name",e.definitionName);const d=o(e.type),p=document.createElement(r||d?"block":"shadow");c.appendChild(p);const h=i[d||e.type];if(p.setAttribute("type",s||(d?"lists_create_with":h&&h.block||e.type)),p.setAttribute("colour",Blockly.Colours.textField),d){if(h&&!s){let t;switch(d){case"number":t=["0","1"];break;case"string":t=["a","b","c"];break;case"boolean":t=["FALSE","FALSE","FALSE"]}return u(p,h.block,h.field,t),c}if(s&&n)return u(p,n),c}if(!h||s&&h.block!==s&&"math_number_minmax"!==s){if(n){const i=document.createElement("field");if(i.textContent=n,r)i.setAttribute("name","VAR"),p.appendChild(i);else if(a)i.setAttribute("name","TEXT"),p.appendChild(i);else if(s){const e=t.blocksById[s];if(e&&e.attributes._def&&e.attributes._def.parameters.length){const t=e.attributes._def.parameters[0];i.setAttribute("name",t.name),p.appendChild(i)}}else i.setAttribute("name",e.definitionName),p.appendChild(i)}}else{const t=document.createElement("field");let i,o;switch(p.appendChild(t),s){case"variables_get":i="VAR";break;case"math_number_minmax":i="SLIDER";break;default:i=h.field}t.setAttribute("name",i),o="boolean"==e.type?document.createTextNode((n||h.defaultValue).toUpperCase()):document.createTextNode(n||h.defaultValue),t.appendChild(o)}let m;return e.range&&(m=document.createElement("mutation"),m.setAttribute("min",e.range.min.toString()),m.setAttribute("max",e.range.max.toString()),m.setAttribute("label",e.actualName.charAt(0).toUpperCase()+e.actualName.slice(1)),e.fieldOptions&&(e.fieldOptions.step&&m.setAttribute("step",e.fieldOptions.step),e.fieldOptions.color&&m.setAttribute("color",e.fieldOptions.color),e.fieldOptions.precision&&m.setAttribute("precision",e.fieldOptions.precision))),e.fieldOptions&&(m||(m=document.createElement("mutation")),m.setAttribute("customfield",JSON.stringify(e.fieldOptions))),m&&p.appendChild(m),c}function u(t,e,i,o){const s=o?o.length:2,l=document.createElement("mutation");l.setAttribute("items",""+s),l.setAttribute("horizontalafter",""+s),t.appendChild(l);for(let l=0;l<s;l++){const s=document.createElement("value");s.setAttribute("name","ADD"+l);const n=document.createElement("shadow");if(n.setAttribute("type",e),i){const t=document.createElement("field");t.setAttribute("name",i),o&&t.appendChild(document.createTextNode(o[l])),n.appendChild(t)}s.appendChild(n),t.appendChild(s)}}function d(e,i,o,s){const l=p(e,t.toolbox.convertColor(i),o,s);return l.setAttribute("web-class","blocklyFlyoutHeading"),l}function p(e,i,o,s){let l=Blockly.utils.xml.createElement("label");return l.setAttribute("text",e),i&&l.setAttribute("web-icon-color",t.toolbox.convertColor(i)),o&&(1===o.length?(l.setAttribute("web-icon",o),s&&l.setAttribute("web-icon-class",s)):l.setAttribute("web-icon-class",`blocklyFlyoutIcon${e}`)),l}function h(e,i,l){let n=document.createElement("block");if(n.setAttribute("type",i.attributes.blockId),i.attributes.blockGap?n.setAttribute("gap",i.attributes.blockGap):t.appTarget.appTheme&&t.appTarget.appTheme.defaultBlockGap&&n.setAttribute("gap",t.appTarget.appTheme.defaultBlockGap.toString()),l.thisParameter){const t=l.thisParameter;n.appendChild(c(e,t,t.shadowBlockId||"variables_get",t.defaultValue||t.definitionName))}return i.parameters&&(l.parameters.filter((t=>!t.isOptional&&(s.test(t.type)||s.test(o(t.type))||t.shadowBlockId||t.defaultValue))).forEach((t=>{n.appendChild(c(e,t))})),i.attributes.draggableParameters?l.handlerArgs.forEach((e=>{const o="reporter"===i.attributes.draggableParameters,s=document.createElement("value");s.setAttribute("name","HANDLER_DRAG_PARAM_"+e.name);const l=o?t.blocks.reporterTypeForArgType(e.type):"variables_get_reporter",r=document.createElement("shadow");if(r.setAttribute("type",l),o&&"argument_reporter_custom"===l){const t=document.createElement("mutation");t.setAttribute("typename",e.type),r.appendChild(t)}const a=document.createElement("field");a.setAttribute("name",o?"VALUE":"VAR"),a.textContent=t.Util.htmlEscape(e.name),r.appendChild(a),s.appendChild(r),n.appendChild(s)})):l.handlerArgs.forEach((t=>{const e=document.createElement("field");e.setAttribute("name","HANDLER_"+t.name),e.textContent=t.name,n.appendChild(e)}))),n}function m(i){return n=i,Blockly.pxtBlocklyUtils.whitelistDraggableBlockTypes(i.blocks.filter((t=>t.attributes.duplicateShadowOnDrag)).map((t=>t.attributes.blockId))),i.blocks.map((o=>{const s=e.compileInfo(o),l=h(i,o,s);if(o.attributes.blockBuiltin){t.Util.assert(!!r()[o.attributes.blockId]);const e=r()[o.attributes.blockId];e.symbol=o,e.block.codeCard=g(o,l)}else!function(i,o,s,l){let n=o.attributes.blockId;if(r()[n])return t.reportError("blocks","trying to override builtin block",{details:n}),!1;let c=JSON.stringify(o);if(a[n]&&a[n].hash==c)return!0;if(Blockly.Blocks[o.attributes.blockId])return console.error("duplicate block definition: "+n),!1;let u={hash:c,fn:o,block:{codeCard:g(o,l),init:function(){!function(i,o,s,l){var n;const r=(s.attributes.blockNamespace||s.namespace).split(".")[0],a=1==s.kind||2==s.kind,c=o.apis.byQName[r],u=s.attributes.blockNamespace&&c&&c.attributes.color||s.attributes.color||c&&c.attributes.color||t.toolbox.getNamespaceColor(r)||255;if(s.attributes.help){const t=s.attributes.help.replace(/^\//,"");/^github:/.test(t)?i.setHelpUrl(t):"none"!==t&&i.setHelpUrl("/reference/"+t)}else if(s.pkg&&!t.appTarget.bundledpkgs[s.pkg]){let t=s.qName.toLowerCase().split(".");t[0]==s.pkg&&t.shift(),i.setHelpUrl(`/pkg/${s.pkg}#${encodeURIComponent(t.join("-"))}`)}i.setColour(u);let d=Blockly.OUTPUT_SHAPE_ROUND;"boolean"==s.retType&&(d=Blockly.OUTPUT_SHAPE_HEXAGONAL);i.setOutputShape(d),s.attributes.undeletable&&i.setDeletable(!1);m(s.attributes._def);let p=!1;if(s.attributes.mutate)e.addMutation(i,s,s.attributes.mutate);else if(s.attributes.defaultInstance)e.addMutation(i,s,e.MutatorTypes.DefaultInstanceMutator);else if(s.attributes._expandedDef&&"disabled"!==s.attributes.expandableArgumentMode){const t="toggle"===s.attributes.expandableArgumentMode;e.initExpandableBlock(o,i,s.attributes._expandedDef,l,t,(()=>m(s.attributes._expandedDef,!0)))}else if(l.handlerArgs.length)if(p=!0,s.attributes.optionalVariableArgs)e.initVariableArgsBlock(i,l.handlerArgs);else if(s.attributes.draggableParameters)l.handlerArgs.filter((t=>!t.inBlockDef)).forEach((t=>{const e=i.appendValueInput("HANDLER_DRAG_PARAM_"+t.name);"reporter"==s.attributes.draggableParameters?e.setCheck(_(t.type,o)):e.setCheck("Variable")}));else{let t=i.appendDummyInput();l.handlerArgs.filter((t=>!t.inBlockDef)).forEach((e=>{t.appendField(new Blockly.FieldVariable(e.name),"HANDLER_"+e.name)}))}if(e.appendMutation(i,{mutationToDom:t=>(i.inputList.forEach((e=>{e.fieldRow.forEach((e=>{if(e.isFieldCustom_&&e.saveOptions){const i=e.saveOptions();i&&t.setAttribute("customfield",JSON.stringify(i))}}))})),t),domToMutation:t=>{i.inputList.forEach((e=>{e.fieldRow.forEach((e=>{if(e.isFieldCustom_&&e.restoreOptions){const i=JSON.parse(t.getAttribute("customfield"));i&&e.restoreOptions(i)}}))}))}}),s.attributes.imageLiteral){const t=(s.attributes.imageLiteralColumns||5)*s.attributes.imageLiteral,e=s.attributes.imageLiteralRows||5,o=s.attributes.imageLiteralScale;i.appendDummyInput().appendField(new pxtblockly.FieldMatrix("",{columns:t,rows:e,scale:o}),"LEDS")}"external"===s.attributes.inlineInputMode?i.setInputsInline(!1):"inline"===s.attributes.inlineInputMode?i.setInputsInline(!0):i.setInputsInline(!s.parameters||s.parameters.length<4&&!s.attributes.imageLiteral);((null===(n=s.parameters)||void 0===n?void 0:n.find((t=>pxtc.parameterTypeIsArrowFunction(t))))||p)&&(i.appendStatementInput("HANDLER").setCheck(null),i.setInputsInline(!0));T(i,s.retType,o);const h=k(s);function m(n,r=!1){let c=0,d=!r&&!!l.thisParameter;const p=function(t){const e=[];let i=[];return t.parts.forEach((t=>{switch(t.kind){case"break":o();break;case"param":i.push(t),o();break;case"image":case"label":i.push(t)}})),o(),e;function o(){i.length&&(e.push(i),i=[])}}(n),h=new t.ImageConverter;"ENUM_GET"!==s.attributes.shim&&"KIND_GET"!==s.attributes.shim||!(l.parameters.length>1||l.thisParameter)?(p.forEach((n=>{const p=[];let m,f,g,k=!1;if(n.forEach((i=>{if("param"!==i.kind){const e=function(e){if("image"===e.kind)return function(e){let i=N[e];if(!i)return void t.log(`missing jres icon ${e}`);return new Blockly.FieldImage(i,40,40,"",null,t.Util.isUserLanguageRtl())}(e.uri);const i=function(t){if(" "===t)return"";if(t.length>1){const e=" "==t.charAt(0),i=" "==t.charAt(t.length-1);if(e||i)return t.substring(e?1:0,i?t.length-1:t.length)}return t}(e.text);if(!i)return;return e.cssClass?new Blockly.FieldLabel(i,e.cssClass):e.style.length?new pxtblockly.FieldStyledLabel(i,{bold:-1!==e.style.indexOf("bold"),italics:-1!==e.style.indexOf("italics"),blocksInfo:void 0}):new Blockly.FieldLabel(i,void 0)}(i);e&&p.push({field:e})}else{if("ENUM_GET"===s.attributes.shim)return t.U.assert(!!s.attributes.enumName,"Trying to create an ENUM_GET block without a valid enum name"),void p.push({name:"MEMBER",field:new pxtblockly.FieldUserEnum(o.enumsByName[s.attributes.enumName])});if("KIND_GET"===s.attributes.shim)return void p.push({name:"MEMBER",field:new pxtblockly.FieldKind(o.kindsByName[s.attributes.kindNamespace||s.attributes.blockNamespace||s.namespace])});{let c=function(t,e,i=!1){if(t.ref){const i="this"===t.name?e.thisParameter:e.actualNameToParam[t.name];if(!i){let i;if(e.handlerArgs.forEach((e=>{e.name===t.name&&(i=e)})),i)return i}return i}return i?e.thisParameter:e.definitionNameToParam[t.name]}(i,l,d);if(d=!1,!c)return void console.error("block "+s.attributes.blockId+": unknown parameter "+i.name+(i.ref?` (${i.ref})`:""));if(!c.definitionName)return m="HANDLER_DRAG_PARAM_"+c.name,void(f="reporter"===s.attributes.draggableParameters?_(c.type,o):"Variable");let g=t.U.lookup(o.apis.byQName,c.type);k=!0;const b=c.definitionName,y=c.actualName;let T=g&&6==g.kind,x=g&&!!g.attributes.fixedInstances&&!c.shadowBlockId,E=!!s.attributes.constantShim,B="@combined@"==c.type,C=c.fieldEditor,A=b.charAt(0).toUpperCase()+b.slice(1),v=c.type;if(T||x||E||B){let i;T?(n=o.apis,r=c.type,i=t.Util.values(n.byQName).filter((t=>t.namespace===r&&!t.attributes.blockHidden))):i=x?S(o.apis,g.qName):B?s.combinedProperties.map((e=>t.U.lookup(o.apis.byQName,e))):function(e,i){return t.Util.values(e.byQName).filter((t=>t.attributes.blockIdentity===i))}(o.apis,s.qName),0==i.length&&console.error(`no instances of ${g.qName} found`);const l=i.map((e=>{let i=e.attributes.block||e.attributes.blockId||e.name,o=e.attributes.blockCombine;return e.attributes.jresURL&&!e.attributes.iconURL&&t.U.startsWith(e.attributes.jresURL,"data:image/x-mkcd-f")&&(e.attributes.iconURL=h.convert(e.attributes.jresURL)),o&&(i=i.replace(/@set/,"")),[e.attributes.iconURL||e.attributes.blockImage?{src:e.attributes.iconURL||t.Util.pathJoin(t.webConfig.commitCdnUrl,`blocks/${e.namespace.toLowerCase()}/${e.name.toLowerCase()}.png`),alt:i,width:36,height:36,value:e.name}:i,e.namespace+"."+e.name]}));if(c.defaultValue){let t=-1;if(l.some(((e,i)=>e[1]===c.defaultValue&&(t=i,!0))),t>-1){const e=l.splice(t,1)[0];l.unshift(e)}}if(C){let i=s.attributes.paramDefl[y]||"";const n={data:l,colour:u,label:A,type:v,blocksInfo:o};t.Util.jsonMergeFrom(n,s.attributes.paramFieldEditorOptions&&s.attributes.paramFieldEditorOptions[y]||{}),p.push(w(e.createFieldEditor(C,i,n),b))}else p.push(w(new Blockly.FieldDropdown(l),b))}else if(C){const i=s.attributes.paramDefl[c.actualName]||"",l={colour:u,label:A,type:v,blocksInfo:o};t.Util.jsonMergeFrom(l,s.attributes.paramFieldEditorOptions&&s.attributes.paramFieldEditorOptions[c.actualName]||{}),p.push(w(e.createFieldEditor(C,i,l),c.definitionName))}else m=b,a&&"this"===i.name?f=c.type:"number"==c.type&&c.shadowBlockId&&"value"==c.shadowBlockId?(m=void 0,p.push(w(new Blockly.FieldNumber("0"),b))):f="string"==c.type&&c.shadowOptions&&c.shadowOptions.toString?null:_(c.type,o)}}var n,r})),m)g=i.appendValueInput(m),g.setAlign(Blockly.ALIGN_LEFT);else if(r){const t=k?e.optionalInputWithFieldPrefix:e.optionalDummyInputPrefix;g=i.appendDummyInput(t+c++)}else g=i.appendDummyInput();f&&g.setCheck(f),p.forEach((t=>g.appendField(t.field,t.name)))})),h.logTime()):console.warn(`Enum blocks may only have 1 parameter but ${s.attributes.blockId} has ${l.parameters.length}`)}i.setPreviousStatement(!(h&&!s.attributes.handlerStatement)&&"void"==s.retType),i.setNextStatement(!(h&&!s.attributes.handlerStatement)&&"void"==s.retType),i.setTooltip(/^__/.test(s.namespace)?"":s.attributes.jsDoc)}(this,i,o,s)}}};t.Util.isTranslationMode()&&t.blocks.promptTranslateBlock&&(u.block.customContextMenu=e=>{o.attributes.translationId&&e.push({enabled:!0,text:lf("Translate this block"),callback:function(){t.blocks.promptTranslateBlock(n,[o.attributes.translationId])}})});a[n]=u,Blockly.Blocks[n]=u.block}(i,o,s,l);return o}))}function f(t){return t.outerHTML.replace(/^<\?[^>]*>/,"")}function g(t,e){return{name:t.namespace+"."+t.name,shortName:t.name,description:t.attributes.jsDoc,url:t.attributes.help?"reference/"+t.attributes.help.replace(/^\//,""):void 0,blocksXml:`<xml xmlns="http://www.w3.org/1999/xhtml">${f(e)}</xml>`}}function k(t){var e;return!!(null===(e=t.parameters)||void 0===e?void 0:e.some((t=>pxtc.parameterTypeIsArrowFunction(t))))}e.blockSymbol=function(t){let e=a[t];return e?e.fn:void 0},e.createShadowValue=c,e.createFlyoutHeadingLabel=d,e.createFlyoutGroupLabel=function(t,e,i,o){const s=p(t,void 0,e);return s.setAttribute("web-class","blocklyFlyoutGroup"),s.setAttribute("web-line","1.5"),i&&s.setAttribute("web-line-width",i),o&&(s.setAttribute("web-help-button","true"),s.setAttribute("callbackKey",o)),s},e.createFlyoutButton=function(t,e){let i=Blockly.utils.xml.createElement("button");return i.setAttribute("text",e),i.setAttribute("callbackKey",t),i},e.createToolboxBlock=h,e.injectBlocks=m,e.hasArrowFunction=k,e.cleanBlocks=function(){t.debug("removing all custom blocks");for(const t in a)A(a[t].fn)},e.initializeAndInject=function(t){y(),m(t)},e.initialize=function(t){y(),function(t){N={};const e=t.apis.jres;if(!e)return;Object.keys(e).forEach((t=>{const i=e[t];i&&i.icon&&(N[t]=i.icon)}))}(t)};let b=!1;function y(){b||(b=!0,goog.provide("Blockly.Blocks.device"),goog.require("Blockly.Blocks"),Blockly.FieldCheckbox.CHECK_CHAR="■",Blockly.Constants.ADD_START_HATS=!!t.appTarget.appTheme.blockHats,e.initFieldEditors(),function(){const i=Blockly.Msg;i.DUPLICATE_BLOCK=lf("{id:block}Duplicate"),i.DUPLICATE_COMMENT=lf("Duplicate Comment"),i.REMOVE_COMMENT=lf("Remove Comment"),i.ADD_COMMENT=lf("Add Comment"),i.EXTERNAL_INPUTS=lf("External Inputs"),i.INLINE_INPUTS=lf("Inline Inputs"),i.EXPAND_BLOCK=lf("Expand Block"),i.COLLAPSE_BLOCK=lf("Collapse Block"),i.ENABLE_BLOCK=lf("Enable Block"),i.DISABLE_BLOCK=lf("Disable Block"),i.DELETE_BLOCK=lf("Delete Block"),i.DELETE_X_BLOCKS=lf("Delete Blocks"),i.DELETE_ALL_BLOCKS=lf("Delete All Blocks"),i.HELP=lf("Help"),Blockly.BlockSvg.prototype.showHelp=function(){const e=goog.isFunction(this.helpUrl)?this.helpUrl():this.helpUrl;e&&(t.blocks.openHelpUrl||window.open)(e)},Blockly.WorkspaceSvg.prototype.configureContextMenu=function(o,s){if(this.options.readOnly||this.isFlyout)return;o.length=0;let l=this.getTopBlocks(!0),n=Blockly.utils.genUid(),r=this.getTopComments(),a=this;const c=!(this.options.debugMode||this.options.readOnly);if(this.options.comments&&!t.BrowserUtils.isIE()){const t=Blockly.ContextMenu.workspaceCommentOption(a,s);t.enabled=t.enabled&&c,o.push(t)}let u=Blockly.WorkspaceSvg.buildDeleteList_(l),d=0;for(let t=0;t<u.length;t++)u[t].isShadow()||d++;const p=10;function h(){Blockly.Events.setGroup(n);let t=u.shift();t&&(t.workspace?(t.dispose(!1,!0),setTimeout(h,p)):h()),Blockly.Events.setGroup(!1)}const m={text:1==d?i.DELETE_BLOCK:i.DELETE_ALL_BLOCKS,enabled:d>0&&c,callback:()=>{t.tickEvent("blocks.context.delete",void 0,{interactiveConsent:!0}),d<2?h():Blockly.confirm(lf("Delete all {0} blocks?",d),(t=>{t&&h()}))}};o.push(m);const f={text:lf("Format Code"),enabled:c,callback:()=>{t.tickEvent("blocks.context.format",void 0,{interactiveConsent:!0}),t.blocks.layout.flow(this,{useViewWidth:!0})}};if(o.push(f),t.appTarget.appTheme.blocksCollapsing){const e={text:lf("Collapse Blocks"),enabled:l.length&&l.find((t=>t.isEnabled()&&!t.isCollapsed()))&&c,callback:()=>{t.tickEvent("blocks.context.collapse",void 0,{interactiveConsent:!0}),t.blocks.layout.setCollapsedAll(this,!0)}};o.push(e);const i={text:lf("Expand Blocks"),enabled:l.length&&l.find((t=>t.isEnabled()&&t.isCollapsed()))&&c,callback:()=>{t.tickEvent("blocks.context.expand",void 0,{interactiveConsent:!0}),t.blocks.layout.setCollapsedAll(this,!1)}};o.push(i)}if(t.blocks.layout.screenshotEnabled()){const e={text:lf("Snapshot"),enabled:l.length>0||r.length>0,callback:()=>{var e;t.tickEvent("blocks.context.screenshot",void 0,{interactiveConsent:!0}),t.blocks.layout.screenshotAsync(this,null,null===(e=t.appTarget.appTheme)||void 0===e?void 0:e.embedBlocksInSnapshot).then((e=>{t.BrowserUtils.isSafari()&&(e=e.replace(/^data:image\/[^;]/,"data:application/octet-stream")),t.BrowserUtils.browserDownloadDataUri(e,`${t.appTarget.nickname||t.appTarget.id}-${lf("screenshot")}.png`)}))}};o.push(e)}e.onShowContextMenu&&e.onShowContextMenu(this,o)},Blockly.Constants.Logic.LOGIC_COMPARE_ONCHANGE_MIXIN.onchange=function(){}}(),function(){const e=t.blocks.getBlockDefinition(ts.pxtc.ON_START_TYPE);if(Blockly.Blocks[ts.pxtc.ON_START_TYPE]={init:function(){this.jsonInit({message0:e.block.message0,args0:[{type:"input_dummy"},{type:"input_statement",name:"HANDLER"}],colour:(t.appTarget.runtime?t.appTarget.runtime.onStartColor:"")||t.toolbox.getNamespaceColor("loops")}),B(this,ts.pxtc.ON_START_TYPE,e.name,e.tooltip,e.url,String((t.appTarget.runtime?t.appTarget.runtime.onStartColor:"")||t.toolbox.getNamespaceColor("loops")),void 0,void 0,!!t.appTarget.runtime&&t.appTarget.runtime.onStartUnDeletable)}},Blockly.Blocks[pxtc.TS_STATEMENT_TYPE]={init:function(){let e,i,o=this;o.setColour("#717171"),o.setPreviousStatement(!0),o.setNextStatement(!0),o.setInputsInline(!1),o.domToMutation=t=>{const e=parseInt(t.getAttribute("numlines"));o.declaredVariables=t.getAttribute("declaredvars"),i=[];for(let o=0;o<e;o++){const e=t.getAttribute("line"+o);i.push(e)}o.setPythonEnabled(!1)},o.mutationToDom=()=>{let t=document.createElement("mutation");return i&&(i.forEach(((e,i)=>t.setAttribute("line"+i,e))),t.setAttribute("numlines",i.length.toString())),o.declaredVariables&&t.setAttribute("declaredvars",this.declaredVariables),t},o.setPythonEnabled=s=>{if(e!==s){for(;o.inputList.length;)o.removeInput(o.inputList[0].name);e=s,s?(o.appendDummyInput().appendField(t.Util.lf("<python code>"),"LINE0"),o.setTooltip(lf("A Python statement that could not be converted to blocks"))):(i.forEach(((t,e)=>{o.appendDummyInput().appendField(t,"LINE"+e)})),o.setTooltip(lf("A JavaScript statement that could not be converted to blocks")))}},o.getLines=()=>i,o.setEditable(!1),B(this,pxtc.TS_STATEMENT_TYPE,lf("JavaScript statement"),lf("A JavaScript statement that could not be converted to blocks"),"/blocks/javascript-blocks","#717171")}},Blockly.Blocks[pxtc.TS_OUTPUT_TYPE]={init:function(){let t=this;t.setColour("#717171"),t.setPreviousStatement(!1),t.setNextStatement(!1),t.setOutput(!0),t.setEditable(!1),t.appendDummyInput().appendField(new pxtblockly.FieldTsExpression(""),"EXPRESSION"),t.setPythonEnabled=e=>{t.getField("EXPRESSION").setPythonEnabled(e),e?t.setTooltip(lf("A Python expression that could not be converted to blocks")):t.setTooltip(lf("A JavaScript expression that could not be converted to blocks"))},B(t,pxtc.TS_OUTPUT_TYPE,lf("JavaScript expression"),lf("A JavaScript expression that could not be converted to blocks"),"/blocks/javascript-blocks","#717171")}},t.appTarget.runtime&&t.appTarget.runtime.pauseUntilBlock){const e=t.appTarget.runtime.pauseUntilBlock,i=t.blocks.getBlockDefinition(ts.pxtc.PAUSE_UNTIL_TYPE);Blockly.Blocks[pxtc.PAUSE_UNTIL_TYPE]={init:function(){const o=e.color||t.toolbox.getNamespaceColor("loops");this.jsonInit({message0:i.block.message0,args0:[{type:"input_value",name:"PREDICATE",check:"Boolean"}],inputsInline:!0,previousStatement:null,nextStatement:null,colour:o}),B(this,ts.pxtc.PAUSE_UNTIL_TYPE,i.name,i.tooltip,i.url,o,void 0,void 0,!1)}}}const i="pxt_controls_for_of",o=t.blocks.getBlockDefinition(i);Blockly.Blocks[i]={init:function(){this.jsonInit({message0:o.block.message0,args0:[{type:"input_value",name:"VAR",variable:o.block.variable,check:"Variable"},{type:"input_value",name:"LIST",check:["Array","String"]}],previousStatement:null,nextStatement:null,colour:t.toolbox.blockColors.loops,inputsInline:!0}),this.appendStatementInput("DO").appendField(o.block.appendField);let e=this;B(this,i,o.name,(function(){return t.U.rlf(o.tooltip,e.getInputTargetBlock("VAR")?e.getInputTargetBlock("VAR").getField("VAR").getText():"")}),o.url,String(t.toolbox.getNamespaceColor("loops")))}};const s="controls_for_of",l=t.blocks.getBlockDefinition(s);Blockly.Blocks[s]={init:function(){this.jsonInit({message0:l.block.message0,args0:[{type:"field_variable",name:"VAR",variable:l.block.variable},{type:"input_value",name:"LIST",check:"Array"}],previousStatement:null,nextStatement:null,colour:t.toolbox.blockColors.loops,inputsInline:!0}),this.appendStatementInput("DO").appendField(l.block.appendField);let e=this;B(this,s,l.name,(function(){return t.U.rlf(l.tooltip,e.getField("VAR").getText())}),l.url,String(t.toolbox.getNamespaceColor("loops")))}};const n="lists_index_get",r=t.blocks.getBlockDefinition(n);Blockly.Blocks.lists_index_get={init:function(){this.jsonInit({message0:r.block.message0,args0:[{type:"input_value",name:"LIST",check:"Array"},{type:"input_value",name:"INDEX",check:"Number"}],colour:t.toolbox.blockColors.arrays,outputShape:Blockly.OUTPUT_SHAPE_ROUND,inputsInline:!0}),this.setPreviousStatement(!1),this.setNextStatement(!1),this.setOutput(!0),x(this,n)}};const a="lists_index_set",c=t.blocks.getBlockDefinition(a);Blockly.Blocks[a]={init:function(){this.jsonInit({message0:c.block.message0,args0:[{type:"input_value",name:"LIST",check:"Array"},{type:"input_value",name:"INDEX",check:"Number"},{type:"input_value",name:"VALUE",check:null}],previousStatement:null,nextStatement:null,colour:t.toolbox.blockColors.arrays,inputsInline:!0}),x(this,a)}}}(),function(){const i="math_op2",o=t.blocks.getBlockDefinition(i),s=o.tooltip;Blockly.Blocks[i]={init:function(){this.jsonInit({message0:lf("%1 of %2 and %3"),args0:[{type:"field_dropdown",name:"op",options:[[lf("{id:op}min"),"min"],[lf("{id:op}max"),"max"]]},{type:"input_value",name:"x",check:"Number"},{type:"input_value",name:"y",check:"Number"}],inputsInline:!0,output:"Number",outputShape:Blockly.OUTPUT_SHAPE_ROUND,colour:t.toolbox.getNamespaceColor("math")});B(this,i,o.name,(function(t){return s[t.getFieldValue("op")]}),o.url,t.toolbox.getNamespaceColor(o.category))}};const l="math_op3",n=t.blocks.getBlockDefinition(l);Blockly.Blocks[l]={init:function(){this.jsonInit({message0:n.block.message0,args0:[{type:"input_value",name:"x",check:"Number"}],inputsInline:!0,output:"Number",outputShape:Blockly.OUTPUT_SHAPE_ROUND,colour:t.toolbox.getNamespaceColor("math")}),x(this,l)}};["math_number","math_integer","math_whole_number","math_number_minmax"].forEach((e=>{const i=t.blocks.getBlockDefinition(e);C(e,i.name,i.tooltip,i.url,Blockly.Colours.textField,Blockly.Colours.textField,Blockly.Colours.textField)}));const r=Blockly.Msg,a="math_arithmetic",c=t.blocks.getBlockDefinition(a),u=c.tooltip;r.MATH_ADDITION_SYMBOL=c.block.MATH_ADDITION_SYMBOL,r.MATH_SUBTRACTION_SYMBOL=c.block.MATH_SUBTRACTION_SYMBOL,r.MATH_MULTIPLICATION_SYMBOL=c.block.MATH_MULTIPLICATION_SYMBOL,r.MATH_DIVISION_SYMBOL=c.block.MATH_DIVISION_SYMBOL,r.MATH_POWER_SYMBOL=c.block.MATH_POWER_SYMBOL,C(a,c.name,(function(t){return u[t.getFieldValue("OP")]}),c.url,t.toolbox.getNamespaceColor(c.category));const d="math_modulo",p=t.blocks.getBlockDefinition(d);r.MATH_MODULO_TITLE=p.block.MATH_MODULO_TITLE,E(d),e.initMathOpBlock(),e.initMathRoundBlock()}(),function(){Blockly.FieldVariable.prototype.getVariableTypes_=()=>[""];let e=lf("{id:var}item");Blockly.Variables.flyoutCategory=function(e){let i=[];if(!t.appTarget.appTheme.hideFlyoutHeadings){let e=d(lf("Variables"),t.toolbox.getNamespaceColor("variables"),t.toolbox.getNamespaceIcon("variables"));i.push(e)}let o=document.createElement("button");o.setAttribute("text",lf("Make a Variable...")),o.setAttribute("callbackKey","CREATE_VARIABLE"),e.registerButtonCallback("CREATE_VARIABLE",(function(t){Blockly.Variables.createVariable(t.getTargetWorkspace())})),i.push(o);let s=Blockly.Variables.flyoutCategoryBlocks(e);return i=i.concat(s),i},Blockly.Variables.flyoutCategoryBlocks=function(t){let e=t.getVariablesOfType(""),i=[];if(e.length>0){let t=e[e.length-1];e.sort(Blockly.VariableModel.compareByName);for(let t=0;t<e.length;t++){const o=e[t];if(Blockly.Blocks.variables_get){let t='<xml><block type="variables_get" gap="8">'+Blockly.Variables.generateVariableFieldXmlString(o)+"</block></xml>",e=Blockly.Xml.textToDom(t).firstChild;i.push(e)}}if(i[i.length-1].setAttribute("gap","24"),Blockly.Blocks.variables_set){let e='<xml><block type="variables_set" gap="'+(Blockly.Blocks.variables_change?8:24)+'">'+Blockly.Variables.generateVariableFieldXmlString(t)+"</block></xml>",o=Blockly.Xml.textToDom(e).firstChild;{let t=goog.dom.createDom("value");t.setAttribute("name","VALUE");let e=goog.dom.createDom("shadow");e.setAttribute("type","math_number"),t.appendChild(e);let i=goog.dom.createDom("field");i.setAttribute("name","NUM"),i.appendChild(document.createTextNode("0")),e.appendChild(i),o.appendChild(t)}i.push(o)}if(Blockly.Blocks.variables_change){let e='<xml><block type="variables_change" gap="'+(Blockly.Blocks.variables_get?20:8)+'">'+Blockly.Variables.generateVariableFieldXmlString(t)+"</block></xml>",o=Blockly.Xml.textToDom(e).firstChild;{let t=goog.dom.createDom("value");t.setAttribute("name","VALUE");let e=goog.dom.createDom("shadow");e.setAttribute("type","math_number"),t.appendChild(e);let i=goog.dom.createDom("field");i.setAttribute("name","NUM"),i.appendChild(document.createTextNode("1")),e.appendChild(i),o.appendChild(t)}i.push(o)}}return i};const i=Blockly.Msg,o="variables_get",s=t.blocks.getBlockDefinition(o);i.VARIABLES_GET_CREATE_SET=s.block.VARIABLES_GET_CREATE_SET,E(o);E("variables_get_reporter"),i.RENAME_VARIABLE=lf("Rename variable..."),i.DELETE_VARIABLE=lf('Delete the "%1" variable'),i.DELETE_VARIABLE_CONFIRMATION=lf('Delete %1 uses of the "%2" variable?'),i.NEW_VARIABLE_DROPDOWN=lf("New variable...");const l="variables_set",n=t.blocks.getBlockDefinition(l);i.VARIABLES_SET=n.block.VARIABLES_SET,i.VARIABLES_DEFAULT_NAME=e,i.VARIABLES_SET_CREATE_GET=lf("Create 'get %1'"),E(l);const r="variables_change",a=t.blocks.getBlockDefinition(r);Blockly.Blocks[r]={init:function(){this.jsonInit({message0:a.block.message0,args0:[{type:"field_variable",name:"VAR",variable:e},{type:"input_value",name:"VALUE",check:"Number"}],inputsInline:!0,previousStatement:null,nextStatement:null,colour:t.toolbox.getNamespaceColor("variables")}),x(this,r)},customContextMenu:function(t){if(!this.inDebugWorkspace()){let e={enabled:this.workspace.remainingCapacity()>0},i=this.getField("VAR").getText();e.text=lf("Create 'get {0}'",i);let o=goog.dom.createDom("field",null,i);o.setAttribute("name","VAR");let s=goog.dom.createDom("block",null,o);s.setAttribute("type","variables_get"),e.callback=Blockly.ContextMenu.callbackFactory(this,s),t.push(e)}}},i.NEW_VARIABLE_TITLE=lf("New variable name:"),i.RENAME_VARIABLE_TITLE=lf("Rename all '%1' variables to:")}(),function(){const i=Blockly.Msg;i.FUNCTION_CREATE_NEW=lf("Make a Function..."),i.FUNCTION_WARNING_DUPLICATE_ARG=lf("Functions cannot use the same argument name more than once."),i.FUNCTION_WARNING_ARG_NAME_IS_FUNCTION_NAME=lf("Argument names must not be the same as the function name."),i.FUNCTION_WARNING_EMPTY_NAME=lf("Function and argument names cannot be empty."),i.FUNCTIONS_DEFAULT_FUNCTION_NAME=lf("doSomething"),i.FUNCTIONS_DEFAULT_BOOLEAN_ARG_NAME=lf("bool"),i.FUNCTIONS_DEFAULT_STRING_ARG_NAME=lf("text"),i.FUNCTIONS_DEFAULT_NUMBER_ARG_NAME=lf("num"),i.FUNCTIONS_DEFAULT_CUSTOM_ARG_NAME=lf("arg"),i.PROCEDURES_HUE=t.toolbox.getNamespaceColor("functions"),i.REPORTERS_HUE=t.toolbox.getNamespaceColor("variables");const o="procedures_defnoreturn",s=t.blocks.getBlockDefinition(o);i.PROCEDURES_DEFNORETURN_TITLE=s.block.PROCEDURES_DEFNORETURN_TITLE,i.PROCEDURE_ALREADY_EXISTS=s.block.PROCEDURE_ALREADY_EXISTS,Blockly.Blocks.procedures_defnoreturn.init=function(){let e=new Blockly.FieldTextInput("",Blockly.Procedures.rename);this.appendDummyInput().appendField(Blockly.Msg.PROCEDURES_DEFNORETURN_TITLE).appendField(e,"NAME").appendField("","PARAMS"),this.setColour(t.toolbox.getNamespaceColor("functions")),this.arguments_=[],this.argumentVarModels_=[],this.setStartHat(!0),this.setStatements_(!0),this.statementConnection_=null},E(o);const l="procedures_callnoreturn",r=t.blocks.getBlockDefinition(l);i.PROCEDURES_CALLRETURN_TOOLTIP=s.tooltip.toString(),Blockly.Blocks.procedures_callnoreturn={init:function(){let e=new pxtblockly.FieldProcedure("");this.appendDummyInput("TOPROW").appendField(r.block.PROCEDURES_CALLNORETURN_TITLE).appendField(e,"NAME"),this.setPreviousStatement(!0),this.setNextStatement(!0),this.setColour(t.toolbox.getNamespaceColor("functions")),this.arguments_=[],this.quarkConnections_={},this.quarkIds_=null},getProcedureCall:function(){return this.getFieldValue("NAME")},renameProcedure:function(t,e){Blockly.Names.equals(t,this.getProcedureCall())&&this.setFieldValue(e,"NAME")},onchange:function(e){if(this.workspace&&!this.workspace.isFlyout&&!this.isInsertionMarker())if(e.type==Blockly.Events.CREATE&&-1!=e.ids.indexOf(this.id)){let i=this.getProcedureCall(),o=Blockly.Procedures.getDefinition(i,this.workspace);if(!o||o.type==this.defType_&&JSON.stringify(o.arguments_)==JSON.stringify(this.arguments_)||(o=null),!o){Blockly.Events.setGroup(e.group);let i=Blockly.utils.xml.createElement("xml"),o=Blockly.utils.xml.createElement("block");o.setAttribute("type",this.defType_);let s=this.getRelativeToSurfaceXY(),l=s.x+Blockly.SNAP_RADIUS*(this.RTL?-1:1),n=s.y+2*Blockly.SNAP_RADIUS;o.setAttribute("x",l),o.setAttribute("y",n);let r=Blockly.utils.xml.createElement("field");r.setAttribute("name","NAME"),r.appendChild(document.createTextNode(this.getProcedureCall())),o.appendChild(r),i.appendChild(o),t.blocks.domToWorkspaceNoEvents(i,this.workspace),Blockly.Events.setGroup(!1)}}else if(e.type==Blockly.Events.DELETE){let t=this.getProcedureCall();Blockly.Procedures.getDefinition(t,this.workspace)||(Blockly.Events.setGroup(e.group),this.dispose(!0,!1),Blockly.Events.setGroup(!1))}},mutationToDom:function(){const t=document.createElement("mutation");return t.setAttribute("name",this.getProcedureCall()),t},domToMutation:function(t){const e=t.getAttribute("name");this.renameProcedure(this.getProcedureCall(),e)},customContextMenu:function(t){let e={enabled:!0};e.text=Blockly.Msg.PROCEDURES_HIGHLIGHT_DEF;let i=this.getProcedureCall(),o=this.workspace;e.callback=function(){let t=Blockly.Procedures.getDefinition(i,o);t&&t.select()},t.push(e)},defType_:"procedures_defnoreturn"},E(l);const a="function_definition",c=t.blocks.getBlockDefinition(a);i.FUNCTIONS_EDIT_OPTION=c.block.FUNCTIONS_EDIT_OPTION,E(a);const u="function_call",p=t.blocks.getBlockDefinition(u);i.FUNCTIONS_CALL_TITLE=p.block.FUNCTIONS_CALL_TITLE,i.FUNCTIONS_GO_TO_DEFINITION_OPTION=p.block.FUNCTIONS_GO_TO_DEFINITION_OPTION,E(u),E("function_call_output");const h="function_return";Blockly.Blocks[h]={init:function(){e.initReturnStatement(this)},onchange:function(t){const e=this;if(!e.workspace||e.workspace.isFlyout)return;const i=t.type===Blockly.Events.BLOCK_CREATE&&-1!=t.ids.indexOf(e.id),o=t.type===Blockly.Events.END_DRAG&&-1!=t.allNestedIds.indexOf(e.id);if(i||o){const i=e.getRootBlock();if(i.type===h||null!=i.previousConnection)return;i.type!==a&&(Blockly.Events.setGroup(t.group),e.previousConnection.disconnect(),Blockly.Events.setGroup(!1))}}},E(h),Blockly.Procedures.flyoutCategory=function(e){let i=[];if(!t.appTarget.appTheme.hideFlyoutHeadings){let e=d(lf("Functions"),t.toolbox.getNamespaceColor("functions"),t.toolbox.getNamespaceIcon("functions"),"blocklyFlyoutIconfunctions");i.push(e)}const o=lf("Make a Function..."),s=lf("New function name:");let l=Blockly.utils.xml.createElement("button");l.setAttribute("text",o),l.setAttribute("callbackKey","CREATE_FUNCTION");let n=i=>{let o=e.getTopBlocks(!0)[0],s=10,l=10;if(o){let t=o.getRelativeToSurfaceXY();s=t.x+Blockly.SNAP_RADIUS*(o.RTL?-1:1),l=t.y+2*Blockly.SNAP_RADIUS}let n=Blockly.utils.xml.createElement("xml"),r=Blockly.utils.xml.createElement("block");r.setAttribute("type","procedures_defnoreturn"),r.setAttribute("x",String(s)),r.setAttribute("y",String(l));let a=Blockly.utils.xml.createElement("field");a.setAttribute("name","NAME"),a.appendChild(document.createTextNode(i)),r.appendChild(a),n.appendChild(r);let c=t.blocks.domToWorkspaceNoEvents(n,e);Blockly.hideChaff();let u=e.getBlockById(c[0]);u.select(),e.centerOnBlock(u.id)};function r(e,o){for(let s=0;s<e.length;s++){let l=e[s][0],n=(e[s][1],Blockly.utils.xml.createElement("block"));n.setAttribute("type",o),n.setAttribute("gap","16"),n.setAttribute("colour",t.toolbox.getNamespaceColor("functions"));let r=goog.dom.createDom("field",null,l);r.setAttribute("name","NAME"),n.appendChild(r),i.push(n)}}return e.registerButtonCallback("CREATE_FUNCTION",(function(i){let l=i=>{Blockly.prompt(s,i,(function(i){t.tickEvent("blocks.makeafunction"),i&&(i=i.replace(/[\s\xa0]+/g," ").replace(/^ | $/g,""))==o&&(i=null),i&&(e.getVariable(i)?Blockly.alert(Blockly.Msg.VARIABLE_ALREADY_EXISTS.replace("%1",i.toLowerCase()),(function(){l(i)})):Blockly.Procedures.isLegalName_(i,e)?n(i):Blockly.alert(Blockly.Msg.PROCEDURE_ALREADY_EXISTS.replace("%1",i.toLowerCase()),(function(){l(i)})))}))};l("doSomething")})),i.push(l),r(Blockly.Procedures.allProcedures(e)[0],"procedures_callnoreturn"),i};const m=Blockly.Functions.flyoutCategory;Blockly.Functions.flyoutCategory=e=>{const i=m(e);if(i.length>1){let t=I();i.splice(1,0,t)}const o=Blockly.Functions.getAllFunctionDefinitionBlocks(e).filter((t=>t.getDescendants(!1).some((t=>"function_return"===t.type&&t.getInputTargetBlock("RETURN_VALUE"))))).map((t=>t.getField("function_name").getText())),s=d(lf("Functions"),t.toolbox.getNamespaceColor("functions"),t.toolbox.getNamespaceIcon("functions"),"blocklyFlyoutIconfunctions");i.unshift(s);const l=[];for(const t of i)if(l.push(t),"function_call"===t.getAttribute("type")){const e=t.children.item(0);if(e){const i=e.getAttribute("name");if(o.some((t=>t===i))){const e=t.cloneNode(!0);e.setAttribute("type","function_call_output"),l.push(e)}}}return l};const f={number:t.blocks.defaultIconForArgType("number"),boolean:t.blocks.defaultIconForArgType("boolean"),string:t.blocks.defaultIconForArgType("string"),Array:t.blocks.defaultIconForArgType("Array")},g={},k=t.appTarget.runtime&&t.appTarget.runtime.functionsOptions;k&&k.extraFunctionEditorTypes&&k.extraFunctionEditorTypes.forEach((e=>{f[e.typeName]=e.icon||t.blocks.defaultIconForArgType(),e.defaultName&&(g[e.typeName]=e.defaultName)}));Blockly.PXTBlockly.FunctionUtils.argumentIcons=f,Blockly.PXTBlockly.FunctionUtils.argumentDefaultNames=g,Blockly.Blocks.argument_reporter_custom&&(Blockly.Blocks.argument_reporter_custom.domToMutation=function(t){const e=t.getAttribute("typename");this.typeName_=e,T(this,e,n)});const b=Blockly.Functions.makeCreateCallOption;Blockly.Msg.FUNCTIONS_CREATE_CALL_OPTION="",Blockly.Functions.makeCreateCallOption=function(e){let i=b(e),o=e.getField("function_name").getText();return i.text=t.Util.lf("Create 'call {0}'",o),i}}(),function(){const e=Blockly.Msg,i="lists_create_with",o=t.blocks.getBlockDefinition(i);e.LISTS_CREATE_EMPTY_TITLE=o.block.LISTS_CREATE_EMPTY_TITLE,e.LISTS_CREATE_WITH_INPUT_WITH=o.block.LISTS_CREATE_WITH_INPUT_WITH,e.LISTS_CREATE_WITH_CONTAINER_TITLE_ADD=o.block.LISTS_CREATE_WITH_CONTAINER_TITLE_ADD,e.LISTS_CREATE_WITH_ITEM_TITLE=o.block.LISTS_CREATE_WITH_ITEM_TITLE,E(i);const s="lists_length",l=t.blocks.getBlockDefinition(s);e.LISTS_LENGTH_TITLE=l.block.LISTS_LENGTH_TITLE,Blockly.Blocks[s].init=function(){this.jsonInit({message0:e.LISTS_LENGTH_TITLE,args0:[{type:"input_value",name:"VALUE",check:["Array"]}],output:"Number",outputShape:Blockly.OUTPUT_SHAPE_ROUND})},E(s)}(),function(){const e=Blockly.Msg,i="controls_repeat_ext",o=t.blocks.getBlockDefinition(i);e.CONTROLS_REPEAT_TITLE=o.block.CONTROLS_REPEAT_TITLE,e.CONTROLS_REPEAT_INPUT_DO=o.block.CONTROLS_REPEAT_INPUT_DO,E(i);const s="device_while",l=t.blocks.getBlockDefinition(s);Blockly.Blocks[s]={init:function(){this.jsonInit({message0:l.block.message0,args0:[{type:"input_value",name:"COND",check:"Boolean"}],previousStatement:null,nextStatement:null,colour:t.toolbox.getNamespaceColor("loops")}),this.appendStatementInput("DO").appendField(l.block.appendField),x(this,s)}};const n="pxt_controls_for",r=t.blocks.getBlockDefinition(n);Blockly.Blocks[n]={init:function(){this.jsonInit({message0:r.block.message0,args0:[{type:"input_value",name:"VAR",variable:r.block.variable,check:"Variable"},{type:"input_value",name:"TO",check:"Number"}],previousStatement:null,nextStatement:null,colour:t.toolbox.getNamespaceColor("loops"),inputsInline:!0}),this.appendStatementInput("DO").appendField(r.block.appendField);let e=this;B(this,n,r.name,(function(){return t.U.rlf(r.tooltip,e.getInputTargetBlock("VAR")?e.getInputTargetBlock("VAR").getField("VAR").getText():"")}),r.url,String(t.toolbox.getNamespaceColor("loops")))},getVars:function(){return[this.getField("VAR").getText()]},renameVar:function(t,e){const i=this.getField("VAR");Blockly.Names.equals(t,i.getText())&&i.setValue(e)}};const a="controls_simple_for",c=t.blocks.getBlockDefinition(a);Blockly.Blocks[a]={init:function(){this.jsonInit({message0:c.block.message0,args0:[{type:"field_variable",name:"VAR",variable:c.block.variable},{type:"input_value",name:"TO",check:"Number"}],previousStatement:null,nextStatement:null,colour:t.toolbox.getNamespaceColor("loops"),inputsInline:!0}),this.appendStatementInput("DO").appendField(c.block.appendField);let e=this;B(this,a,c.name,(function(){return t.U.rlf(c.tooltip,e.getField("VAR").getText())}),c.url,String(t.toolbox.getNamespaceColor("loops")))},getVars:function(){return[this.getField("VAR").getText()]},renameVar:function(t,e){const i=this.getField("VAR");Blockly.Names.equals(t,i.getText())&&i.setValue(e)},customContextMenu:function(t){if(!this.isCollapsed()&&!this.inDebugWorkspace()){let e={enabled:!0},i=this.getField("VAR").getText();e.text=lf("Create 'get {0}'",i);let o=goog.dom.createDom("field",null,i);o.setAttribute("name","VAR");let s=goog.dom.createDom("block",null,o);s.setAttribute("type","variables_get"),e.callback=Blockly.ContextMenu.callbackFactory(this,s),t.push(e)}}};const u=t.blocks.getBlockDefinition(ts.pxtc.TS_BREAK_TYPE);Blockly.Blocks[pxtc.TS_BREAK_TYPE]={init:function(){const e=t.toolbox.getNamespaceColor("loops");this.jsonInit({message0:u.block.message0,inputsInline:!0,previousStatement:null,nextStatement:null,colour:e}),B(this,ts.pxtc.TS_BREAK_TYPE,u.name,u.tooltip,u.url,e,void 0,void 0,!1)}};const d=t.blocks.getBlockDefinition(ts.pxtc.TS_CONTINUE_TYPE);Blockly.Blocks[pxtc.TS_CONTINUE_TYPE]={init:function(){const e=t.toolbox.getNamespaceColor("loops");this.jsonInit({message0:d.block.message0,inputsInline:!0,previousStatement:null,nextStatement:null,colour:e}),B(this,ts.pxtc.TS_CONTINUE_TYPE,d.name,d.tooltip,d.url,e,void 0,void 0,!1)}};const p="#cccccc";Blockly.Blocks[pxtc.COLLAPSED_BLOCK]={init:function(){this.jsonInit({message0:"...",inputsInline:!0,previousStatement:null,nextStatement:null,colour:p}),B(this,ts.pxtc.COLLAPSED_BLOCK,"...",lf("a few blocks"),void 0,p,void 0,void 0,!1)}}}(),function(){const e=Blockly.Msg,i="controls_if",o=t.blocks.getBlockDefinition(i),s=o.tooltip;e.CONTROLS_IF_MSG_IF=o.block.CONTROLS_IF_MSG_IF,e.CONTROLS_IF_MSG_THEN=o.block.CONTROLS_IF_MSG_THEN,e.CONTROLS_IF_MSG_ELSE=o.block.CONTROLS_IF_MSG_ELSE,e.CONTROLS_IF_MSG_ELSEIF=o.block.CONTROLS_IF_MSG_ELSEIF,e.CONTROLS_IF_TOOLTIP_1=s.CONTROLS_IF_TOOLTIP_1,e.CONTROLS_IF_TOOLTIP_2=s.CONTROLS_IF_TOOLTIP_2,e.CONTROLS_IF_TOOLTIP_3=s.CONTROLS_IF_TOOLTIP_3,e.CONTROLS_IF_TOOLTIP_4=s.CONTROLS_IF_TOOLTIP_4,E(i);const l="logic_compare",n=t.blocks.getBlockDefinition(l).tooltip;e.LOGIC_COMPARE_TOOLTIP_EQ=n.LOGIC_COMPARE_TOOLTIP_EQ,e.LOGIC_COMPARE_TOOLTIP_NEQ=n.LOGIC_COMPARE_TOOLTIP_NEQ,e.LOGIC_COMPARE_TOOLTIP_LT=n.LOGIC_COMPARE_TOOLTIP_LT,e.LOGIC_COMPARE_TOOLTIP_LTE=n.LOGIC_COMPARE_TOOLTIP_LTE,e.LOGIC_COMPARE_TOOLTIP_GT=n.LOGIC_COMPARE_TOOLTIP_GT,e.LOGIC_COMPARE_TOOLTIP_GTE=n.LOGIC_COMPARE_TOOLTIP_GTE,E(l);const r="logic_operation",a=t.blocks.getBlockDefinition(r),c=a.tooltip;e.LOGIC_OPERATION_AND=a.block.LOGIC_OPERATION_AND,e.LOGIC_OPERATION_OR=a.block.LOGIC_OPERATION_OR,e.LOGIC_OPERATION_TOOLTIP_AND=c.LOGIC_OPERATION_TOOLTIP_AND,e.LOGIC_OPERATION_TOOLTIP_OR=c.LOGIC_OPERATION_TOOLTIP_OR,E(r);const u="logic_negate",d=t.blocks.getBlockDefinition(u);e.LOGIC_NEGATE_TITLE=d.block.LOGIC_NEGATE_TITLE,E(u);const p="logic_boolean",h=t.blocks.getBlockDefinition(p);e.LOGIC_BOOLEAN_TRUE=h.block.LOGIC_BOOLEAN_TRUE,e.LOGIC_BOOLEAN_FALSE=h.block.LOGIC_BOOLEAN_FALSE,E(p)}(),function(){const e=t.blocks.getBlockDefinition("text");C("text",e.name,e.tooltip,e.url,Blockly.Colours.textField,Blockly.Colours.textField,Blockly.Colours.textField);const i=Blockly.Msg,o="text_length",s=t.blocks.getBlockDefinition(o);i.TEXT_LENGTH_TITLE=s.block.TEXT_LENGTH_TITLE,Blockly.Blocks[o].init=function(){this.jsonInit({message0:i.TEXT_LENGTH_TITLE,args0:[{type:"input_value",name:"VALUE",check:["String"]}],output:"Number",outputShape:Blockly.OUTPUT_SHAPE_ROUND})},E(o);const l="text_join",n=t.blocks.getBlockDefinition(l);i.TEXT_JOIN_TITLE_CREATEWITH=n.block.TEXT_JOIN_TITLE_CREATEWITH,E(l)}(),function(){const e=(t,e)=>Math.abs(e-(t.left+t.width/2)),i=Blockly.BlockDragger.prototype.dragBlock;Blockly.BlockDragger.prototype.dragBlock=function(o,s){const l=document.getElementsByClassName("blocklyToolboxDiv")[0],n=document.getElementsByClassName("blocklyTreeRoot")[0]||document.getElementsByClassName("blocklyFlyout")[0],r=document.getElementById("blocklyTrashIcon");if(n&&r){const i=e(n.getBoundingClientRect(),o.clientX);if(i<200){const e=i/200;r.style.opacity=""+(1-e),r.style.display="block",l&&(n.style.opacity=`${e}`,i<50&&t.BrowserUtils.addClass(l,"blocklyToolboxDeleting"))}else r.style.display="none",n.style.opacity="1",l&&t.BrowserUtils.removeClass(l,"blocklyToolboxDeleting")}return i.call(this,o,s)};const o=Blockly.BlockDragger.prototype.endBlockDrag;Blockly.BlockDragger.prototype.endBlockDrag=function(e,i){o.call(this,e,i);const s=document.getElementsByClassName("blocklyToolboxDiv")[0],l=document.getElementsByClassName("blocklyTreeRoot")[0]||document.getElementsByClassName("blocklyFlyout")[0],n=document.getElementById("blocklyTrashIcon");n&&l&&(n.style.display="none",l.style.opacity="1",s&&t.BrowserUtils.removeClass(s,"blocklyToolboxDeleting"))}}(),Blockly.Blocks[pxtc.TS_DEBUGGER_TYPE]={init:function(){let e=this;e.setColour(t.toolbox.getNamespaceColor("debug")),e.setPreviousStatement(!0),e.setNextStatement(!0),e.setInputsInline(!1),e.appendDummyInput("ON_OFF").appendField(new Blockly.FieldLabel(lf("breakpoint"),void 0),"DEBUGGER").appendField(new pxtblockly.FieldBreakpoint("1",{type:"number"}),"ON_OFF"),B(this,pxtc.TS_DEBUGGER_TYPE,lf("Debugger statement"),lf("A debugger statement invokes any available debugging functionality"),"/javascript/debugger",t.toolbox.getNamespaceColor("debug"))}},Blockly.Msg.WORKSPACE_COMMENT_DEFAULT_TEXT="",function(){const e=t=>{if(t.disabled)return lf("This block is disabled and will not run. Attach this block to an event to enable it.");let e=t.tooltip;for(;goog.isFunction(e);)e=e(t);return e};Blockly.Tooltip.show_=function(){const i=Blockly.Tooltip;if(i.poisonedElement_=i.element_,!Blockly.Tooltip.DIV)return;goog.dom.removeChildren(Blockly.Tooltip.DIV);function o(){let t=i.element_.RTL,e=goog.dom.getViewportSize(),o=Blockly.Tooltip.DIV;o.style.direction=t?"rtl":"ltr",o.style.display="block",Blockly.Tooltip.visible=!0;let s=i.lastX_;t?s-=Blockly.Tooltip.OFFSET_X+o.offsetWidth:s+=Blockly.Tooltip.OFFSET_X;let l=i.lastY_+Blockly.Tooltip.OFFSET_Y;l+o.offsetHeight>e.height+window.scrollY&&(l-=o.offsetHeight+2*Blockly.Tooltip.OFFSET_Y),t?s=Math.max(Blockly.Tooltip.MARGINS-window.scrollX,s):s+o.offsetWidth>e.width+window.scrollX-2*Blockly.Tooltip.MARGINS&&(s=e.width-o.offsetWidth-2*Blockly.Tooltip.MARGINS),o.style.top=l+"px",o.style.left=s+"px"}if(i.element_.codeCard){const s=t.docs.codeCard.render({header:e(i.element_)});Blockly.Tooltip.DIV.appendChild(s),o()}else{let t=e(i.element_);t=Blockly.utils._string.wrap(t,Blockly.Tooltip.LIMIT);let s=t.split("\n");for(let t=0;t<s.length;t++){let e=document.createElement("div");e.appendChild(document.createTextNode(s[t])),Blockly.Tooltip.DIV.appendChild(e)}o()}}}(),Blockly.Block.prototype.setEnabled=function(t){if(this.disabled==t){let e=Blockly.Events.recordUndo;Blockly.Events.recordUndo=!1,Blockly.Events.fire(new Blockly.Events.BlockChange(this,"disabled",null,this.disabled,!t)),Blockly.Events.recordUndo=e,this.disabled=!t}})}function _(t,e){const i=t.split(/\s*\|\s*/),s=[];for(const t of i)switch(t){case"number":s.push("Number");break;case"string":s.push("String");break;case"boolean":s.push("Boolean");break;case"T":case"any":return null;case"void":return;default:if(o(t)){if(i.length>1)return null;s.push("Array")}const l=e.apis.byQName[t];l&&l.extendsTypes&&0<l.extendsTypes.length?s.push(...l.extendsTypes):s.push(t)}return s}function T(t,e,i){const o=_(e,i);(o||null===o)&&t.setOutput(!0,o)}function x(e,i){const o=t.blocks.getBlockDefinition(i);B(e,i,o.name,o.tooltip,o.url,t.toolbox.getNamespaceColor(o.category))}function E(e){const i=t.blocks.getBlockDefinition(e);C(e,i.name,i.tooltip,i.url,t.toolbox.getNamespaceColor(i.category))}function B(i,o,s,l,n,r,a,c,u){!l||"string"!=typeof l&&"function"!=typeof l||i.setTooltip(l),n&&i.setHelpUrl(n),r&&i.setColour(r,a,c),u&&i.setDeletable(!1);let d=document.getElementById("blocklyToolboxDefinition"),p=d?e.getFirstChildWithAttr(d,"block","type",o):void 0;i.codeCard={header:s,name:s,software:1,description:goog.isFunction(l)?l(i):l,blocksXml:p?'<xml xmlns="http://www.w3.org/1999/xhtml">'+(f(p)||`<block type="${o}"></block>`)+"</xml>":void 0,url:n},t.Util.isTranslationMode()&&t.blocks.promptTranslateBlock&&(i.customContextMenu=e=>{const s=t.blocks.getBlockDefinition(i.type);s&&s.translationIds&&e.push({enabled:!0,text:lf("Translate this block"),callback:function(){t.blocks.promptTranslateBlock(o,s.translationIds)}})})}function C(t,e,i,o,s,l,n){let r=Blockly.Blocks[t],a=r.init;a&&(r.init=function(){a.call(this);B(this,t,e,i,o,s,l,n)})}function A(t){delete Blockly.Blocks[t.attributes.blockId],delete a[t.attributes.blockId]}function v(e,i,o,s){const l=document.createElement(s?"shadow":"block");l.setAttribute("type",t.Util.htmlEscape(e));const n=document.createElement("field");return n.setAttribute("name",t.Util.htmlEscape(i)),n.textContent=t.Util.htmlEscape(o),l.appendChild(n),l}function I(){const t=document.createElement("block");t.setAttribute("type","function_return");const e=document.createElement("value");e.setAttribute("name","RETURN_VALUE"),t.appendChild(e);const i=v("math_number","NUM","0",!0);return e.appendChild(i),t}e.installHelpResources=C,e.onShowContextMenu=void 0,e.mkPredicateBlock=function(t){const e=document.createElement("block");e.setAttribute("type",t);const i=document.createElement("value");i.setAttribute("name","PREDICATE"),e.appendChild(i);const o=v("logic_boolean","BOOL","TRUE",!0);return i.appendChild(o),e},e.mkFieldBlock=v,e.mkReturnStatementBlock=I;let N={};function w(t,e){return{field:t,name:e}}function S(e,i){return t.Util.values(e.byQName).filter((t=>4===t.kind&&t.attributes.fixedInstance&&function(t,e,i){if(e==i)return!0;let o=t.byQName[e];return!(!o||!o.extendsTypes)&&o.extendsTypes.indexOf(i)>=0}(e,t.retType,i)))}function D(t){return t.data?/^(?:\d+;?)+$/.test(t.data)?{commentRefs:t.data.split(";"),fieldData:{}}:JSON.parse(t.data):{commentRefs:[],fieldData:{}}}function L(t,e){t.data=JSON.stringify(e)}e.getFixedInstanceDropdownValues=S,e.generateIcons=function(e){const i=new t.ImageConverter;e.forEach((e=>{e.attributes.jresURL&&!e.attributes.iconURL&&t.U.startsWith(e.attributes.jresURL,"data:image/x-mkcd-f")&&(e.attributes.iconURL=i.convert(e.attributes.jresURL))}))},e.setVarFieldValue=function(t,e,i){const o=t.getField(e),s=t.workspace.getAllVariables();let l=!1;if(s&&s.length)for(let t=0;t<s.length;t++){const e=s[t];e.name===i&&(o.setValue(e.getId()),l=!0)}if(!l){o.initModel();const t=o.getVariable();t.name=i,o.setValue(t.getId())}},e.getBlockData=D,e.setBlockData=L,e.setBlockDataForField=function(t,e,i){const o=D(t);o.fieldData[e]=i,L(t,o)},e.getBlockDataForField=function(t,e){return D(t).fieldData[e]}}(t.blocks||(t.blocks={}))}(pxt||(pxt={})),function(t){!function(e){let i;!function(t){t.ObjectDestructuringMutator="objectdestructuring",t.RestParameterMutator="restparameter",t.DefaultInstanceMutator="defaultinstance"}(i=e.MutatorTypes||(e.MutatorTypes={})),e.addMutation=function(t,e,o){let r;switch(o){case i.ObjectDestructuringMutator:if(!e.parameters||e.parameters.length<1)console.error("Destructuring mutations require at least one parameter");else{let t=!1;for(const i of e.parameters)if(-1!==i.type.indexOf("=>")){if(!i.properties||0===i.properties.length)return void console.error("Destructuring mutations only supported for functions with an event parameter that has multiple properties");t=!0}if(!t)return void console.error("Destructuring mutations must have an event parameter")}r=new s(t,e);break;case i.RestParameterMutator:r=new l(t,e);break;case i.DefaultInstanceMutator:r=new n(t,e);break;default:return void console.warn("Ignoring unknown mutation type: "+o)}t.mutationToDom=r.mutationToDom.bind(r),t.domToMutation=r.domToMutation.bind(r),t.compose=r.compose.bind(r),t.decompose=r.decompose.bind(r),t.mutation=r},e.mutateToolboxBlock=function(t,e,o){const r=document.createElement("mutation");switch(e){case i.ObjectDestructuringMutator:r.setAttribute(s.propertiesAttributeName,o);break;case i.RestParameterMutator:r.setAttribute(l.countAttributeName,o);break;case i.DefaultInstanceMutator:r.setAttribute(n.attributeName,o);default:return void console.warn("Ignoring unknown mutation type: "+e)}t.appendChild(r)};class o{constructor(t,e){this.info=e,this.block=t,this.topBlockType=this.block.type+"_mutator";const i=this.getSubBlockNames();this.initializeMutatorTopBlock(),this.initializeMutatorSubBlocks(i);const o=i.map((t=>t.type));this.block.setMutator(new Blockly.Mutator(o))}compose(t){const e=t.getDescendants(!1).map((t=>({type:t.type,name:t.inputList[0].name})));e.shift(),this.updateBlock(e)}decompose(t){const e=t.newBlock(this.topBlockType);e.initSvg();for(const i of e.inputList)if(i.name===o.mutatorStatmentInput){let e=i.connection;this.getVisibleBlockTypes().forEach((i=>{const o=t.newBlock(i);o.initSvg(),e.connect(o.previousConnection),e=o.nextConnection}));break}return e}compileMutation(t,e){}getDeclaredVariables(){}isDeclaredByMutation(t){return!1}initializeMutatorSubBlock(t,e,i){t.appendDummyInput(e).appendField(e),t.setColour(i),t.setNextStatement(!0),t.setPreviousStatement(!0)}initializeMutatorTopBlock(){const t=this.info.attributes.mutateText,e=this.block.getColour();Blockly.Blocks[this.topBlockType]=Blockly.Blocks[this.topBlockType]||{init:function(){const i=this;i.appendDummyInput().appendField(t),i.setColour(e),i.appendStatementInput(o.mutatorStatmentInput)}}}initializeMutatorSubBlocks(t){const e=this.block.getColour(),i=this.initializeMutatorSubBlock.bind(this);t.forEach((t=>{Blockly.Blocks[t.type]=Blockly.Blocks[t.type]||{init:function(){i(this,t.name,e)}}}))}}o.mutatorStatmentInput="PROPERTIES",o.mutatedVariableInputName="properties";class s extends o{constructor(t,e){super(t,e),this.currentlyVisible=[],this.parameterRenames={},this.prefix=this.info.attributes.mutatePrefix,this.block.appendDummyInput(o.mutatedVariableInputName),this.block.appendStatementInput("HANDLER").setCheck("null")}getMutationType(){return i.ObjectDestructuringMutator}compileMutation(t,i){if(!this.info.attributes.mutatePropertyEnum&&!this.parameters.length)return;const o=`function ({ ${this.parameters.map((i=>{const o=this.block.getField(i),s=o&&o.getText(),l=e.escapeVarName(i,t);return s!==i?(this.parameterRenames[i]=s,`${i}: ${e.escapeVarName(s,t)}`):l})).join(", ")} })`;return this.info.attributes.mutatePropertyEnum?e.mkText(` [${this.parameters.map((t=>`${this.info.attributes.mutatePropertyEnum}.${t}`)).join(", ")}],${o}`):e.mkText(o)}getDeclaredVariables(){const t={};return this.parameters.forEach((e=>{t[this.getVarFieldValue(e)]=this.parameterTypes[e]})),t}isDeclaredByMutation(t){return this.parameters.some((e=>this.getVarFieldValue(e)===t))}mutationToDom(){const e=document.createElement("mutation"),i=this.parameters.map((e=>{const i=this.getVarFieldValue(e);return i!==e&&(this.parameterRenames[e]=t.Util.htmlEscape(i)),t.Util.htmlEscape(e)})).join(",");e.setAttribute(s.propertiesAttributeName,i);for(const t in this.parameterRenames)t===this.parameterRenames[t]&&delete this.parameterRenames[t];return e.setAttribute(s.renameAttributeName,JSON.stringify(this.parameterRenames)),e}domToMutation(t){const e=t.getAttribute(s.propertiesAttributeName);if(e){const i=e.split(","),o=[];if(void 0===this.paramIndex&&(this.paramIndex=this.getParameterIndex()),i.forEach((t=>{const e=t.split(":");this.info.parameters[this.paramIndex].properties.some((t=>t.name===e[0]))&&o.push({property:e[0],newName:e[1]})})),this.parameterRenames=void 0,t.hasAttribute(s.renameAttributeName))try{this.parameterRenames=JSON.parse(t.getAttribute(s.renameAttributeName))}catch(t){console.warn("Ignoring invalid rename map in saved block mutation")}this.parameterRenames=this.parameterRenames||{},this.parameters=[],o.forEach((t=>{this.parameters.push(t.property),t.newName&&t.newName!==t.property&&(this.parameterRenames[t.property]=t.newName)})),this.updateVisibleProperties(),o.filter((t=>!!t.newName)).forEach((t=>this.setVarFieldValue(t.property,t.newName)))}}getVarFieldValue(t){const e=this.block.getField(t);return e&&e.getText()}setVarFieldValue(t,i){this.block.getField(t);this.block.getField(t)&&e.setVarFieldValue(this.block,t,i)}updateBlock(t){this.parameters=[],t.forEach((t=>{-1===this.parameters.indexOf(t.name)&&this.parameters.push(t.name)})),this.updateVisibleProperties()}getSubBlockNames(){return this.parameters=[],this.parameterTypes={},void 0===this.paramIndex&&(this.paramIndex=this.getParameterIndex()),this.info.parameters[this.paramIndex].properties.map((t=>(this.parameterTypes[t.name]=t.type,{type:this.propertyId(t.name),name:t.name})))}getVisibleBlockTypes(){return this.currentlyVisible.map((t=>this.propertyId(t)))}updateVisibleProperties(){if(t.Util.listsEqual(this.currentlyVisible,this.parameters))return;const e=this.block.inputList.find((t=>t.name===o.mutatedVariableInputName));this.prefix&&0===this.currentlyVisible.length&&e.appendField(this.prefix,s.prefixLabel),this.currentlyVisible.forEach((t=>{if(-1===this.parameters.indexOf(t)){const i=this.getVarFieldValue(t);i!==t&&(this.parameterRenames[t]=i),e.removeField(t)}})),this.parameters.forEach((t=>{if(-1===this.currentlyVisible.indexOf(t)){const i=this.parameterRenames[t]||t;e.appendField(new Blockly.FieldVariable(i),t)}})),this.prefix&&0===this.parameters.length&&e.removeField(s.prefixLabel),this.currentlyVisible=this.parameters}propertyId(t){return this.block.type+"_"+t}getParameterIndex(){for(let t=0;t<this.info.parameters.length;t++)if(-1!==this.info.parameters[t].type.indexOf("=>"))return t}}s.propertiesAttributeName="callbackproperties",s.renameAttributeName="renamemap",s.prefixLabel="0prefix_label_";class l extends o{constructor(){super(...arguments),this.count=0}getMutationType(){return i.RestParameterMutator}compileMutation(t,i){const o=[];return this.forEachInput((s=>o.push(e.compileExpression(t,s,i)))),e.mkGroup(o)}mutationToDom(){const t=document.createElement("mutation");return t.setAttribute(l.countAttributeName,this.count.toString()),t}domToMutation(t){const e=t.getAttribute(l.countAttributeName);if(e){try{this.count=parseInt(e)}catch(t){return}for(let t=0;t<this.count;t++)this.addNumberField(!1,t)}}updateBlock(t){if(t){const e=Math.abs(this.count-t.length);if(this.count<t.length)for(let t=0;t<e;t++)this.addNumberField(!0,this.count);else if(this.count>t.length)for(let t=0;t<e;t++)this.removeNumberField()}}getSubBlockNames(){return[{name:"Value",type:l.entryTypeName}]}getVisibleBlockTypes(){const t=[];return this.forEachInput((()=>t.push(l.entryTypeName))),t}addNumberField(t,e){const i=this.block.appendValueInput(l.valueInputPrefix+e).setCheck("Number");if(t){const t=this.block.workspace.newBlock("math_number");t.initSvg(),t.setShadow(!0),i.connection.connect(t.outputConnection),this.block.workspace.render(),this.count++}}removeNumberField(){this.count>0&&this.block.removeInput(l.valueInputPrefix+(this.count-1)),this.count--}forEachInput(t){for(let e=0;e<this.count;e++)t(this.block.getInputTargetBlock(l.valueInputPrefix+e),e)}}l.countAttributeName="count",l.entryTypeName="entry",l.valueInputPrefix="value_input_";class n extends o{constructor(){super(...arguments),this.showing=!1}getMutationType(){return i.DefaultInstanceMutator}compileMutation(t,i){if(this.showing){const o=this.block.getInputTargetBlock(n.instanceInputName);if(o)return e.compileExpression(t,o,i)}}mutationToDom(){const t=document.createElement("mutation");return t.setAttribute(n.attributeName,this.showing?"true":"false"),t}domToMutation(t){const e=t.getAttribute(n.attributeName);e?this.updateShape("true"===e):this.updateShape(!1)}updateBlock(t){this.updateShape(!(!t||!t.length))}getSubBlockNames(){return[{name:"Instance",type:n.instanceSubBlockType}]}getVisibleBlockTypes(){const t=[];return this.showing&&t.push(n.instanceSubBlockType),t}updateShape(t){this.showing!==t&&(t&&!this.block.getInputTargetBlock(n.instanceInputName)?this.block.appendValueInput(n.instanceInputName):this.block.removeInput(n.instanceInputName),this.showing=t)}}n.attributeName="showing",n.instanceInputName="__instance__",n.instanceSubBlockType="instance"}(t.blocks||(t.blocks={}))}(pxt||(pxt={})),function(t){!function(e){let i,o,s;function l(){return i||(o=document.createElement("div"),o.style.position="absolute",o.style.top="0",o.style.left="0",o.style.width="1px",o.style.height="1px",document.body.appendChild(o),i=Blockly.inject(o,{move:{scrollbars:!1},readOnly:!0,sounds:!1,media:t.webConfig.commitCdnUrl+"blockly/media/",rtl:t.Util.isUserLanguageRtl(),renderer:"pxt"})),t.blocks.clearWithoutEvents(i),i}function n(){i&&i.dispose(),i=void 0}function r(e={emPixels:18,layout:s.Align}){switch(e.splitSvg?s.Align:e.layout||s.Flow){case s.Align:t.blocks.layout.verticalAlign(i,e.emPixels||18);break;case s.Flow:t.blocks.layout.flow(i,{ratio:e.aspectRatio,useViewWidth:e.useViewWidth});break;case s.Clean:i.cleanUp_&&i.cleanUp_()}let l=i.getMetrics();const n=o.querySelectorAll("svg")[0].cloneNode(!0);return t.blocks.layout.cleanUpBlocklySvg(n),t.U.toArray(n.querySelectorAll(".blocklyBlockCanvas,.blocklyBubbleCanvas")).forEach((t=>t.setAttribute("transform",`translate(${-l.contentLeft}, ${-l.contentTop}) scale(1)`))),n.setAttribute("viewBox",`0 0 ${l.contentWidth} ${l.contentHeight}`),e.emPixels&&(n.style.width=l.contentWidth/e.emPixels+"em",n.style.height=l.contentHeight/e.emPixels+"em"),e.splitSvg?t.blocks.layout.splitSvg(n,i,e.emPixels):n}!function(t){t[t.None=0]="None",t[t.Align=1]="Align",t[t.Clean=3]="Clean",t[t.Flow=4]="Flow"}(s=e.BlockLayout||(e.BlockLayout={})),e.initRenderingWorkspace=l,e.cleanRenderingWorkspace=n,e.renderWorkspace=r,e.render=function(e,o={emPixels:18,layout:s.Align}){l();try{let s=e||'<xml xmlns="http://www.w3.org/1999/xhtml"></xml>',l=Blockly.Xml.textToDom(s);return t.blocks.domToWorkspaceNoEvents(l,i),r(o)}catch(e){return void t.reportException(e)}finally{n()}},e.blocksMetrics=function(t){const e=t.getTopBlocks(!1);if(!e.length)return{width:0,height:0};let i;return e.forEach((t=>{const e=t.getBoundingRectangle();i?(i.l=Math.min(i.l,e.left),i.r=Math.max(i.r,e.right),i.t=Math.min(i.t,e.top),i.b=Math.min(i.b,e.bottom)):i={l:e.left,r:e.right,t:e.top,b:e.bottom}})),{width:i.r-i.l,height:i.b-i.t}}}(t.blocks||(t.blocks={}))}(pxt||(pxt={})),function(t){!function(t){function e(t,e){let o=[];for(const s in t.children){const l=t.children[s];if("block"===l.tagName)if(e){const t=l.getAttribute("type");t&&t===e&&o.push(l)}else o.push(l);else{const t=i(l);t&&(o=o.concat(t))}}return o}function i(t,i){let o=e(t,i);return o.length?o[0]:null}t.findRootBlocks=e,t.findRootBlock=i}(t.blocks||(t.blocks={}))}(pxt||(pxt={})),function(t){!function(e){!function(e){e.render=function(e,i={}){const o=e.url?/^[^:]+:\/\//.test(e.url)?e.url:"/"+e.url.replace(/^\.?\/?/,""):e.youTubeId?`https://youtu.be/${e.youTubeId}`:void 0,s=!!o,l=(t,e,i="div",o="")=>{let s=document.createElement(i);return e&&(s.className=e),t&&t.appendChild(s),o&&s.appendChild(document.createTextNode(o+"")),s};let n=l(null,"ui "+(e.style||"card")+" "+(e.color||"")+(s?" link":""),s?"a":"div");if(n.setAttribute("role","option"),n.setAttribute("aria-selected","true"),s){const t=n;t.href=o,/^https?:\/\//.test(o)&&(t.target="_blank")}if(!i.hideHeader&&e.header){let t=l(n,"ui content "+(e.responsive?" tall desktop only":""));e.header&&l(t,"description","span",e.header)}const r=(i.shortName?e.shortName:"")||e.name;let a=l(n,"ui image"+(e.responsive?" tall landscape only":""));if(e.label){let t=document.createElement("label");t.className=`ui ${e.labelClass?e.labelClass:"orange right ribbon"} label`,t.textContent=e.label,a.appendChild(t)}if(e.blocksXml){const i=t.blocks.render(e.blocksXml);if(i){let t=l(a,"");t.setAttribute("style","width:100%; min-height:10em"),t.appendChild(i)}else console.error("failed to render blocks"),t.debug(e.blocksXml)}if(e.typeScript){let t=document.createElement("pre");t.appendChild(document.createTextNode(e.typeScript)),a.appendChild(t)}if(e.imageUrl||(e.youTubeId?`https://img.youtube.com/vi/${e.youTubeId}/0.jpg`:void 0)){let t=document.createElement("div");t.className="ui imagewrapper";let i=document.createElement("div");i.className="ui cardimage",i.style.backgroundImage=`url("${e.imageUrl}")`,i.title=r,i.setAttribute("role","presentation"),t.appendChild(i),a.appendChild(t)}if("file"==e.cardType){let t=l(n,"ui fileimage");a.appendChild(t)}if(r||e.description){let t=l(n,"ui content");if(r&&(n.setAttribute("aria-label",r),l(t,"header","div",r)),e.description){const i=l(t,"ui description"),o=e.description.split(".")[0]+".";i.appendChild(document.createTextNode(o))}}if(e.time){let i=l(n,"meta");if(e.time){l(i,"date","span").appendChild(document.createTextNode(t.Util.timeSince(e.time)))}}if(e.extracontent){l(n,"extra content","div").appendChild(document.createTextNode(e.extracontent))}return n}}(e.codeCard||(e.codeCard={}))}(t.docs||(t.docs={}))}(pxt||(pxt={})),function(t){!function(e){function i(t,e){const i=t,o=i.mutationToDom,s=i.domToMutation;i.mutationToDom=()=>{const t=o?o():document.createElement("mutation");return e.mutationToDom(t)},i.domToMutation=t=>{s&&s(t),e.domToMutation(t)}}e.appendMutation=i,e.initVariableArgsBlock=function(t,o){let s=0,l=0,n=t.appendDummyInput(),r=()=>{if(s!==l){if(s>l){const e=s-l;for(let i=0;i<e;i++){const e=o[l+i];n.insertFieldAt(n.fieldRow.length-1,new pxtblockly.FieldArgumentVariable(e.name),"HANDLER_"+e.name);const s=t;(null==s?void 0:s.initSvg)&&s.initSvg()}}else{let t=l-s;for(let e=0;e<t;e++){const t=o[l-e-1];n.removeField("HANDLER_"+t.name)}}s>=o.length?n.removeField("_HANDLER_ADD"):l>=o.length&&a(),l=s}};function a(){n.appendField(new Blockly.FieldImage(t.ADD_IMAGE_DATAURI,24,24,lf("Add argument"),(()=>{s=Math.min(s+1,o.length),r()}),!1),"_HANDLER_ADD")}Blockly.Extensions.apply("inline-svgs",t,!1),a(),i(t,{mutationToDom:e=>{e.setAttribute("numArgs",s.toString());for(let i=0;i<s;i++){const s=t.getField("HANDLER_"+o[i].name);let l=s&&s.getText();e.setAttribute("arg"+i,l)}return e},domToMutation:i=>{let l=parseInt(i.getAttribute("numargs"));s=Math.min(isNaN(l)?0:l,o.length),r();for(let l=0;l<s;l++){const s=i.getAttribute("arg"+l),n="HANDLER_"+o[l].name;t.getField(n)&&e.setVarFieldValue(t,n,s)}}})},e.initExpandableBlock=function(s,l,n,r,a,c){const u="0_add_button",d="0_rem_button",p="_expanded",h="_input_init",m=n.parameters.map((t=>t.name)),f=n.parameters.length,g=a?f:1,k=new o(l);function b(i,o=!1,a=!1){const c=E(i);if(!a&&!o&&c===k.getNumber(p))return;k.setValue(p,c);const u=c;if(!k.getBoolean(h)&&u>0&&(x(),!l.rendered))return;let d=0;for(let i=0;i<l.inputList.length;i++){const o=l.inputList[i];if(t.Util.startsWith(o.name,e.optionalDummyInputPrefix))B(o,d<u||u===f);else if(t.Util.startsWith(o.name,e.optionalInputWithFieldPrefix)||-1!==m.indexOf(o.name)){const t=d<u;if(B(o,t),t&&o.connection&&!o.connection.isConnected()&&!l.isInsertionMarker()){const t=r.definitionNameToParam[n.parameters[d].name];let i=e.createShadowValue(s,t);"value"===i.tagName.toLowerCase()&&(i=i.firstElementChild),Blockly.Events.disable();try{const t=Blockly.Xml.domToBlock(i,l.workspace);t&&o.connection.connect(t.outputConnection)}catch(t){}Blockly.Events.enable()}++d}}_(),o||l.render()}function y(t,e,i,o){l.appendDummyInput(t).appendField(new Blockly.FieldImage(e,24,24,i,(()=>b(o)),!1))}function _(){const t=k.getNumber(p),e=t!==f,i=0!==t,o=!!l.getInput(d),s=!!l.getInput(u);e||l.removeInput(u,!0),i||l.removeInput(d,!0),i&&!o&&y(d,l.REMOVE_IMAGE_DATAURI,lf("Hide optional arguments"),-1*g),e&&(s&&l.inputList.findIndex((t=>t.name===u))!==l.inputList.length-1?(l.removeInput(u,!0),T()):s||T())}function T(){y(u,l.ADD_IMAGE_DATAURI,lf("Reveal optional arguments"),g)}function x(){k.setValue(h,!0),c(),_()}function E(t){return Math.min(Math.max(k.getNumber(p)+t,0),f)}function B(t,e){if(l.rendered){t.setVisible(e).forEach((t=>{t.render()}))}}k.setEventsEnabled(!1),k.setValue(p,0),k.setValue(h,!1),k.setEventsEnabled(!0),Blockly.Extensions.apply("inline-svgs",l,!1),T(),i(l,{mutationToDom:t=>(t.setAttribute(p,k.getString(p)),t.setAttribute(h,k.getString(h)),t),domToMutation:t=>{if(k.setEventsEnabled(!1),t.hasAttribute(h)&&"true"==t.getAttribute(h)&&!k.getBoolean(h)&&(k.setValue(h,!0),x()),t.hasAttribute(p)){const e=parseInt(t.getAttribute(p));if(!isNaN(e)){const t=e-(k.getNumber(p)||0);k.getBoolean(h)?l.rendered||l.isInsertionMarker()?b(t,!0,l.isInsertionMarker()):k.setValue(p,E(t)):b(t,!0)}}k.setEventsEnabled(!0)}}),setTimeout((()=>{l.rendered&&!l.workspace.isDragging()&&b(0,void 0,!0)}),1)},e.initReturnStatement=function(e){const i=t.blocks.getBlockDefinition("function_return"),o="0_add_button",s="0_rem_button";Blockly.Extensions.apply("inline-svgs",e,!1);let l,n=!0;function r(){const r=e.getInput("RETURN_VALUE");if(n){if(!r){for(;e.getInput("");)e.removeInput("");e.jsonInit({message0:i.block.message_with_value,args0:[{type:"input_value",name:"RETURN_VALUE",check:null}],previousStatement:null,colour:t.toolbox.getNamespaceColor("functions")})}if(e.getInput(o)&&e.removeInput(o),e.getInput(s)||u(s,e.REMOVE_IMAGE_DATAURI,lf("Remove return value")),l){const t=e.workspace.getBlockById(l);t&&t.outputConnection&&!t.outputConnection.targetBlock()&&e.getInput("RETURN_VALUE").connection.connect(t.outputConnection),l=void 0}}else{if(r){const o=r.connection.targetBlock();o&&(o.isShadow()&&o.setShadow(!1),r.connection.disconnect(),l=o.id),e.removeInput("RETURN_VALUE"),e.jsonInit({message0:i.block.message_no_value,args0:[],previousStatement:null,colour:t.toolbox.getNamespaceColor("functions")})}e.getInput(s)&&e.removeInput(s),e.getInput(o)||u(o,e.ADD_IMAGE_DATAURI,lf("Add return value"))}e.setInputsInline(!0)}function a(){return Blockly.Xml.domToText(e.mutationToDom())}function c(t,i){t!==i&&Blockly.Events.fire(new Blockly.Events.BlockChange(e,"mutation",null,t,i))}function u(t,i,o){e.appendDummyInput(t).appendField(new Blockly.FieldImage(i,24,24,o,(()=>{const t=a();n=!n;const e=a();c(t,e),r();c(e,a())}),!1))}r(),e.domToMutation=t=>{t.hasAttribute("last_connected_id")&&(l=t.getAttribute("last_connected_id")),n="true"!==t.getAttribute("no_return_value"),r()},e.mutationToDom=()=>{const t=document.createElement("mutation");return function(t,e){t.setAttribute("no_return_value",e?"false":"true")}(t,!!e.getInput("RETURN_VALUE")),l&&t.setAttribute("last_connected_id",l),t}};class o{constructor(t,e){this.block=t,this.fireEvents=!0,this.state=e||{}}setValue(t,e){if(this.fireEvents&&this.block.mutationToDom){const i=this.block.mutationToDom();this.state[t]=e.toString();const o=this.block.mutationToDom();Object.keys(this.state).forEach((t=>{i.getAttribute(t)!==this.state[t]&&o.setAttribute(t,this.state[t])}));const s=Blockly.Xml.domToText(i),l=Blockly.Xml.domToText(o);s!=l&&Blockly.Events.fire(new Blockly.Events.BlockChange(this.block,"mutation",null,s,l))}else this.state[t]=e.toString()}getNumber(t){return parseInt(this.state[t])}getBoolean(t){return"false"!=this.state[t]}getString(t){return this.state[t]}setEventsEnabled(t){this.fireEvents=t}}}(t.blocks||(t.blocks={}))}(pxt||(pxt={})),function(t){!function(e){const i=t.blocks.MATH_FUNCTIONS.unary.concat(t.blocks.MATH_FUNCTIONS.binary).concat(t.blocks.MATH_FUNCTIONS.infix);let o;e.initMathOpBlock=function(){const s="math_js_op",l=t.blocks.getBlockDefinition(s);function n(t,e){const i=t.appendValueInput("ARG"+(e?1:0));i.setCheck("Number"),e&&(i.connection.setShadowDom(function(){if(!o){o=document.createElement("shadow"),o.setAttribute("type","math_number");const t=document.createElement("field");t.setAttribute("name","NUM"),t.textContent="0",o.appendChild(t)}return o}()),i.connection.respawnShadow_())}function r(t,e){let i=!!t.getInput("ARG1");e?(i&&t.moveInputBefore("op_dropdown","ARG1"),t.moveInputBefore("ARG0","op_dropdown")):(i&&t.moveInputBefore("ARG0","ARG1"),t.moveInputBefore("op_dropdown","ARG0"))}Blockly.Blocks[s]={init:function(){const o=this;o.setPreviousStatement(!1),o.setNextStatement(!1),o.setOutput(!0,"Number"),o.setOutputShape(Blockly.OUTPUT_SHAPE_ROUND),o.setInputsInline(!0);o.appendDummyInput("op_dropdown").appendField(new Blockly.FieldDropdown(i.map((t=>[l.block[t],t])),(e=>function(e,i){!function(e){return-1!==t.blocks.MATH_FUNCTIONS.unary.indexOf(e)}(i)?e.getInput("ARG1")||n(e,!0):e.removeInput("ARG1",!0);r(e,function(e){return-1!==t.blocks.MATH_FUNCTIONS.infix.indexOf(e)}(i))}(o,e))),"OP"),n(o,!1),e.appendMutation(o,{mutationToDom:t=>{let e;for(let t=0;t<o.inputList.length;t++){const i=o.inputList[t];if("op_dropdown"===i.name){e=!1;break}if("ARG0"===i.name){e=!0;break}}return t.setAttribute("op-type",(o.getInput("ARG1")?e?"infix":"binary":"unary").toString()),t},domToMutation:t=>{if(t.hasAttribute("op-type")){const e=t.getAttribute("op-type");"unary"!=e&&n(o,!0),r(o,"infix"===e)}}})}},e.installHelpResources(s,l.name,(function(t){return l.tooltip[t.getFieldValue("OP")]}),l.url,t.toolbox.getNamespaceColor(l.category))}}(t.blocks||(t.blocks={}))}(pxt||(pxt={})),function(t){!function(e){const i=t.blocks.ROUNDING_FUNCTIONS;e.initMathRoundBlock=function(){const o="math_js_round",s=t.blocks.getBlockDefinition(o);Blockly.Blocks[o]={init:function(){const t=this;t.setPreviousStatement(!1),t.setNextStatement(!1),t.setOutput(!0,"Number"),t.setOutputShape(Blockly.OUTPUT_SHAPE_ROUND),t.setInputsInline(!0);t.appendDummyInput("round_dropdown").appendField(new Blockly.FieldDropdown(i.map((t=>[s.block[t],t])),(t=>{})),"OP"),function(t){t.appendValueInput("ARG0").setCheck("Number")}(t)}},e.installHelpResources(o,s.name,(function(t){return s.tooltip[t.getFieldValue("OP")]}),s.url,t.toolbox.getNamespaceColor(s.category))}}(t.blocks||(t.blocks={}))}(pxt||(pxt={})),function(t){class e extends Blockly.Field{constructor(t,e,i){super(t,i),this.SERIALIZABLE=!0,this.options=e,t&&!this.valueText&&(this.valueText=t)}init(){super.init(),this.onInit()}dispose(){this.onDispose()}getValue(){return this.valueText}doValueUpdate_(t){null!==t&&(this.valueText=this.loaded?this.onValueChanged(t):t)}getDisplayText_(){return this.valueText}onLoadedIntoWorkspace(){this.loaded||(this.loaded=!0,this.valueText=this.onValueChanged(this.valueText))}isInitialized(){return!!this.fieldGroup_}getBlockData(){return pxt.blocks.getBlockDataForField(this.sourceBlock_,this.name)}setBlockData(t){pxt.blocks.setBlockDataForField(this.sourceBlock_,this.name,t)}}t.FieldBase=e}(pxtblockly||(pxtblockly={})),function(t){var e=pxt.svgUtil;const i=32;class o extends t.FieldBase{constructor(t,e,i){super(t,e,i),this.pendingEdit=!1,this.isEmpty=!1,this.assetChangeListener=()=>{if(this.pendingEdit)return;const t=this.getBlockData();t&&(this.asset=pxt.react.getTilemapProject().lookupAsset(this.getAssetType(),t)),this.redrawPreview()},this.lightMode=e.lightMode,this.params=this.parseFieldOptions(e),this.blocksInfo=e.blocksInfo}onInit(){this.redrawPreview()}onValueChanged(t){return this.parseValueText(t),this.redrawPreview(),this.getValueText()}showEditor_(){if(this.isGreyBlock)return;const e=Object.assign({},this.params);let i;switch(e.blocksInfo=this.blocksInfo,this.asset.type){case"tile":case"image":i="image-editor",e.temporaryAssets=t.getTemporaryAssets(this.sourceBlock_.workspace,"image");break;case"animation":i="animation-editor",e.temporaryAssets=t.getTemporaryAssets(this.sourceBlock_.workspace,"image").concat(t.getTemporaryAssets(this.sourceBlock_.workspace,"animation"));break;case"tilemap":i="tilemap-editor";const o=pxt.react.getTilemapProject();pxt.sprite.addMissingTilemapTilesAndReferences(o,this.asset)}const o=pxt.react.getFieldEditorView(i,this.asset,e);this.undoRedoState&&o.restorePersistentData(this.undoRedoState),pxt.react.getTilemapProject().pushUndo(),o.onHide((()=>{var t;const e=o.getResult(),i=pxt.react.getTilemapProject();if(e){const n=this.getValue();if(pxt.assetEquals(this.asset,e))return;const r=s(this.asset)?null:this.asset.id;let a=s(e)?null:e.id;r||a!==this.sourceBlock_.id||(e.id=i.generateNewID(e.type),a=e.id),this.pendingEdit=!0,(null===(t=e.meta)||void 0===t?void 0:t.displayName)&&this.disposeOfTemporaryAsset(),this.asset=e;const c=i.revision();if(this.onEditorClose(this.asset),this.updateAssetListener(),this.updateAssetMeta(),this.redrawPreview(),this.undoRedoState=o.getPersistentData(),this.sourceBlock_&&Blockly.Events.isEnabled()){const t=new l(this.sourceBlock_,"field",this.name,n,this.getValue(),c,i.revision());r!==a&&(t.oldAssetId=r,t.newAssetId=a),Blockly.Events.fire(t)}this.pendingEdit=!1}})),o.show()}render_(){this.isGreyBlock&&!this.textElement_&&this.createTextElement_(),super.render_(),this.isGreyBlock||(this.size_.height=42,this.size_.width=50)}getDisplayText_(){if(this.isGreyBlock){const t=pxt.Util.htmlUnescape(this.valueText);return t.substr(0,t.indexOf("("))+"(...)"}return""}updateEditable(){if(this.isGreyBlock&&this.fieldGroup_){const t=this.fieldGroup_;Blockly.utils.dom.removeClass(t,"blocklyNonEditableText"),Blockly.utils.dom.removeClass(t,"blocklyEditableText"),t.style.cursor=""}else super.updateEditable()}getValue(){return this.isGreyBlock?pxt.Util.htmlUnescape(this.valueText):this.getValueText()}onDispose(){var t;(null===(t=this.sourceBlock_)||void 0===t?void 0:t.workspace)&&!this.sourceBlock_.workspace.rendered&&this.disposeOfTemporaryAsset(),pxt.react.getTilemapProject().removeChangeListener(this.getAssetType(),this.assetChangeListener)}disposeOfTemporaryAsset(){this.isTemporaryAsset()&&(pxt.react.getTilemapProject().removeAsset(this.asset),this.setBlockData(null),this.asset=void 0)}clearTemporaryAssetData(){this.isTemporaryAsset()&&this.setBlockData(null)}isTemporaryAsset(){return s(this.asset)}getAsset(){return this.asset}updateAsset(t){this.asset=t,this.setValue(this.getValue())}onEditorClose(t){}redrawPreview(){if(!this.fieldGroup_)return;if(pxsim.U.clear(this.fieldGroup_),this.isGreyBlock)return this.createTextElement_(),this.render_(),void this.updateEditable();const o=(new e.Rect).at(5,1).size(40,40).setClass("blocklySpriteField").stroke("#898989",1).corner(4);if(this.fieldGroup_.appendChild(o.el),this.asset){let o;switch(this.asset.type){case"image":case"tile":o=t.bitmapToImageURI(pxt.sprite.Bitmap.fromData(this.asset.bitmap),i,this.lightMode);break;case"animation":o=t.bitmapToImageURI(pxt.sprite.Bitmap.fromData(this.asset.frames[0]),i,this.lightMode);break;case"tilemap":o=t.tilemapToImageURI(this.asset.data,i,this.lightMode)}const s=(new e.Image).src(o).at(9,5).size(i,i);this.fieldGroup_.appendChild(s.el)}}parseValueText(t){if(t=pxt.Util.htmlUnescape(t),this.sourceBlock_&&!this.sourceBlock_.isInFlyout){const e=pxt.react.getTilemapProject(),i=this.getBlockData(),o=e.lookupAsset(this.getAssetType(),i);!o||t&&this.isEmpty?(this.setBlockData(null),this.asset&&this.sourceBlock_&&this.asset.meta.blockIDs&&(this.asset.meta.blockIDs=this.asset.meta.blockIDs.filter((t=>t!==this.sourceBlock_.id)),this.isTemporaryAsset()||e.updateAsset(this.asset)),this.isEmpty=!t,this.asset=this.createNewAsset(t)):this.asset=o,this.updateAssetMeta(),this.updateAssetListener()}}parseFieldOptions(t){const e={initWidth:16,initHeight:16,disableResize:!1,lightMode:!1};return t?(t.disableResize&&(e.disableResize="true"===t.disableResize.toLowerCase()||"1"===t.disableResize),e.initWidth=i(t.initWidth,e.initWidth),e.initHeight=i(t.initHeight,e.initHeight),e.lightMode=t.lightMode,e):e;function i(t,e){const i=parseInt(t);return isNaN(i)?e:i}}updateAssetMeta(){if(this.asset){if(this.asset.meta||(this.asset.meta={}),this.asset.meta.blockIDs||(this.asset.meta.blockIDs=[]),this.sourceBlock_){if(-1===this.asset.meta.blockIDs.indexOf(this.sourceBlock_.id)){const t=this.asset.meta.blockIDs;t.length&&this.isTemporaryAsset()&&t.some((t=>this.sourceBlock_.workspace.getBlockById(t)))&&(this.asset=pxt.cloneAsset(this.asset),this.asset.meta.blockIDs=[]),this.asset.meta.blockIDs.push(this.sourceBlock_.id)}this.setBlockData(this.asset.id)}this.isTemporaryAsset()?this.asset.meta.temporaryInfo={blockId:this.sourceBlock_.id,fieldName:this.name}:pxt.react.getTilemapProject().updateAsset(this.asset)}}updateAssetListener(){pxt.react.getTilemapProject().removeChangeListener(this.getAssetType(),this.assetChangeListener),this.asset&&!this.isTemporaryAsset()&&pxt.react.getTilemapProject().addChangeListener(this.asset,this.assetChangeListener)}}function s(t){return t&&!t.meta.displayName}t.FieldAssetEditor=o;class l extends Blockly.Events.BlockChange{constructor(t,e,i,o,s,l,n){super(t,e,i,o,s),this.oldRevision=l,this.newRevision=n,this.fieldName=i}isNull(){return this.oldRevision===this.newRevision&&super.isNull()}run(t){if(this.newAssetId||this.oldAssetId){const e=this.getEventWorkspace_().getBlockById(this.blockId);t?pxt.blocks.setBlockDataForField(e,this.fieldName,this.newAssetId):pxt.blocks.setBlockDataForField(e,this.fieldName,this.oldAssetId)}t?(pxt.react.getTilemapProject().redo(),super.run(t)):(pxt.react.getTilemapProject().undo(),super.run(t));const e=this.getEventWorkspace_(),i=new l(e.getBlockById(this.blockId),"tilemap-revision","revision",null,pxt.react.getTilemapProject().revision(),0,0);i.recordUndo=!1,Blockly.Events.fire(i)}}t.BlocklyTilemapChange=l}(pxtblockly||(pxtblockly={})),function(t){var e=pxt.svgUtil;const i=32;class o extends t.FieldAssetEditor{constructor(){super(...arguments),this.onMouseEnter=()=>{if(this.animateRef||!this.asset)return;const t=this.getParentInterval()||this.asset.interval,e=t>50?t:50;let i=0;this.animateRef=setInterval((()=>{this.preview&&this.frames[i]&&this.preview.src(this.frames[i]),i=(i+1)%this.frames.length}),e)},this.onMouseLeave=()=>{this.animateRef&&clearInterval(this.animateRef),this.animateRef=void 0,this.preview&&this.frames[0]&&this.preview.src(this.frames[0])}}initView(){this.sourceBlock_.getSvgRoot().addEventListener("mouseenter",this.onMouseEnter),this.sourceBlock_.getSvgRoot().addEventListener("mouseleave",this.onMouseLeave)}showEditor_(){this.asset&&(this.asset.interval=this.getParentInterval()||this.asset.interval),super.showEditor_()}render_(){super.render_(),this.size_.height=42,this.size_.width=80}getAssetType(){return"animation"}createNewAsset(t){const e=pxt.react.getTilemapProject();if(t){const o=pxt.lookupProjectAssetByTSReference(t,e);if(o)return o;const s=-1===(i=t).indexOf("[")?null:(i=i.replace(/[\[\]]/gm,"")).split(",").map((t=>pxt.sprite.imageLiteralToBitmap(t).data())).filter((t=>t.height&&t.width));if(s&&s.length){return{internalID:-1,id:this.sourceBlock_.id,type:"animation",frames:s,interval:this.getParentInterval(),meta:{}}}const l=e.lookupAssetByName("animation",t.trim());if(l)return l}var i;return{internalID:-1,id:this.sourceBlock_.id,type:"animation",frames:[new pxt.sprite.Bitmap(this.params.initWidth,this.params.initHeight).data()],interval:500,meta:{}}}onEditorClose(t){this.setParentInterval(t.interval)}getValueText(){return this.asset?this.isTemporaryAsset()?"["+this.asset.frames.map((t=>pxt.sprite.bitmapToImageLiteral(pxt.sprite.Bitmap.fromData(t),"typescript"))).join(",")+"]":pxt.getTSReferenceForAsset(this.asset):"[]"}redrawPreview(){if(!this.fieldGroup_)return;pxsim.U.clear(this.fieldGroup_);const o=(new e.Rect).at(35,1).size(40,40).corner(4).setClass("blocklyAnimationField");this.fieldGroup_.appendChild(o.el);const s=new e.Text("").at(5,26).fill(this.sourceBlock_.getColourSecondary()).setClass("semanticIcon");this.fieldGroup_.appendChild(s.el),this.asset&&(this.frames=this.asset.frames.map((e=>t.bitmapToImageURI(pxt.sprite.Bitmap.fromData(e),i,this.lightMode))),this.preview=(new e.Image).src(this.frames[0]).at(39,5).size(i,i),this.fieldGroup_.appendChild(this.preview.el))}getParentIntervalBlock(){const t=this.sourceBlock_;if(t.parentBlock_){const e=t.parentBlock_;for(const t of e.inputList)if("frameInterval"===t.name)return t.connection.targetBlock()}}setParentInterval(t){const e=this.getParentIntervalBlock();if(e){const i=s(e);i&&e.setFieldValue(String(t),i)}}getParentInterval(){const t=this.getParentIntervalBlock();if(t){const e=s(t);if(e)return Number(t.getFieldValue(e))}return 100}parseFieldOptions(t){return function(t){const e={initWidth:16,initHeight:16,disableResize:!1,lightMode:!1};if(!t)return e;e.lightMode=t.lightMode,t.filter&&(e.filter=t.filter);return e.initWidth=i(t.initWidth,e.initWidth),e.initHeight=i(t.initHeight,e.initHeight),e;function i(t,e){const i=parseInt(t);return isNaN(i)?e:i}}(t)}}function s(t){return"math_number_minmax"===t.type?"SLIDER":"math_number"===(e=t.type)||"math_integer"===e||"math_whole_number"===e?"NUM":"timePicker"===t.type?"ms":null;var e}t.FieldAnimationEditor=o}(pxtblockly||(pxtblockly={})),function(t){class e extends Blockly.FieldVariable{constructor(t){super(t),this.menuGenerator_=this.dropdownCreate}dropdownCreate(){return Blockly.FieldVariable.dropdownCreate.call(this).filter((t=>t[1]!=Blockly.DELETE_VARIABLE_ID))}}t.FieldArgumentVariable=e}(pxtblockly||(pxtblockly={})),function(t){class e extends Blockly.FieldNumber{constructor(t,e,i){super(t,void 0,void 0,void 0,i),this.isFieldCustom_=!0,this.CURSOR="pointer",this.params=e,this.setValue(t),this.addArgType("toggle"),this.type_=e.type}initView(){if(!this.fieldGroup_)return;null!==this.getArgTypes()&&(this.sourceBlock_.isShadow()?this.sourceBlock_.svgGroup_.setAttribute("data-argument-type",this.getArgTypes()):this.fieldGroup_.setAttribute("data-argument-type",this.getArgTypes()));const t=this.getSize();this.checkElement_=Blockly.utils.dom.createSvgElement("g",{class:"blocklyToggle "+(this.state_?"blocklyToggleOnBreakpoint":"blocklyToggleOffBreakpoint"),transform:`translate(8, ${t.height/2})`},this.fieldGroup_),this.toggleThumb_=Blockly.utils.dom.createSvgElement("polygon",{class:"blocklyToggleRect",points:"50,5 100,5 125,30 125,80 100,105 50,105 25,80 25,30"},this.checkElement_);let e=this.sourceBlock_.RTL?-t.width/2:t.width/2;this.textElement_=Blockly.utils.dom.createSvgElement("text",{class:"blocklyText",x:e,dy:"0.6ex",y:t.height/2},this.fieldGroup_),this.switchToggle(this.state_),this.setValue(this.getValue()),this.markDirty()}updateSize_(){this.size_.width=30}getValue(){return this.toVal(this.state_)}setValue(t){let e=this.fromVal(t);this.state_!==e&&(this.sourceBlock_&&Blockly.Events.isEnabled()&&Blockly.Events.fire(new Blockly.Events.BlockChange(this.sourceBlock_,"field",this.name,this.state_,e)),this.state_=e,this.switchToggle(this.state_))}switchToggle(t){this.checkElement_&&(this.updateSize_(),t?(pxt.BrowserUtils.addClass(this.checkElement_,"blocklyToggleOnBreakpoint"),pxt.BrowserUtils.removeClass(this.checkElement_,"blocklyToggleOffBreakpoint")):(pxt.BrowserUtils.removeClass(this.checkElement_,"blocklyToggleOnBreakpoint"),pxt.BrowserUtils.addClass(this.checkElement_,"blocklyToggleOffBreakpoint")),this.checkElement_.setAttribute("transform","translate(-7, -1) scale(0.3)"))}updateDisplay_(t){super.updateDisplay_(t),this.textElement_&&pxt.BrowserUtils.addClass(this.textElement_,"blocklyToggleText")}render_(){this.visible_&&this.textElement_&&(goog.dom.removeChildren(this.textElement_),this.updateSize_())}showEditor_(){let t=!this.state_;null!==t&&this.setValue(this.toVal(t))}toVal(t){return"number"==this.type_?String(t?"1":"0"):String(t?"true":"false")}fromVal(t){return"string"==typeof t?"1"==t||"TRUE"==t.toUpperCase():!!t}}t.FieldBreakpoint=e}(pxtblockly||(pxtblockly={})),function(t){class e extends Blockly.FieldSlider{constructor(t,e,i){super(String(t),"0","255","1","10","Color",i),this.isFieldCustom_=!0,this.params=e,this.params.min&&(this.min_=parseFloat(this.params.min)),this.params.max&&(this.max_=parseFloat(this.params.max)),this.params.label&&(this.labelText_=this.params.label),this.params.channel&&(this.channel_=this.params.channel)}setBackground_(t){let e=this.createColourStops_().join(",");goog.style.setStyle(t,"background","-moz-linear-gradient(left, "+e+")"),goog.style.setStyle(t,"background","-webkit-linear-gradient(left, "+e+")"),goog.style.setStyle(t,"background","-o-linear-gradient(left, "+e+")"),goog.style.setStyle(t,"background","-ms-linear-gradient(left, "+e+")"),goog.style.setStyle(t,"background","linear-gradient(left, "+e+")"),this.params.sliderWidth&&goog.style.setStyle(t,"width",`${this.params.sliderWidth}px`)}setReadout_(t,e){const i=this.colorWheel(parseInt(e),this.channel_),o=document.createElement("span");o.className="blocklyColorReadout",o.style.backgroundColor=`${i}`,pxsim.U.clear(t),t.appendChild(o)}createColourStops_(){let t=[];for(let e=0;e<=255;e+=20)t.push(this.colorWheel(e,this.channel_));return t}colorWheel(t,e){return"hsvfast"==e?this.hsvFast(t,255,255):(t=255-t)<85?this.hex(3*t,255,255-3*t):t<170?(t-=85,this.hex(255,255-3*t,3*t)):(t-=170,this.hex(255-3*t,3*t,255))}hsvFast(t,e,i){let o=t%255>>0;o<0&&(o+=255),o=192*o/255>>0;let s,l,n,r=i*(255-e)/255>>0,a=i-r,c=o/64>>0,u=o%64>>0,d=(u*a/63.75>>0)+r,p=((63-u)*a/63.75>>0)+r;return c?1==c?(s=r,l=p,n=d):(s=d,l=r,n=p):(s=p,l=d,n=r),this.hex(s,l,n)}hex(t,e,i){return`#${this.componentToHex(255&t)}${this.componentToHex(255&e)}${this.componentToHex(255&i)}`}componentToHex(t){let e=t.toString(16);return 1==e.length?"0"+e:e}}t.FieldColorWheel=e}(pxtblockly||(pxtblockly={})),function(t){class e extends Blockly.FieldColour{constructor(t,e,i){if(super(t,i),this.isFieldCustom_=!0,this.valueMode_="rgb",e.colours)this.setColours(JSON.parse(e.colours));else if(pxt.appTarget.runtime&&pxt.appTarget.runtime.palette){let t,e=pxt.Util.clone(pxt.appTarget.runtime.palette);e[0]="#dedede",pxt.appTarget.runtime.paletteNames&&(t=pxt.Util.clone(pxt.appTarget.runtime.paletteNames),t[0]=lf("transparent")),this.setColours(e,t)}this.setValue(this.getColours_()[0]),e.columns&&this.setColumns(parseInt(e.columns)),e.className&&(this.className_=e.className),e.valueMode&&(this.valueMode_=e.valueMode)}applyColour(){var t,e,i,o,s,l;this.borderRect_?this.borderRect_.style.fill=this.value_:this.sourceBlock_&&(null===(i=null===(e=null===(t=this.sourceBlock_)||void 0===t?void 0:t.pathObject)||void 0===e?void 0:e.svgPath)||void 0===i||i.setAttribute("fill",this.value_),null===(l=null===(s=null===(o=this.sourceBlock_)||void 0===o?void 0:o.pathObject)||void 0===s?void 0:s.svgPath)||void 0===l||l.setAttribute("stroke","#fff"))}doClassValidation_(t){return"string"!=typeof t?null:i(t,this.getColours_())}getValue(t){if(t)return this.value_;switch(this.valueMode_){case"hex":return`"${this.value_}"`;case"rgb":return this.value_.indexOf("#")>-1?`0x${this.value_.replace(/^#/,"")}`:this.value_;case"index":if(!this.value_)return"-1";const t=this.getColours_();for(let e=0;e<t.length;e++)if(this.value_.toUpperCase()===t[e].toUpperCase())return e+""}return this.value_}doValueUpdate_(t){this.value_=i(t,this.getColours_()),this.applyColour()}showEditor_(){super.showEditor_(),this.className_&&this.picker_&&pxt.BrowserUtils.addClass(this.picker_,this.className_)}getColours_(){return this.colours_}}function i(t,e){if(t){const i=/Colors\.([a-zA-Z]+)/.exec(t),o=/(0x|#)([0-9a-fA-F]+)/.exec(t);if(i)switch(i[1].toLocaleLowerCase()){case"red":return"#FF0000";case"orange":return"#FF7F00";case"yellow":return"#FFFF00";case"green":return"#00FF00";case"blue":return"#0000FF";case"indigo":return"#4B0082";case"violet":return"#8A2BE2";case"purple":return"#A033E5";case"pink":return"#FF007F";case"white":return"#FFFFFF";case"black":return"#000000";default:return t}else if(o){const t=o[2];if(3===t.length){let e="#";for(let i=0;i<t.length;i++){const o=t.charAt(i);e+=o+o}return e}if(6===t.length)return"#"+t}if(e){const i=parseInt(t);return isNaN(i)||null==e[i]?e[0]:e[i]}}return t}t.FieldColorNumber=e}(pxtblockly||(pxtblockly={})),function(t){class e extends Blockly.FieldDropdown{constructor(e,i,o){super(i.data),this.isFieldCustom_=!0,this.buttonClick_=function(t){let e=t.target.getAttribute("data-value");null!==e&&(this.setValue(e),this.closeModal_&&(this.close(),this.closeModal_=!1))},this.buttonClickAndClose_=function(t){this.closeModal_=!0,this.buttonClick_(t)},this.columns_=parseInt(i.columns)||4,this.maxRows_=parseInt(i.maxRows)||0,this.width_=parseInt(i.width)||200,this.backgroundColour_=t.parseColour(i.colour),this.borderColour_=pxt.toolbox.fadeColor(this.backgroundColour_,.4,!1);let s={xOffset:parseInt(i.tooltipsXOffset)||15,yOffset:parseInt(i.tooltipsYOffset)||-10};this.tooltipConfig_=s,this.hasSearchBar_=!!i.hasSearchBar||!1,this.hideRect_=!!i.hideRect||!1}dispose(){super.dispose(),this.disposeTooltip(),this.disposeIntersectionObserver()}createTooltip_(){this.gridTooltip_||(this.gridTooltip_=document.createElement("div"),this.gridTooltip_.className="goog-tooltip blocklyGridPickerTooltip",this.gridTooltip_.style.position="absolute",this.gridTooltip_.style.display="none",this.gridTooltip_.style.visibility="hidden",document.body.appendChild(this.gridTooltip_))}populateTableContainer(t,e,i){pxsim.U.removeChildren(e),0==t.length&&(this.firstItem_=void 0);for(let i=0;i<t.length/this.columns_;i++){let o=this.populateRow(i,t,e);e.appendChild(o)}}populateRow(t,i,o){const s=this.columns_,l=document.createElement("div");l.className="blocklyGridPickerRow";for(let n=s*t;n<Math.min(s*t+s,i.length);n++){let t=i[n][0];const s=i[n][1],r=document.createElement("div");r.className="goog-menuitem goog-option",r.setAttribute("id",":"+n),r.setAttribute("role","menuitem"),r.style.userSelect="none",r.title=t.alt||t,r.setAttribute("data-value",s);const a=document.createElement("div");a.setAttribute("class","goog-menuitem-content"),a.title=t.alt||t,a.setAttribute("data-value",s);const c="object"==typeof t;let u=this.backgroundColour_;if(s==this.getValue()&&(r.setAttribute("aria-selected","true"),pxt.BrowserUtils.addClass(r,"goog-option-selected"),u=this.sourceBlock_.getColourTertiary(),this.selectedItemDom=r,c&&!this.shouldShowTooltips()&&this.updateSelectedBar_(t,s)),r.style.backgroundColor=u,r.style.borderColor=this.borderColour_,c){const i=new Image(t.width,t.height);i.setAttribute("draggable","false"),"IntersectionObserver"in window?(i.src=e.DEFAULT_IMG,i.setAttribute("data-src",t.src),this.observer.observe(i)):i.src=t.src,i.alt=t.alt||"",i.setAttribute("data-value",s),a.appendChild(i)}else a.textContent=t;if(this.shouldShowTooltips()){Blockly.bindEvent_(r,"click",this,this.buttonClickAndClose_);const t=this.sourceBlock_.RTL?-this.tooltipConfig_.xOffset:this.tooltipConfig_.xOffset,e=this.tooltipConfig_.yOffset;Blockly.bindEvent_(r,"mousemove",this,(i=>{if(c){this.gridTooltip_.style.top=`${i.clientY+e}px`,this.gridTooltip_.style.left=`${i.clientX+t}px`;const o=document.elementFromPoint(i.clientX,i.clientY),s=o.title||o.alt;this.gridTooltip_.textContent=s,this.gridTooltip_.style.visibility=s?"visible":"hidden",this.gridTooltip_.style.display=s?"":"none"}pxt.BrowserUtils.addClass(r,"goog-menuitem-highlight"),o.setAttribute("aria-activedescendant",r.id)})),Blockly.bindEvent_(r,"mouseout",this,(t=>{c&&(this.gridTooltip_.style.visibility="hidden",this.gridTooltip_.style.display="none"),pxt.BrowserUtils.removeClass(r,"goog-menuitem-highlight"),o.removeAttribute("aria-activedescendant")}))}else c?(this.selectedBar_.style.display="",Blockly.bindEvent_(r,"click",this,(e=>{if(this.closeModal_)this.buttonClick_(e);else{const e=o.getElementsByClassName("goog-menuitem-highlight");for(let t=0;t<e.length;t++)pxt.BrowserUtils.removeClass(e[t],"goog-menuitem-highlight");pxt.BrowserUtils.addClass(r,"goog-menuitem-highlight"),this.updateSelectedBar_(t,s)}}))):(Blockly.bindEvent_(r,"click",this,this.buttonClickAndClose_),Blockly.bindEvent_(r,"mouseup",this,this.buttonClickAndClose_));r.appendChild(a),l.appendChild(r),0==n&&(this.firstItem_=r)}return l}shouldShowRect_(){return!this.hideRect_&&!this.sourceBlock_.isShadow()}doClassValidation_(t){return t}close(){this.disposeTooltip(),Blockly.WidgetDiv.hideIfOwner(this),Blockly.Events.setGroup(!1)}getFirstItem(){return this.firstItem_}highlightFirstItem(t){let e=t.childNodes;if(e.length&&e[0].childNodes){for(let t=0;t<e.length;++t){let i=e[t].childNodes.length;for(let o=0;o<i;++o){const i=e[t].childNodes[o];pxt.BrowserUtils.removeClass(i,"goog-menuitem-highlight"),pxt.BrowserUtils.removeClass(i,"goog-option-selected")}}e[0].childNodes[0].className+=" goog-menuitem-highlight"}}highlightAndScrollSelected(t,e){this.selectedItemDom&&goog.style.scrollIntoContainerView(this.selectedItemDom,e,!0)}showEditor_(){Blockly.WidgetDiv.show(this,this.sourceBlock_.RTL,(()=>{this.onClose_()})),this.setupIntersectionObserver_(),this.createTooltip_();const t=document.createElement("div");this.positionMenu_(t)}positionMenu_(t){const e=Blockly.utils.getViewportBBox(),i=this.getAnchorDimensions_(),{paddingContainer:o,scrollContainer:s}=this.createWidget_(t),l={width:o.offsetWidth,height:o.offsetHeight},n=goog.dom.getViewportSize();this.width_>n.width&&(this.width_=n.width),t.style.width=this.width_+"px";let r=0;if(this.hasSearchBar_&&(r+=50),this.selectedBar_&&(r+=50),this.maxRows_){let e=t.children[0].offsetHeight*(this.maxRows_+.3);n.height<e+r&&(e=n.height-r),l.height>e&&(s.style.overflowY="auto",goog.style.setHeight(s,e),l.height=e)}l.height+=r,this.sourceBlock_.RTL&&Blockly.utils.uiMenu.adjustBBoxesForRTL(e,i,l),Blockly.WidgetDiv.positionWithAnchor(e,i,l,this.sourceBlock_.RTL),this.highlightAndScrollSelected(t,s)}shouldShowTooltips(){return!pxt.BrowserUtils.isMobile()}getAnchorDimensions_(){const t=this.getScaledBBox();return this.sourceBlock_.RTL?t.right+=Blockly.FieldDropdown.CHECKMARK_OVERHANG:t.left-=Blockly.FieldDropdown.CHECKMARK_OVERHANG,t}createWidget_(t){const e=Blockly.WidgetDiv.DIV,i=this.getOptions();t.setAttribute("role","menu"),t.setAttribute("aria-haspopup","true");const o=document.createElement("div"),s=document.createElement("div");if(s.style.border=`solid 1px ${this.borderColour_}`,t.style.backgroundColor=this.backgroundColour_,o.style.backgroundColor=this.backgroundColour_,s.style.backgroundColor=this.backgroundColour_,t.className="blocklyGridPickerMenu",o.className="blocklyGridPickerScroller",s.className="blocklyGridPickerPadder",s.appendChild(o),o.appendChild(t),e.appendChild(s),this.hasSearchBar_){const e=this.createSearchBar_(t,o,i);s.insertBefore(e,s.childNodes[0])}return this.shouldShowTooltips()||(this.selectedBar_=this.createSelectedBar_(),s.appendChild(this.selectedBar_)),this.populateTableContainer(i,t,o),{paddingContainer:s,scrollContainer:o}}createSearchBar_(t,e,i){const o=document.createElement("div");o.setAttribute("class","ui fluid icon input");const s=document.createElement("i");s.setAttribute("class","search icon");const l=document.createElement("input");return l.setAttribute("type","search"),l.setAttribute("id","search-bar"),l.setAttribute("class","blocklyGridPickerSearchBar"),l.setAttribute("placeholder",pxt.Util.lf("Search")),l.addEventListener("click",(()=>{l.focus(),l.setSelectionRange(0,l.value.length)})),l.addEventListener("keyup",pxt.Util.debounce((()=>{let o=l.value,s=new RegExp(o,"i"),n=i.filter((t=>{const e=t[0].alt,i=t[1];return e?s.test(e):s.test(i)}));this.populateTableContainer.bind(this)(n,t,e),o?this.highlightFirstItem(t):this.highlightAndScrollSelected(t,e),this.gridTooltip_.style.visibility="hidden",this.gridTooltip_.style.display="none"}),300,!1)),l.addEventListener("keyup",(e=>{if(13==e.which){const e=t.childNodes[0];if(e){const t=e.childNodes[0];t&&(this.closeModal_=!0,t.click())}}})),o.appendChild(l),o.appendChild(s),o}createSelectedBar_(){const t=document.createElement("div");t.setAttribute("class","blocklyGridPickerSelectedBar"),t.style.display="none";const i=document.createElement("div"),o=document.createElement("div");o.className="blocklyGridPickerSelectedImage",i.appendChild(o),this.selectedImg_=document.createElement("img"),this.selectedImg_.setAttribute("width","30px"),this.selectedImg_.setAttribute("height","30px"),this.selectedImg_.setAttribute("draggable","false"),this.selectedImg_.style.display="none",this.selectedImg_.src=e.DEFAULT_IMG,o.appendChild(this.selectedImg_),this.selectedBarText_=document.createElement("span"),this.selectedBarText_.className="blocklyGridPickerTooltip",i.appendChild(this.selectedBarText_);const s=document.createElement("div"),l=document.createElement("div");l.className="ui buttons mini",s.appendChild(l);const n=document.createElement("button");n.className="ui button icon green";const r=document.createElement("i");r.className="icon check",n.appendChild(r),Blockly.bindEvent_(n,"click",this,(()=>{this.setValue(this.selectedBarValue_),this.close()}));const a=document.createElement("button");a.className="ui button icon red";const c=document.createElement("i");return c.className="icon cancel",a.appendChild(c),Blockly.bindEvent_(a,"click",this,(()=>{this.close()})),l.appendChild(n),l.appendChild(a),t.appendChild(i),t.appendChild(s),t}updateSelectedBar_(t,e){t.src&&(this.selectedImg_.src=t.src,this.selectedImg_.style.display=""),this.selectedImg_.alt=t.alt||t,this.selectedBarText_.textContent=t.alt||t,this.selectedBarValue_=e}setupIntersectionObserver_(){if(!("IntersectionObserver"in window))return;this.disposeIntersectionObserver();this.observer=new IntersectionObserver((t=>{t.forEach((t=>{t.intersectionRatio>0&&(this.observer.unobserve(t.target),(t=>{const e=t.getAttribute("data-src");e&&(t.src=e,t.removeAttribute("data-src"))})(t.target))}))}),{rootMargin:"20px 0px",threshold:.01})}disposeIntersectionObserver(){this.observer&&(this.observer=null)}disposeTooltip(){this.gridTooltip_&&(pxsim.U.remove(this.gridTooltip_),this.gridTooltip_=null)}onClose_(){this.disposeTooltip()}}e.DEFAULT_IMG="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",t.FieldGridPicker=e}(pxtblockly||(pxtblockly={})),function(t){class e extends Blockly.FieldDropdown{constructor(e,i,o){super(i.data),this.isFieldCustom_=!0,this.buttonClick_=function(t){let e=t.target.getAttribute("data-value");e&&(this.setValue(e),Blockly.DropDownDiv.hide())},this.columns_=parseInt(i.columns),this.maxRows_=parseInt(i.maxRows)||0,this.width_=parseInt(i.width)||300,this.backgroundColour_=t.parseColour(i.colour),this.borderColour_=pxt.toolbox.fadeColor(this.backgroundColour_,.4,!1)}showEditor_(){if(Blockly.DropDownDiv.hideIfOwner(this))return;Blockly.DropDownDiv.hideWithoutAnimation(),Blockly.DropDownDiv.clearContent();let t=Blockly.DropDownDiv.getContentDiv(),e=document.createElement("div");e.setAttribute("role","menu"),e.setAttribute("aria-haspopup","true");const i=this.getOptions();let o=0;for(let t=0;t<i.length;t++){let s=i[t][0];const l=i[t][1];if("placeholder"==s.type){let t=document.createElement("span");t.setAttribute("class","blocklyDropDownPlaceholder"),t.style.width=s.width+"px",t.style.height=s.height+"px",e.appendChild(t);continue}let n=document.createElement("button");n.setAttribute("id",":"+t),n.setAttribute("role","menuitem"),n.setAttribute("class","blocklyDropDownButton"),n.title=s.alt;let r=s.height;this.columns_?(r=this.width_/this.columns_-8,n.style.width=r+"px",n.style.height=r+"px"):(n.style.width=s.width+"px",n.style.height=s.height+"px"),r>o&&(o=r);let a=this.backgroundColour_;l==this.getValue()&&(a=this.sourceBlock_.getColourTertiary(),n.setAttribute("aria-selected","true")),n.style.backgroundColor=a,n.style.borderColor=this.borderColour_,Blockly.bindEvent_(n,"click",this,this.buttonClick_),Blockly.bindEvent_(n,"mouseover",n,(function(){this.setAttribute("class","blocklyDropDownButton blocklyDropDownButtonHover"),e.setAttribute("aria-activedescendant",this.id)})),Blockly.bindEvent_(n,"mouseout",n,(function(){this.setAttribute("class","blocklyDropDownButton"),e.removeAttribute("aria-activedescendant")}));let c=document.createElement("img");c.src=s.src,n.setAttribute("data-value",l),c.setAttribute("data-value",l),n.appendChild(c),e.appendChild(n)}e.style.width=this.width_+"px",t.appendChild(e),this.maxRows_&&(t.style.maxHeight=(this.maxRows_+.4)*(o+8)+"px"),pxt.BrowserUtils.isFirefox()&&(t.style.paddingRight="20px"),Blockly.DropDownDiv.setColour(this.backgroundColour_,this.borderColour_),Blockly.DropDownDiv.showPositionedByField(this,this.onHide_.bind(this));let s=this.sourceBlock_;this.savedPrimary_=null==s?void 0:s.getColour(),(null==s?void 0:s.isShadow())?s.setColour(s.getColourTertiary()):this.borderRect_&&this.borderRect_.setAttribute("fill",s.getColourTertiary())}onHide_(){let t=Blockly.DropDownDiv.getContentDiv();t.removeAttribute("role"),t.removeAttribute("aria-haspopup"),t.removeAttribute("aria-activedescendant"),t.style.width="",t.style.paddingRight="",t.style.maxHeight="";let e=this.sourceBlock_;(null==e?void 0:e.isShadow())?this.sourceBlock_.setColour(this.savedPrimary_):this.borderRect_&&this.borderRect_.setAttribute("fill",this.savedPrimary_)}}t.FieldImageDropdown=e}(pxtblockly||(pxtblockly={})),function(t){class e extends t.FieldImageDropdown{constructor(t,e,i){super(t,e,i),this.isFieldCustom_=!0,this.shouldSort_=e.sort,this.addLabel_=!!e.addLabel}showEditor_(){if(Blockly.DropDownDiv.hideIfOwner(this))return;let t=this.sourceBlock_;Blockly.DropDownDiv.hideWithoutAnimation(),Blockly.DropDownDiv.clearContent();let e=Blockly.DropDownDiv.getContentDiv(),i=document.createElement("div");i.setAttribute("role","menu"),i.setAttribute("aria-haspopup","true");const o=this.getOptions();this.shouldSort_&&o.sort();for(let e=0;e<o.length;e++){const s=o[e][0],l=o[e][1];if("placeholder"==s.type){let t=document.createElement("span");t.setAttribute("class","blocklyDropDownPlaceholder"),t.style.width=s.width+"px",t.style.height=s.height+"px",i.appendChild(t);continue}let n=document.createElement("button");n.setAttribute("id",":"+e),n.setAttribute("role","menuitem"),n.setAttribute("class","blocklyDropDownButton"),n.title=s.alt,this.columns_?n.style.width=this.width_/this.columns_-8+"px":(n.style.width=s.width+"px",n.style.height=s.height+"px");let r=t.getColour();l==this.getValue()&&(r=t.getColourTertiary(),n.setAttribute("aria-selected","true")),n.style.backgroundColor=r,n.style.borderColor=t.getColourTertiary(),Blockly.bindEvent_(n,"click",this,this.buttonClick_),Blockly.bindEvent_(n,"mouseover",n,(function(){this.setAttribute("class","blocklyDropDownButton blocklyDropDownButtonHover"),i.setAttribute("aria-activedescendant",this.id)})),Blockly.bindEvent_(n,"mouseout",n,(function(){this.setAttribute("class","blocklyDropDownButton"),i.removeAttribute("aria-activedescendant")}));let a=document.createElement("img");if(a.src=s.src,n.setAttribute("data-value",l),a.setAttribute("data-value",l),n.appendChild(a),this.addLabel_){const t=this.createTextNode_(s.alt);t.setAttribute("data-value",l),n.appendChild(t)}i.appendChild(n)}i.style.width=this.width_+"px",e.appendChild(i),Blockly.DropDownDiv.setColour(t.getColour(),t.getColourTertiary()),Blockly.DropDownDiv.showPositionedByField(this,this.onHideCallback.bind(this)),this.savedPrimary_=null==t?void 0:t.getColour(),(null==t?void 0:t.isShadow())?t.setColour(t.style.colourTertiary):this.borderRect_&&this.borderRect_.setAttribute("fill",t.style.colourTertiary)}onHideCallback(){let t=this.sourceBlock_;(null==t?void 0:t.isShadow())?t.setColour(this.savedPrimary_):this.borderRect_&&this.borderRect_.setAttribute("fill",this.savedPrimary_)}createTextNode_(t){const e=document.createElement("span");return e.setAttribute("class","blocklyDropdownTextLabel"),e.textContent=t,e}}t.FieldImages=e}(pxtblockly||(pxtblockly={})),function(t){class e extends Blockly.FieldDropdown{constructor(t){super(function(t){return function(){const e=[],i=this;if(i.sourceBlock_&&i.sourceBlock_.workspace){i.sourceBlock_.workspace.getVariablesOfType(l(t.name)).forEach((t=>{e.push([t.name,t.name])}))}else t.initialMembers.forEach((t=>e.push([t,t])));return e.push([lf("Add a new {0}...",t.memberName),"CREATE"]),e}}(t)),this.opts=t}initView(){super.initView(),this.initVariables()}onItemSelected_(t,e){"CREATE"===e.getValue()?i(this.sourceBlock_.workspace,this.opts,lf("New {0}:",this.opts.memberName),(t=>t&&this.setValue(t))):super.onItemSelected_(t,e)}doClassValidation_(t){var e;return(null===(e=this.opts)||void 0===e?void 0:e.initialMembers)&&!this.opts.initialMembers.find((e=>e==t))&&this.getOptions(),super.doClassValidation_(t)}initVariables(){if(this.sourceBlock_&&this.sourceBlock_.workspace){const t=this.sourceBlock_.workspace,e=o(t,this.opts.name);this.opts.initialMembers.forEach((i=>{-1===e.indexOf(i)&&s(t,this.opts,i)})),"CREATE"===this.getValue()&&this.opts.initialMembers.length&&this.setValue(this.opts.initialMembers[0])}}}function i(t,e,l,n){Blockly.prompt(l,null,(r=>{if(r){let a=!1;if(pxtc.isIdentifierStart(r.charCodeAt(0),2)){a=!0;for(let t=1;t<r.length;t++)pxtc.isIdentifierPart(r.charCodeAt(t),2)||(a=!1)}if(!a)return void Blockly.alert(lf("Names must start with a letter and can only contain letters, numbers, '$', and '_'."),(()=>i(t,e,l,n)));if(pxt.blocks.isReservedWord(r))return void Blockly.alert(lf("'{0}' is a reserved word and cannot be used.",r),(()=>i(t,e,l,n)));const c=o(t,e.name);for(let o=0;o<c.length;o++){if(c[o]===r)return void Blockly.alert(lf("A {0} named '{1}' already exists.",e.memberName,r),(()=>i(t,e,l,n)))}r===e.createFunctionName&&Blockly.alert(lf("'{0}' is a reserved name.",e.createFunctionName),(()=>i(t,e,l,n))),n(s(t,e,r))}}),{placeholder:e.promptHint})}function o(t,e){const i=t.getVariablesOfType(l(e));return i&&i.length?i.map((t=>t.name)):[]}function s(t,e,i){return Blockly.Variables.getOrCreateVariablePackage(t,null,i,l(e.name)),i}function l(t){return"KIND_"+t}t.FieldKind=e}(pxtblockly||(pxtblockly={}));const rowRegex=/^.*[\.#].*$/;var LabelMode,pxtblockly;!function(t){t[t.None=0]="None",t[t.Number=1]="Number",t[t.Letter=2]="Letter"}(LabelMode||(LabelMode={})),function(t){class e extends Blockly.Field{constructor(t,e,i){if(super(t,i),this.isFieldCustom_=!0,this.SERIALIZABLE=!0,this.onColor="#FFFFFF",this.scale=1,this.matrixWidth=5,this.matrixHeight=5,this.yAxisLabel=LabelMode.None,this.xAxisLabel=LabelMode.None,this.cellState=[],this.cells=[],this.dontHandleMouseEvent_=t=>{t.stopPropagation(),t.preventDefault()},this.clearLedDragHandler=t=>{const e=this.sourceBlock_.getSvgRoot();pxsim.pointerEvents.down.forEach((t=>e.removeEventListener(t,this.dontHandleMouseEvent_))),e.removeEventListener(pxsim.pointerEvents.move,this.dontHandleMouseEvent_),document.removeEventListener(pxsim.pointerEvents.up,this.clearLedDragHandler),document.removeEventListener(pxsim.pointerEvents.leave,this.clearLedDragHandler),Blockly.Touch.clearTouchIdentifier(),this.elt.removeEventListener(pxsim.pointerEvents.move,this.handleRootMouseMoveListener),t.stopPropagation(),t.preventDefault()},this.toggleRect=(t,e)=>{this.cellState[t][e]=this.currentDragState_,this.updateValue()},this.handleRootMouseMoveListener=t=>{let e,i;t.changedTouches&&1==t.changedTouches.length?(e=t.changedTouches[0].clientX,i=t.changedTouches[0].clientY):(e=t.clientX,i=t.clientY);const o=document.elementFromPoint(e,i);if(!o)return;const s=o.getAttribute("data-x"),l=o.getAttribute("data-y");null!=s&&null!=l&&this.toggleRect(parseInt(s),parseInt(l))},this.params=e,void 0!==this.params.rows){let t=parseInt(this.params.rows);isNaN(t)||(this.matrixHeight=t)}if(void 0!==this.params.columns){let t=parseInt(this.params.columns);isNaN(t)||(this.matrixWidth=t)}void 0!==this.params.onColor&&(this.onColor=this.params.onColor),void 0!==this.params.offColor&&(this.offColor=this.params.offColor),void 0!==this.params.scale?this.scale=Math.max(.6,Math.min(2,Number(this.params.scale))):Math.max(this.matrixWidth,this.matrixHeight)>15?this.scale=.85:Math.max(this.matrixWidth,this.matrixHeight)>10&&(this.scale=.9)}showEditor_(){}initMatrix(){if(!this.sourceBlock_.isInsertionMarker()){this.elt=pxsim.svg.parseString('<svg xmlns="http://www.w3.org/2000/svg" id="field-matrix" />');for(let t=0;t<this.matrixWidth;t++){this.cellState.push([]),this.cells.push([]);for(let e=0;e<this.matrixHeight;e++)this.cellState[t].push(!1)}this.restoreStateFromString();for(let t=0;t<this.matrixWidth;t++)for(let e=0;e<this.matrixHeight;e++)this.createCell(t,e);if(this.updateValue(),this.xAxisLabel!==LabelMode.None){const t=this.scale*this.matrixHeight*(e.CELL_WIDTH+e.CELL_VERTICAL_MARGIN)+2*e.CELL_VERTICAL_MARGIN+e.BOTTOM_MARGIN,i=pxsim.svg.child(this.elt,"g",{transform:`translate(0 ${t})`});for(let t=0;t<this.matrixWidth;t++){const o=this.getYAxisWidth()+this.scale*t*(e.CELL_WIDTH+e.CELL_HORIZONTAL_MARGIN)+e.CELL_WIDTH/2+e.CELL_HORIZONTAL_MARGIN/2;pxsim.svg.child(i,"text",{x:o,class:"blocklyText"}).textContent=this.getLabel(t,this.xAxisLabel)}}if(this.yAxisLabel!==LabelMode.None){const t=pxsim.svg.child(this.elt,"g",{});for(let i=0;i<this.matrixHeight;i++){const o=this.scale*i*(e.CELL_WIDTH+e.CELL_VERTICAL_MARGIN)+e.CELL_WIDTH/2+2*e.CELL_VERTICAL_MARGIN;pxsim.svg.child(t,"text",{x:0,y:o,class:"blocklyText"}).textContent=this.getLabel(i,this.yAxisLabel)}}this.fieldGroup_.replaceChild(this.elt,this.fieldGroup_.firstChild)}}getLabel(t,e){switch(e){case LabelMode.Letter:return String.fromCharCode(t+65);default:return(t+1).toString()}}createCell(t,i){const o=this.scale*t*(e.CELL_WIDTH+e.CELL_HORIZONTAL_MARGIN)+e.CELL_HORIZONTAL_MARGIN+this.getYAxisWidth(),s=this.scale*i*(e.CELL_WIDTH+e.CELL_VERTICAL_MARGIN)+e.CELL_VERTICAL_MARGIN,l=pxsim.svg.child(this.elt,"g",{transform:`translate(${o} ${s})`}),n=pxsim.svg.child(l,"rect",{class:"blocklyLed"+(this.cellState[t][i]?"On":"Off"),cursor:"pointer",width:this.scale*e.CELL_WIDTH,height:this.scale*e.CELL_WIDTH,fill:this.getColor(t,i),"data-x":t,"data-y":i,rx:Math.max(2,this.scale*e.CELL_CORNER_RADIUS)});this.cells[t][i]=n,this.sourceBlock_.workspace.isFlyout||pxsim.pointerEvents.down.forEach((e=>n.addEventListener(e,(e=>{const o=this.sourceBlock_.getSvgRoot();this.currentDragState_=!this.cellState[t][i],Blockly.hideChaff(),this.sourceBlock_.select(),this.toggleRect(t,i),pxsim.pointerEvents.down.forEach((t=>o.addEventListener(t,this.dontHandleMouseEvent_))),o.addEventListener(pxsim.pointerEvents.move,this.dontHandleMouseEvent_),document.addEventListener(pxsim.pointerEvents.up,this.clearLedDragHandler),document.addEventListener(pxsim.pointerEvents.leave,this.clearLedDragHandler),this.elt.addEventListener(pxsim.pointerEvents.move,this.handleRootMouseMoveListener),e.stopPropagation(),e.preventDefault()}),!1)))}getColor(t,i){return this.cellState[t][i]?this.onColor:this.offColor||e.DEFAULT_OFF_COLOR}getOpacity(t,e){return this.cellState[t][e]?"1.0":"0.2"}updateCell(t,e){const i=this.cells[t][e];i.setAttribute("fill",this.getColor(t,e)),i.setAttribute("fill-opacity",this.getOpacity(t,e)),i.setAttribute("class","blocklyLed"+(this.cellState[t][e]?"On":"Off"))}setValue(t,e=!0){if(super.setValue(String(t)),this.elt){e&&this.restoreStateFromString();for(let t=0;t<this.matrixWidth;t++)for(let e=0;e<this.matrixHeight;e++)this.updateCell(t,e)}}render_(){this.visible_?(this.elt||this.initMatrix(),this.size_.height=this.scale*Number(this.matrixHeight)*(e.CELL_WIDTH+e.CELL_VERTICAL_MARGIN)+2*e.CELL_VERTICAL_MARGIN+e.BOTTOM_MARGIN+this.getXAxisHeight(),this.size_.width=this.scale*Number(this.matrixWidth)*(e.CELL_WIDTH+e.CELL_HORIZONTAL_MARGIN)+this.getYAxisWidth()):this.markDirty()}getValue(){let t=function(t){const e=(t=(t||"").trim()).charAt(0);if(e===t.charAt(t.length-1)&&-1!==o.indexOf(e))return t.substr(1,t.length-2).trim();return t}(this.value_);return`\`\n${e.TAB}${t}\n${e.TAB}\``}restoreStateFromString(){let t=this.value_;if(t){const o=t.split("\n").filter((t=>rowRegex.test(t)));for(let t=0;t<o.length&&t<this.matrixHeight;t++){let s=0;const l=o[t];for(let o=0;o<l.length&&s<this.matrixWidth;o++)"."===(e=l[o])||"_"===e||"0"===e?(this.cellState[s][t]=!1,s++):i(l[o])&&(this.cellState[s][t]=!0,s++)}}var e}updateValue(){let t="";for(let i=0;i<this.matrixHeight;i++){for(let e=0;e<this.matrixWidth;e++)t+=(this.cellState[e][i]?"#":".")+" ";t+="\n"+e.TAB}this.setValue(t,!1)}getYAxisWidth(){return this.yAxisLabel===LabelMode.None?0:e.Y_AXIS_WIDTH}getXAxisHeight(){return this.xAxisLabel===LabelMode.None?0:e.X_AXIS_HEIGHT}}function i(t){return"#"===t||"*"===t||"1"===t}e.CELL_WIDTH=25,e.CELL_HORIZONTAL_MARGIN=7,e.CELL_VERTICAL_MARGIN=5,e.CELL_CORNER_RADIUS=5,e.BOTTOM_MARGIN=9,e.Y_AXIS_WIDTH=9,e.X_AXIS_HEIGHT=10,e.TAB="        ",e.DEFAULT_OFF_COLOR="#000000",t.FieldMatrix=e;const o=["'",'"',"`"]}(pxtblockly||(pxtblockly={})),function(t){var e=pxt.svgUtil;t.HEADER_HEIGHT=50,t.TOTAL_WIDTH=300;class i extends Blockly.Field{constructor(t,e,i){super(t,i),this.isFieldCustom_=!0,this.SERIALIZABLE=!0,this.soundingKeys=0,this.numRow=8,this.numCol=8,this.tempo=120,this.isPlaying=!1,this.timeouts=[],this.params=e,this.createMelodyIfDoesntExist()}init(){super.init(),this.onInit()}showEditor_(){Blockly.DropDownDiv.hideWithoutAnimation(),Blockly.DropDownDiv.clearContent(),Blockly.DropDownDiv.setColour(this.getDropdownBackgroundColour(),this.getDropdownBorderColour());let t=Blockly.DropDownDiv.getContentDiv();pxt.BrowserUtils.addClass(t,"melody-content-div"),pxt.BrowserUtils.addClass(t.parentElement,"melody-editor-dropdown"),this.gallery=new pxtmelody.MelodyGallery,this.renderEditor(t),this.prevString=this.getValue(),Blockly.Events.fire(new Blockly.Events.Ui(this.sourceBlock_,"melody-editor",!1,!0)),Blockly.DropDownDiv.showPositionedByBlock(this,this.sourceBlock_,(()=>{this.onEditorClose(),pxt.BrowserUtils.removeClass(t,"melody-content-div"),pxt.BrowserUtils.removeClass(t.parentElement,"melody-editor-dropdown"),Blockly.Events.fire(new Blockly.Events.Ui(this.sourceBlock_,"melody-editor",!0,!1))}))}getValue(){return this.stringRep=this.getTypeScriptValue(),this.stringRep}doValueUpdate_(t){null==t||""==t||'""'==t||this.stringRep&&this.stringRep===t||(this.stringRep=t,this.parseTypeScriptValue(t),super.doValueUpdate_(this.getValue()))}getText_(){return this.invalidString?pxt.Util.lf("Invalid Input"):this.getValue()}onInit(){this.render_(),this.createMelodyIfDoesntExist(),this.invalidString||(this.fieldGroup_||(this.fieldGroup_=Blockly.utils.dom.createSvgElement("g",{},null)),this.visible_||(this.fieldGroup_.style.display="none"),this.sourceBlock_.getSvgRoot().appendChild(this.fieldGroup_),this.updateFieldLabel())}render_(){super.render_(),this.invalidString||(this.size_.width=i.MUSIC_ICON_WIDTH+(i.COLOR_BLOCK_WIDTH+i.COLOR_BLOCK_SPACING)*this.numCol),this.sourceBlock_.setColour("#ffffff")}renderEditor(i){let o=this.getDropdownBackgroundColour(),s=this.getDropdownBorderColour();this.topDiv=document.createElement("div"),pxt.BrowserUtils.addClass(this.topDiv,"melody-top-bar-div"),this.root=new e.SVG(this.topDiv).id("melody-editor-header-controls"),this.toggle=new l(this.root,{leftText:lf("Editor"),rightText:lf("Gallery"),baseColor:o}),this.toggle.onStateChange((t=>{t?this.hideGallery():this.showGallery()})),this.toggle.layout(),this.toggle.translate((t.TOTAL_WIDTH-this.toggle.width())/2,0),i.appendChild(this.topDiv),i.appendChild(this.gallery.getElement()),this.editorDiv=document.createElement("div"),pxt.BrowserUtils.addClass(this.editorDiv,"melody-editor-div"),this.editorDiv.style.setProperty("background-color",s),this.gridDiv=this.createGridDisplay(),this.editorDiv.appendChild(this.gridDiv),this.bottomDiv=document.createElement("div"),pxt.BrowserUtils.addClass(this.bottomDiv,"melody-bottom-bar-div"),this.doneButton=document.createElement("button"),pxt.BrowserUtils.addClass(this.doneButton,"melody-confirm-button"),this.doneButton.innerText=lf("Done"),this.doneButton.addEventListener("click",(()=>this.onDone())),this.doneButton.style.setProperty("background-color",o),this.playButton=document.createElement("button"),this.playButton.id="melody-play-button",this.playButton.addEventListener("click",(()=>this.togglePlay())),this.playIcon=document.createElement("i"),this.playIcon.id="melody-play-icon",pxt.BrowserUtils.addClass(this.playIcon,"play icon"),this.playButton.appendChild(this.playIcon),this.tempoInput=document.createElement("input"),pxt.BrowserUtils.addClass(this.tempoInput,"ui input"),this.tempoInput.type="number",this.tempoInput.title=lf("tempo"),this.tempoInput.id="melody-tempo-input",this.tempoInput.addEventListener("input",(()=>this.setTempo(+this.tempoInput.value))),this.syncTempoField(!0),this.bottomDiv.appendChild(this.tempoInput),this.bottomDiv.appendChild(this.playButton),this.bottomDiv.appendChild(this.doneButton),this.editorDiv.appendChild(this.bottomDiv),i.appendChild(this.editorDiv)}onEditorClose(){this.stopMelody(),this.gallery&&this.gallery.stopMelody(),this.clearDomReferences(),this.sourceBlock_&&Blockly.Events.isEnabled()&&this.getValue()!==this.prevString&&Blockly.Events.fire(new Blockly.Events.BlockChange(this.sourceBlock_,"field",this.name,this.prevString,this.getValue())),this.prevString=void 0}onDone(){Blockly.DropDownDiv.hideIfOwner(this),this.onEditorClose()}clearDomReferences(){this.topDiv=null,this.editorDiv=null,this.gridDiv=null,this.bottomDiv=null,this.doneButton=null,this.playButton=null,this.playIcon=null,this.tempoInput=null,this.elt=null,this.cells=null,this.toggle=null,this.root=null,this.gallery.clearDomReferences()}getTypeScriptValue(){return this.invalidString?this.invalidString:this.melody?'"'+this.melody.getStringRepresentation()+'"':""}parseTypeScriptValue(t){let e=t;try{t=(t=t.slice(1,-1)).trim(),this.createMelodyIfDoesntExist();let e=t.split(" ");e.forEach((t=>{if(!this.isValidNote(t))throw new Error(lf("Invalid note '{0}'. Notes can be C D E F G A B C5",t))})),this.melody.resetMelody();for(let t=0;t<e.length;t++)if("-"!=e[t]){let i=pxtmelody.noteToRow(e[t]);this.melody.updateMelody(i,t)}this.updateFieldLabel()}catch(t){pxt.log(t),this.invalidString=e}}isValidNote(t){switch(t){case"C":case"D":case"E":case"F":case"G":case"A":case"B":case"C5":case"-":return!0}return!1}getPreviewWidth(){return this.updateSize_(),this.size_.width}getPreviewHeight(){return this.constants_.FIELD_BORDER_RECT_HEIGHT}getDropdownBackgroundColour(){return this.sourceBlock_.parentBlock_?this.sourceBlock_.parentBlock_.getColour():"#3D3D3D"}getDropdownBorderColour(){return this.sourceBlock_.parentBlock_?this.sourceBlock_.parentBlock_.getColourTertiary():"#2A2A2A"}updateFieldLabel(){if(!this.fieldGroup_)return;pxsim.U.clear(this.fieldGroup_);let t=n("").appendClass("melody-editor-field-icon").at(6,15);this.fieldGroup_.appendChild(t.el);let o=this.melody.getStringRepresentation().trim().split(" ");for(let t=0;t<o.length;t++){let s=pxtmelody.getColorClass(pxtmelody.noteToRow(o[t]));const l=(new e.Rect).at((i.COLOR_BLOCK_WIDTH+i.COLOR_BLOCK_SPACING)*t+i.COLOR_BLOCK_X,i.COLOR_BLOCK_Y).size(i.COLOR_BLOCK_WIDTH,i.COLOR_BLOCK_HEIGHT).stroke("#898989",1).corners(3,2);pxt.BrowserUtils.addClass(l.el,s),this.fieldGroup_.appendChild(l.el)}}setTempo(t){(isNaN(t)||t<=0)&&this.tempoInput?this.tempoInput.value=this.tempo+"":this.tempo!=t&&(this.tempo=t,this.melody&&this.melody.setTempo(this.tempo),this.tempoInput&&(this.tempoInput.value=this.tempo+""),this.syncTempoField(!1))}syncTempoField(t){const e=this.sourceBlock_;if(e.parentBlock_){const i=e.parentBlock_;for(const e of i.inputList)if("tempo"===e.name){const i=e.connection.targetBlock();i&&(t?i.getFieldValue("SLIDER")?(this.tempoInput.value=i.getFieldValue("SLIDER"),this.tempo=+this.tempoInput.value):this.tempoInput.value=this.tempo+"":("math_number_minmax"===i.type?i.setFieldValue(this.tempoInput.value,"SLIDER"):i.setFieldValue(this.tempoInput.value,"NUM"),this.tempoInput.focus()));break}}}getDuration(){return 6e4/this.tempo}createMelodyIfDoesntExist(){return!this.melody&&(this.melody=new pxtmelody.MelodyArray,!0)}onNoteSelect(t,e){this.invalidString=null,this.melody.updateMelody(t,e),this.melody.getValue(t,e)&&!this.isPlaying&&this.playNote(t,e),this.updateGrid(),this.updateFieldLabel()}updateGrid(){for(let t=0;t<this.numRow;t++){const e=pxtmelody.getColorClass(t);for(let i=0;i<this.numCol;i++){const o=this.cells[t][i];this.melody.getValue(t,i)?(pxt.BrowserUtils.removeClass(o,"melody-default"),pxt.BrowserUtils.addClass(o,e)):(pxt.BrowserUtils.addClass(o,"melody-default"),pxt.BrowserUtils.removeClass(o,e))}}}playNote(t,e){let i=++this.soundingKeys;this.isPlaying?(this.timeouts.push(setTimeout((()=>{this.playToneCore(t)}),e*this.getDuration())),this.timeouts.push(setTimeout((()=>{pxt.AudioContextManager.stop()}),(e+1)*this.getDuration()))):(this.playToneCore(t),this.timeouts.push(setTimeout((()=>{this.soundingKeys==i&&pxt.AudioContextManager.stop()}),this.getDuration())))}queueToneForColumn(t,e,i){const o=setTimeout((()=>{++this.soundingKeys,pxt.AudioContextManager.stop();for(let e=0;e<this.numRow;e++)this.melody.getValue(e,t)&&this.playToneCore(e);this.highlightColumn(t,!0),this.timeouts=this.timeouts.filter((t=>t!==o))}),e),s=setTimeout((()=>{this.timeouts=this.timeouts.filter((t=>t!==s)),this.highlightColumn(t,!1)}),e+i);this.timeouts.push(o),this.timeouts.push(s)}playToneCore(t){let e=0;switch(t){case 0:e=523;break;case 1:e=494;break;case 2:e=440;break;case 3:e=392;break;case 4:e=349;break;case 5:e=330;break;case 6:e=294;break;case 7:e=262}pxt.AudioContextManager.tone(e)}highlightColumn(t,e){this.cells.map((e=>e[t])).forEach((t=>{e?pxt.BrowserUtils.addClass(t,"playing"):pxt.BrowserUtils.removeClass(t,"playing")}))}createGridDisplay(){i.VIEWBOX_WIDTH=(i.CELL_WIDTH+i.CELL_VERTICAL_MARGIN)*this.numCol+i.CELL_VERTICAL_MARGIN,pxt.BrowserUtils.isEdge()&&(i.VIEWBOX_WIDTH+=37),i.VIEWBOX_HEIGHT=(i.CELL_WIDTH+i.CELL_HORIZONTAL_MARGIN)*this.numRow+i.CELL_HORIZONTAL_MARGIN,this.elt=pxsim.svg.parseString(`<svg xmlns="http://www.w3.org/2000/svg" class="melody-grid-div" viewBox="0 0 ${i.VIEWBOX_WIDTH} ${i.VIEWBOX_HEIGHT}"/>`),this.cells=[];for(let t=0;t<this.numRow;t++)this.cells.push([]);for(let t=0;t<this.numRow;t++)for(let e=0;e<this.numCol;e++)this.createCell(t,e);return this.elt}createCell(t,e){const o=t*(i.CELL_WIDTH+i.CELL_HORIZONTAL_MARGIN)+i.CELL_HORIZONTAL_MARGIN,s=e*(i.CELL_WIDTH+i.CELL_VERTICAL_MARGIN)+i.CELL_VERTICAL_MARGIN,l=pxsim.svg.child(this.elt,"g",{transform:`translate(${s} ${o})`}),n=pxsim.svg.child(l,"rect",{cursor:"pointer",width:i.CELL_WIDTH,height:i.CELL_WIDTH,stroke:"white","data-x":t,"data-y":e,rx:i.CELL_CORNER_RADIUS});this.melody.getValue(t,e)?pxt.BrowserUtils.addClass(n,pxtmelody.getColorClass(t)):pxt.BrowserUtils.addClass(n,"melody-default"),this.sourceBlock_.workspace.isFlyout||(pxsim.pointerEvents.down.forEach((i=>n.addEventListener(i,(i=>{this.onNoteSelect(t,e),i.stopPropagation(),i.preventDefault()}),!1))),this.cells[t][e]=n)}togglePlay(){this.isPlaying?this.stopMelody():(this.isPlaying=!0,this.playMelody()),this.updatePlayButton()}updatePlayButton(){this.isPlaying?(pxt.BrowserUtils.removeClass(this.playIcon,"play icon"),pxt.BrowserUtils.addClass(this.playIcon,"stop icon")):(pxt.BrowserUtils.removeClass(this.playIcon,"stop icon"),pxt.BrowserUtils.addClass(this.playIcon,"play icon"))}playMelody(){if(this.isPlaying){for(let t=0;t<this.numCol;t++)this.queueToneForColumn(t,t*this.getDuration(),this.getDuration());this.timeouts.push(setTimeout((()=>this.playMelody()),this.numCol*this.getDuration()))}else this.stopMelody()}stopMelody(){if(this.isPlaying){for(;this.timeouts.length;)clearTimeout(this.timeouts.shift());pxt.AudioContextManager.stop(),this.isPlaying=!1,this.cells.forEach((t=>t.forEach((t=>pxt.BrowserUtils.removeClass(t,"playing")))))}}showGallery(){this.stopMelody(),this.updatePlayButton(),this.gallery.show((t=>{t&&(this.melody.parseNotes(t),this.gallery.hide(),this.toggle.toggle(),this.updateFieldLabel(),this.updateGrid())}))}hideGallery(){this.gallery.hide()}}i.CELL_WIDTH=25,i.CELL_HORIZONTAL_MARGIN=7,i.CELL_VERTICAL_MARGIN=5,i.CELL_CORNER_RADIUS=5,i.COLOR_BLOCK_WIDTH=10,i.COLOR_BLOCK_HEIGHT=20,i.COLOR_BLOCK_X=20,i.COLOR_BLOCK_Y=5,i.COLOR_BLOCK_SPACING=2,i.MUSIC_ICON_WIDTH=20,t.FieldCustomMelody=i;const o=200,s=40;class l{constructor(t,e){this.props=function(t){t.baseColor||(t.baseColor="#e95153");t.backgroundColor||(t.backgroundColor="rgba(52,73,94,.2)");t.borderColor||(t.borderColor="rgba(52,73,94,.4)");t.selectedTextColor||(t.selectedTextColor=t.baseColor);t.unselectedTextColor||(t.unselectedTextColor="hsla(0,0%,100%,.9)");t.switchColor||(t.switchColor="#ffffff");return t}(e),this.root=t.group(),this.buildDom(),this.isLeft=!0}buildDom(){this.root.style().content("\n            .toggle-left {\n                transform: translateX(0px);\n                animation: mvleft 0.2s 0s ease;\n            }\n\n            .toggle-right {\n                transform: translateX(100px);\n                animation: mvright 0.2s 0s ease;\n            }\n\n            @keyframes mvright {\n                0% {\n                    transform: translateX(0px);\n                }\n                100% {\n                    transform: translateX(100px);\n                }\n            }\n\n            @keyframes mvleft {\n                0% {\n                    transform: translateX(100px);\n                }\n                100% {\n                    transform: translateX(0px);\n                }\n            }\n            ");this.root.def().create("clipPath","sprite-editor-toggle-border").clipPathUnits(!0).draw("rect").at(0,0).corners(.02,.1).size(1,1),this.root.draw("rect").size(o,s).fill(this.props.baseColor).stroke(this.props.borderColor,4).corners(4,4).clipPath("url(#sprite-editor-toggle-border)"),this.root.draw("rect").at(2,2).size(196,36).fill(this.props.backgroundColor).corners(4,4),this.switch=this.root.draw("rect").at(2,2).size(98,36).fill(this.props.switchColor).corners(4,4),this.leftElement=this.root.group(),this.leftText=n(this.props.leftText).appendClass("sprite-editor-text").fill(this.props.selectedTextColor),this.leftElement.appendChild(this.leftText),this.rightElement=this.root.group(),this.rightText=n(this.props.rightText).appendClass("sprite-editor-text").fill(this.props.unselectedTextColor),this.rightElement.appendChild(this.rightText),this.root.onClick((()=>this.toggle()))}toggle(t=!1){this.isLeft?(this.switch.removeClass("toggle-left"),this.switch.appendClass("toggle-right"),this.leftText.fill(this.props.unselectedTextColor),this.rightText.fill(this.props.selectedTextColor)):(this.switch.removeClass("toggle-right"),this.switch.appendClass("toggle-left"),this.leftText.fill(this.props.selectedTextColor),this.rightText.fill(this.props.unselectedTextColor)),this.isLeft=!this.isLeft,!t&&this.changeHandler&&this.changeHandler(this.isLeft)}onStateChange(t){this.changeHandler=t}layout(){this.leftText.moveTo(51,20),this.rightText.moveTo(149,20)}translate(t,e){this.root.translate(t,e)}height(){return s}width(){return o}}function n(t){return new e.Text(t).anchor("middle").setAttribute("dominant-baseline","middle").setAttribute("dy",pxt.BrowserUtils.isIE()||pxt.BrowserUtils.isEdge()?"0.3em":"0.1em")}}(pxtblockly||(pxtblockly={})),function(t){let e;!function(t){t[t.C=262]="C",t[t.CSharp=277]="CSharp",t[t.D=294]="D",t[t.Eb=311]="Eb",t[t.E=330]="E",t[t.F=349]="F",t[t.FSharp=370]="FSharp",t[t.G=392]="G",t[t.GSharp=415]="GSharp",t[t.A=440]="A",t[t.Bb=466]="Bb",t[t.B=494]="B",t[t.C3=131]="C3",t[t.CSharp3=139]="CSharp3",t[t.D3=147]="D3",t[t.Eb3=156]="Eb3",t[t.E3=165]="E3",t[t.F3=175]="F3",t[t.FSharp3=185]="FSharp3",t[t.G3=196]="G3",t[t.GSharp3=208]="GSharp3",t[t.A3=220]="A3",t[t.Bb3=233]="Bb3",t[t.B3=247]="B3",t[t.C4=262]="C4",t[t.CSharp4=277]="CSharp4",t[t.D4=294]="D4",t[t.Eb4=311]="Eb4",t[t.E4=330]="E4",t[t.F4=349]="F4",t[t.FSharp4=370]="FSharp4",t[t.G4=392]="G4",t[t.GSharp4=415]="GSharp4",t[t.A4=440]="A4",t[t.Bb4=466]="Bb4",t[t.B4=494]="B4",t[t.C5=523]="C5",t[t.CSharp5=555]="CSharp5",t[t.D5=587]="D5",t[t.Eb5=622]="Eb5",t[t.E5=659]="E5",t[t.F5=698]="F5",t[t.FSharp5=740]="FSharp5",t[t.G5=784]="G5",t[t.GSharp5=831]="GSharp5",t[t.A5=880]="A5",t[t.Bb5=932]="Bb5",t[t.B5=988]="B5",t[t.C6=1047]="C6",t[t.CSharp6=1109]="CSharp6",t[t.D6=1175]="D6",t[t.Eb6=1245]="Eb6",t[t.E6=1319]="E6",t[t.F6=1397]="F6",t[t.FSharp6=1480]="FSharp6",t[t.G6=1568]="G6",t[t.GSharp6=1568]="GSharp6",t[t.A6=1760]="A6",t[t.Bb6=1865]="Bb6",t[t.B6=1976]="B6",t[t.C7=2093]="C7"}(e||(e={}));class i extends Blockly.FieldNumber{constructor(e,i,o){super(null,0,null,null,o),this.isFieldCustom_=!0,this.SERIALIZABLE=!0,this.isTextValid_=!0,this.nKeys_=36,this.minNote_=28,this.maxNote_=63,this.eps=2,this.setSpellcheck(!1),this.prepareNotes(),this.isExpanded=!1,this.currentPage=0,this.totalPlayCount=0,i.editorColour&&(this.primaryColour=t.parseColour(i.editorColour),this.borderColour=Blockly.utils.colour.darken(this.primaryColour,.2));const s=parseInt(i.eps);!Number.isNaN(s)&&s>=0&&(this.eps=s);const l=parseInt(i.minNote)||this.minNote_,n=parseInt(i.maxNote)||this.maxNote_;l>=28&&n<=75&&n>l&&(this.minNote_=l,this.maxNote_=n,this.nKeys_=this.maxNote_-this.minNote_+1),this.setValue(e)}doClassValidation_(t){const i=/^Note\.(.+)$/.exec(t),o=i&&i.length>1?i[1]:null;if(null===(t=e[o]?e[o]:String(parseFloat(t||"0"))))return null;const s=parseFloat(t||"0");if(isNaN(s)||s<0)return null;const l=Math.floor(s)!=s;return""+s.toFixed(l?2:0)}getValue(){return this.value_+""}doValueUpdate_(t){isNaN(Number(t))||Number(t)<0||(this.sourceBlock_&&Blockly.Events.isEnabled()&&this.value_!=t&&Blockly.Events.fire(new Blockly.Events.Change(this.sourceBlock_,"field",this.name,this.value_,t)),this.value_=t,this.refreshText())}getText(){if(this.isExpanded)return""+this.value_;{const t=+this.value_;for(let e=0;e<this.nKeys_;e++)if(Math.abs(this.getKeyFreq(e)-t)<this.eps)return this.getKeyName(e);let e=t.toString();return isNaN(t)||(e+=" Hz"),e}}refreshText(){this.forceRerender()}onHtmlInputChange_(t){super.onHtmlInputChange_(t),Blockly.DropDownDiv.hideWithoutAnimation(),this.htmlInput_.focus()}onFinishEditing_(t){this.refreshText()}onHide(){this.isExpanded=!1,this.refreshText()}showEditor_(t){this.isExpanded=!0,this.updateColor(),Blockly.DropDownDiv.hideWithoutAnimation(),Blockly.DropDownDiv.clearContent();const e=pxt.BrowserUtils.isMobile()||pxt.BrowserUtils.isIOS();i.superClass_.showEditor_.call(this,t,e,e),this.refreshText(),Blockly.Events.setGroup(!0),this.piano=[],this.currentSelectedKey=void 0;const s=this.nKeys_-this.nKeys_/i.notesPerOctave*i.blackKeysPerOctave,l=i.notesPerOctave-i.blackKeysPerOctave;let n=i.keyWidth*s,r=i.keyHeight+i.labelHeight;const a=window.innerWidth<n;a&&(n=l*i.keyWidth,r=i.keyHeight+i.labelHeight+i.prevNextHeight);const c=o("blocklyPianoDiv",`width: ${n}px;\n                height: ${r}px;`);Blockly.DropDownDiv.getContentDiv().appendChild(c),this.noteLabel=o("blocklyNoteLabel",`top: ${i.keyHeight}px;\n                width: ${n}px;\n                background-color: ${this.primaryColour};\n                border-color: ${this.primaryColour};`),c.appendChild(this.noteLabel),this.noteLabel.textContent="-";let u=0;for(let t=0;t<this.nKeys_;t++){const e=Math.floor(t/i.notesPerOctave);let o=this.getPosition(t);a&&t>=i.notesPerOctave&&(o-=l*e*i.keyWidth);const s=this.getKeyDiv(t,o);this.piano.push(s),c.appendChild(s),Math.abs(this.getKeyFreq(t)-Number(this.getValue()))<this.eps&&(pxt.BrowserUtils.addClass(s,"selected"),this.currentSelectedKey=s,u=e)}a&&(this.setPage(u),c.appendChild(this.getNextPrevDiv(!0,n)),c.appendChild(this.getNextPrevDiv(!1,n))),Blockly.DropDownDiv.setColour(this.primaryColour,this.borderColour),Blockly.DropDownDiv.showPositionedByBlock(this,this.sourceBlock_,(()=>this.onHide()))}playKey(t,e){const i=++this.totalPlayCount;this.currentSelectedKey!==t&&(this.currentSelectedKey&&pxt.BrowserUtils.removeClass(this.currentSelectedKey,"selected"),pxt.BrowserUtils.addClass(t,"selected"),this.setValue(e)),this.currentSelectedKey=t,this.htmlInput_.value=this.getText(),pxt.AudioContextManager.tone(e),setTimeout((()=>{this.totalPlayCount==i&&pxt.AudioContextManager.stop()}),300)}dispose(){Blockly.DropDownDiv.hideIfOwner(this),super.dispose()}updateColor(){if(this.sourceBlock_.parentBlock_&&(this.sourceBlock_.isShadow()||1===(t=this.sourceBlock_).inputList.length&&1===t.inputList[0].fieldRow.length)){let t=this.sourceBlock_.parentBlock_;this.primaryColour=t.getColour(),this.borderColour=t.getColourTertiary()}else this.primaryColour="#3D3D3D",this.borderColour="#2A2A2A";var t}setPage(t){const e=this.nKeys_/i.notesPerOctave;t=Math.max(Math.min(t,e-1),0),this.noteLabel.textContent=`Octave #${t+1}`;const o=t*i.notesPerOctave;for(let t=0;t<this.piano.length;++t){const e=t>=o&&t<o+i.notesPerOctave;this.piano[t].style.display=e?"block":"none"}this.currentPage=t}getNextPrevDiv(t,e){const s=t?0:e/2,l=o("blocklyNotePrevNext",`top: ${i.keyHeight+i.labelHeight}px;\n                left: ${s}px;\n                width: ${Math.ceil(e/2)}px;\n                ${t?"border-left-color":"border-right-color"}: ${this.primaryColour};\n                background-color: ${this.primaryColour};\n                border-bottom-color: ${this.primaryColour};`);return pxt.BrowserUtils.pointerEvents.down.forEach((e=>{Blockly.bindEventWithChecks_(l,e,this,(()=>this.setPage(t?this.currentPage-1:this.currentPage+1)),!0)})),l.textContent=t?"<":">",l}getKeyDiv(t,e){const i=o("blocklyNote "+(this.isWhite(t)?"":"black"),`width: ${this.getKeyWidth(t)}px;\n                height: ${this.getKeyHeight(t)}px;\n                left: ${e}px;\n                border-color: ${this.primaryColour};`);return pxt.BrowserUtils.pointerEvents.down.forEach((e=>{Blockly.bindEventWithChecks_(i,e,this,(()=>this.playKey(i,this.getKeyFreq(t))),!0)})),Blockly.bindEventWithChecks_(i,"mouseover",this,(()=>this.noteLabel.textContent=this.getKeyName(t)),!0),i}isWhite(t){switch(t%12){case 1:case 3:case 6:case 8:case 10:return!1;default:return!0}}getKeyWidth(t){return this.isWhite(t)?i.keyWidth:i.keyWidth/2}getKeyHeight(t){return this.isWhite(t)?i.keyHeight:i.keyHeight/2}getKeyFreq(t){return this.getKeyNoteData(t).freq}getKeyName(t){const e=this.getKeyNoteData(t);let o=e.prefixedName;return this.nKeys_<=i.notesPerOctave?o=e.name:this.minNote_>=28&&this.maxNote_<=63&&(o=e.altPrefixedName||o),o}getKeyNoteData(t){return i.Notes[t+this.minNote_]}getPosition(t){const e=(t-Math.floor((t+1)/i.notesPerOctave*i.blackKeysPerOctave))*i.keyWidth;return this.isWhite(t)?e:e-i.keyWidth/4}prepareNotes(){i.Notes||(i.Notes={28:{name:lf("{id:note}C"),prefixedName:lf("Low C"),freq:131},29:{name:lf("C#"),prefixedName:lf("Low C#"),freq:139},30:{name:lf("{id:note}D"),prefixedName:lf("Low D"),freq:147},31:{name:lf("D#"),prefixedName:lf("Low D#"),freq:156},32:{name:lf("{id:note}E"),prefixedName:lf("Low E"),freq:165},33:{name:lf("{id:note}F"),prefixedName:lf("Low F"),freq:175},34:{name:lf("F#"),prefixedName:lf("Low F#"),freq:185},35:{name:lf("{id:note}G"),prefixedName:lf("Low G"),freq:196},36:{name:lf("G#"),prefixedName:lf("Low G#"),freq:208},37:{name:lf("{id:note}A"),prefixedName:lf("Low A"),freq:220},38:{name:lf("A#"),prefixedName:lf("Low A#"),freq:233},39:{name:lf("{id:note}B"),prefixedName:lf("Low B"),freq:247},40:{name:lf("{id:note}C"),prefixedName:lf("Middle C"),freq:262},41:{name:lf("C#"),prefixedName:lf("Middle C#"),freq:277},42:{name:lf("{id:note}D"),prefixedName:lf("Middle D"),freq:294},43:{name:lf("D#"),prefixedName:lf("Middle D#"),freq:311},44:{name:lf("{id:note}E"),prefixedName:lf("Middle E"),freq:330},45:{name:lf("{id:note}F"),prefixedName:lf("Middle F"),freq:349},46:{name:lf("F#"),prefixedName:lf("Middle F#"),freq:370},47:{name:lf("{id:note}G"),prefixedName:lf("Middle G"),freq:392},48:{name:lf("G#"),prefixedName:lf("Middle G#"),freq:415},49:{name:lf("{id:note}A"),prefixedName:lf("Middle A"),freq:440},50:{name:lf("A#"),prefixedName:lf("Middle A#"),freq:466},51:{name:lf("{id:note}B"),prefixedName:lf("Middle B"),freq:494},52:{name:lf("{id:note}C"),prefixedName:lf("Tenor C"),altPrefixedName:lf("High C"),freq:523},53:{name:lf("C#"),prefixedName:lf("Tenor C#"),altPrefixedName:lf("High C#"),freq:554},54:{name:lf("{id:note}D"),prefixedName:lf("Tenor D"),altPrefixedName:lf("High D"),freq:587},55:{name:lf("D#"),prefixedName:lf("Tenor D#"),altPrefixedName:lf("High D#"),freq:622},56:{name:lf("{id:note}E"),prefixedName:lf("Tenor E"),altPrefixedName:lf("High E"),freq:659},57:{name:lf("{id:note}F"),prefixedName:lf("Tenor F"),altPrefixedName:lf("High F"),freq:698},58:{name:lf("F#"),prefixedName:lf("Tenor F#"),altPrefixedName:lf("High F#"),freq:740},59:{name:lf("{id:note}G"),prefixedName:lf("Tenor G"),altPrefixedName:lf("High G"),freq:784},60:{name:lf("G#"),prefixedName:lf("Tenor G#"),altPrefixedName:lf("High G#"),freq:831},61:{name:lf("{id:note}A"),prefixedName:lf("Tenor A"),altPrefixedName:lf("High A"),freq:880},62:{name:lf("A#"),prefixedName:lf("Tenor A#"),altPrefixedName:lf("High A#"),freq:932},63:{name:lf("{id:note}B"),prefixedName:lf("Tenor B"),altPrefixedName:lf("High B"),freq:988},64:{name:lf("{id:note}C"),prefixedName:lf("High C"),freq:1046},65:{name:lf("C#"),prefixedName:lf("High C#"),freq:1109},66:{name:lf("{id:note}D"),prefixedName:lf("High D"),freq:1175},67:{name:lf("D#"),prefixedName:lf("High D#"),freq:1245},68:{name:lf("{id:note}E"),prefixedName:lf("High E"),freq:1319},69:{name:lf("{id:note}F"),prefixedName:lf("High F"),freq:1397},70:{name:lf("F#"),prefixedName:lf("High F#"),freq:1478},71:{name:lf("{id:note}G"),prefixedName:lf("High G"),freq:1568},72:{name:lf("G#"),prefixedName:lf("High G#"),freq:1661},73:{name:lf("{id:note}A"),prefixedName:lf("High A"),freq:1760},74:{name:lf("A#"),prefixedName:lf("High A#"),freq:1865},75:{name:lf("{id:note}B"),prefixedName:lf("High B"),freq:1976}})}}function o(t,e){const i=document.createElement("div");return pxt.BrowserUtils.addClass(i,t),i.setAttribute("style",e.replace(/\s+/g," ")),i}i.keyWidth=22,i.keyHeight=90,i.labelHeight=24,i.prevNextHeight=20,i.notesPerOctave=12,i.blackKeysPerOctave=5,t.FieldNote=i}(pxtblockly||(pxtblockly={})),function(t){class e extends Blockly.FieldNumberDropdown{constructor(t,e,i){super(t,e.data,e.min,e.max,e.precision,i),this.isFieldCustom_=!0}getOptions(){let t;return this.menuGenerator_&&(t=JSON.parse(this.menuGenerator_).map((t=>"object"==typeof t?t:[String(t),String(t)]))),t}}t.FieldNumberDropdown=e}(pxtblockly||(pxtblockly={})),function(t){class e extends Blockly.FieldSlider{constructor(t,e,i){super(t,"0","100","1","100","Value",i),this.isFieldCustom_=!0,this.params=e,this.params.screenHeight||(this.params.screenHeight=120),this.params.screenWidth||(this.params.screenWidth=160),this.params.xInputName||(this.params.xInputName="x"),this.params.yInputName||(this.params.yInputName="y"),this.params.min&&(this.min_=parseInt(this.params.min)),this.params.max&&(this.max_=parseInt(this.params.max))}showEditor_(t){this.getFieldByName(this.params.xInputName)===this&&(this.max_=this.params.screenWidth,this.labelText_=this.params.xInputName);this.getFieldByName(this.params.yInputName)===this&&(this.max_=this.params.screenHeight,this.labelText_=this.params.yInputName),super.showEditor_(t),this.renderScreenPicker()}doValueUpdate_(t){super.doValueUpdate_(t),this.resetCrosshair&&this.resetCrosshair()}renderScreenPicker(){let t=Blockly.DropDownDiv.getContentDiv();this.selectorDiv_=document.createElement("div"),this.selectorDiv_.className="blocklyCanvasOverlayOuter",t.appendChild(this.selectorDiv_);const e=document.createElement("div");e.className="blocklyCanvasOverlayDiv",this.selectorDiv_.appendChild(e);const i=document.createElement("div");i.className="cross-x",e.appendChild(i);const o=document.createElement("div");o.className="cross-y",e.appendChild(o);const s=document.createElement("div");s.className="label",e.appendChild(s);const l=1.5*this.params.screenWidth,n=1.5*this.params.screenHeight;e.style.height=n+"px",e.style.width=l+"px";const r=t.getElementsByClassName("goog-slider-horizontal")[0];if(r){r.style.width=l+"px";const t=parseFloat(this.getValue());!isNaN(t)&&t>this.getMin()&&(this.setValue(t-1+""),this.setValue(t+""))}const a=(t,e)=>{t=Math.round(Math.max(0,Math.min(l,t))),e=Math.round(Math.max(0,Math.min(n,e))),i.style.top=e+"px",o.style.left=t+"px",t=Math.round(Math.max(0,Math.min(this.params.screenWidth,t/l*this.params.screenWidth))),e=Math.round(Math.max(0,Math.min(this.params.screenHeight,e/n*this.params.screenHeight))),isNaN(t)?s.textContent=`${this.params.yInputName}=${e}`:isNaN(e)?s.textContent=`${this.params.xInputName}=${t}`:s.textContent=`${this.params.xInputName}=${t} ${this.params.yInputName}=${e}`;const r=s.getBoundingClientRect();t>this.params.screenWidth/2?s.style.left=t*(l/this.params.screenWidth)-r.width-8+"px":s.style.left=t*(l/this.params.screenWidth)+4+"px",e>this.params.screenHeight/2?s.style.top=e*(n/this.params.screenHeight)-r.height-6+"px":s.style.top=e*(n/this.params.screenHeight)+"px"};this.resetCrosshair=()=>{const{currentX:t,currentY:e}=this.getXY();a(t/this.params.screenWidth*l,e/this.params.screenHeight*n)},this.resetCrosshair(),Blockly.bindEvent_(this.selectorDiv_,"mousemove",this,(t=>{const i=e.getBoundingClientRect(),o=t.clientX-i.left,s=t.clientY-i.top;a(o,s)})),Blockly.bindEvent_(this.selectorDiv_,"mouseleave",this,this.resetCrosshair),Blockly.bindEvent_(this.selectorDiv_,"click",this,(t=>{const i=e.getBoundingClientRect(),o=t.clientX-i.left,s=t.clientY-i.top,r=Math.round(o/l*this.params.screenWidth),a=Math.round(s/n*this.params.screenHeight);this.close(),this.setXY(r,a)}))}resizeHandler(){this.close()}setXY(t,e){const i=this.getFieldByName(this.params.xInputName);i&&"number"==typeof i.getValue()&&i.setValue(String(t));const o=this.getFieldByName(this.params.yInputName);o&&"number"==typeof o.getValue()&&o.setValue(String(e))}getFieldByName(t){const e=this.sourceBlock_.parentBlock_;if(e)for(let i=0;i<e.inputList.length;i++){const o=e.inputList[i];if(o.name===t)return this.getTargetField(o)}}getXY(){let t,e;const i=this.getFieldByName(this.params.xInputName);i&&(t=i.getValue());const o=this.getFieldByName(this.params.yInputName);return o&&(e=o.getValue()),{currentX:parseInt(t),currentY:parseInt(e)}}getTargetField(t){const e=t.connection.targetBlock();if(!e)return null;const i=e.inputList[0];if(!i)return null;return i.fieldRow[0]}widgetDispose_(){Blockly.FieldNumber.superClass_.widgetDispose_.call(this),this.close(!0)}close(t){t||(Blockly.WidgetDiv.hideIfOwner(this),Blockly.DropDownDiv.hideIfOwner(this)),window.removeEventListener("resize",this.resizeHandler),this.resetCrosshair=void 0,this.selectorDiv_&&(goog.dom.removeNode(this.selectorDiv_),this.selectorDiv_=void 0)}}t.FieldPosition=e}(pxtblockly||(pxtblockly={})),function(t){class e extends Blockly.FieldDropdown{constructor(t,e){super([["Temp","Temp"]],e),this.setValue(t||"")}getOptions(){return this.dropdownCreate()}init(){this.fieldGroup_||super.init.call(this)}setSourceBlock(t){goog.asserts.assert(!t.isShadow(),"Procedure fields are not allowed to exist on shadow blocks."),super.setSourceBlock.call(this,t)}dropdownCreate(){let t=[];if(this.sourceBlock_&&this.sourceBlock_.workspace){let e=this.sourceBlock_.workspace.getAllBlocks(!1);for(let i=0;i<e.length;i++)if(e[i].getProcedureDef){let o=e[i].getProcedureDef();t.push(o[0])}}let e=this.getValue();e&&-1==t.indexOf(e)&&t.push(e),t.sort(goog.string.caseInsensitiveCompare),t.length||t.push("Temp");let i=[];for(let e=0;e<t.length;e++)i[e]=[t[e],t[e]];return i}onItemSelected(t,e){let i=e.getValue();null!==i&&this.setValue(i)}}t.FieldProcedure=e}(pxtblockly||(pxtblockly={})),function(t){class e extends Blockly.FieldSlider{constructor(t,e,i){super(String(t),"0","180","1","15",lf("Angle"),i),this.isFieldCustom_=!0,this.params=e}createLabelDom_(t){const e=document.createElement("div");this.circleSVG=document.createElementNS("http://www.w3.org/2000/svg","svg"),pxsim.svg.hydrate(this.circleSVG,{viewBox:"0 0 200 100",width:"170"}),e.appendChild(this.circleSVG);pxsim.svg.child(this.circleSVG,"circle",{"stroke-dasharray":"565.48","stroke-dashoffset":"0",cx:100,cy:100,r:"90",style:"fill:transparent; transition: stroke-dashoffset 0.1s linear;",stroke:"#a8aaa8","stroke-width":"1rem"});this.circleBar=pxsim.svg.child(this.circleSVG,"circle",{"stroke-dasharray":"565.48","stroke-dashoffset":"0",cx:100,cy:100,r:"90",style:"fill:transparent; transition: stroke-dashoffset 0.1s linear;",stroke:"#f12a21","stroke-width":"1rem"}),this.reporter=pxsim.svg.child(this.circleSVG,"text",{x:100,y:80,"text-anchor":"middle","dominant-baseline":"middle",style:"font-size: 50px",class:"sim-text inverted number"});const i=document.createElement("span");return i.setAttribute("class","blocklyFieldSliderReadout"),[e,i]}setReadout_(t,e){this.updateAngle(parseFloat(e)),this.reporter.textContent=`${e}°`}updateAngle(t){const e=(180-(t=Math.max(0,Math.min(180,t))))/180*Math.PI*90;this.circleBar.setAttribute("stroke-dashoffset",`${e}`)}}t.FieldProtractor=e}(pxtblockly||(pxtblockly={})),function(t){class e extends Blockly.FieldSlider{constructor(t,e,i){super(String(t),"-100","100","1","10","Speed",i),this.isFieldCustom_=!0,this.params=e,this.params.min&&(this.min_=parseFloat(this.params.min)),this.params.max&&(this.max_=parseFloat(this.params.max)),this.params.label&&(this.labelText_=this.params.label),this.params.format||(this.params.format="{0}%")}createLabelDom_(t){const e=document.createElement("div");this.speedSVG=document.createElementNS("http://www.w3.org/2000/svg","svg"),pxsim.svg.hydrate(this.speedSVG,{viewBox:"0 0 200 100",width:"170"}),e.appendChild(this.speedSVG);pxsim.svg.child(this.speedSVG,"circle",{"stroke-dasharray":"565.48","stroke-dashoffset":"0",cx:100,cy:100,r:"90",style:"fill:transparent; transition: stroke-dashoffset 0.1s linear;",stroke:"#a8aaa8","stroke-width":"1rem"});this.circleBar=pxsim.svg.child(this.speedSVG,"circle",{"stroke-dasharray":"565.48","stroke-dashoffset":"0",cx:100,cy:100,r:"90",style:"fill:transparent; transition: stroke-dashoffset 0.1s linear;",stroke:"#f12a21","stroke-width":"1rem"}),this.reporter=pxsim.svg.child(this.speedSVG,"text",{x:100,y:80,"text-anchor":"middle","dominant-baseline":"middle",style:`font-size: ${Math.max(14,50-5*(this.params.format.length-4))}px`,class:"sim-text inverted number"});const i=document.createElement("span");return i.setAttribute("class","blocklyFieldSliderReadout"),[e,i]}setReadout_(t,e){this.updateSpeed(parseFloat(e)),this.reporter.textContent=ts.pxtc.U.rlf(this.params.format,e)}updateSpeed(t){let e=this.sign(t);t=Math.abs(t)/100*50+50,-1==e&&(t=50-t);let i=(100-t)/100*(180*Math.PI);this.circleBar.setAttribute("stroke-dashoffset",`${i}`)}sign(t){return t?t<0?-1:1:0}}t.FieldSpeed=e}(pxtblockly||(pxtblockly={})),function(t){class e extends t.FieldAssetEditor{getAssetType(){return"image"}createNewAsset(t){const e=pxt.react.getTilemapProject();if(t){const i=pxt.lookupProjectAssetByTSReference(t,e);if(i)return i}if(this.getBlockData())return e.lookupAsset("image",this.getBlockData());const i=t?pxt.sprite.imageLiteralToBitmap(t):new pxt.sprite.Bitmap(this.params.initWidth,this.params.initHeight);if(!i)return this.isGreyBlock=!0,void(this.valueText=t);const o=i.data();return{internalID:-1,id:this.sourceBlock_.id,type:"image",jresData:pxt.sprite.base64EncodeBitmap(o),meta:{},bitmap:o}}getValueText(){return this.asset&&!this.isTemporaryAsset()?pxt.getTSReferenceForAsset(this.asset):pxt.sprite.bitmapToImageLiteral(this.asset&&pxt.sprite.Bitmap.fromData(this.asset.bitmap),"typescript")}parseFieldOptions(t){return function(t){const e={initColor:1,initWidth:16,initHeight:16,disableResize:!1,lightMode:!1};if(!t)return e;if(e.lightMode=t.lightMode,t.sizes){const i=t.sizes.split(";"),o=[];for(let t=0;t<i.length;t++){const e=i[t].split(",");if(2!==e.length)continue;let s=parseInt(e[0]),l=parseInt(e[1]);if(isNaN(s)||isNaN(l))continue;const n=pxt.appTarget.runtime&&pxt.appTarget.runtime.screenSize;s<0&&n&&(s=n.width),l<0&&n&&(l=n.height),o.push([s,l])}o.length>0&&(e.initWidth=o[0][0],e.initHeight=o[0][1])}t.filter&&(e.filter=t.filter);t.disableResize&&(e.disableResize="true"===t.disableResize.toLowerCase()||"1"===t.disableResize);return e.initColor=i(t.initColor,e.initColor),e.initWidth=i(t.initWidth,e.initWidth),e.initHeight=i(t.initHeight,e.initHeight),e;function i(t,e){const i=parseInt(t);return isNaN(i)?e:i}}(t)}}t.FieldSpriteEditor=e}(pxtblockly||(pxtblockly={})),function(t){class e extends Blockly.FieldLabel{constructor(t,e,i){super(t,function(t){if(t){if(t.bold&&t.italics)return"blocklyBoldItalicizedText";if(t.bold)return"blocklyBoldText";if(t.italics)return"blocklyItalicizedText"}return}(e)),this.isFieldCustom_=!0}}t.FieldStyledLabel=e}(pxtblockly||(pxtblockly={})),function(t){class e extends Blockly.FieldTextDropdown{constructor(t,e,i){super(t,e.values,i),this.isFieldCustom_=!0}}t.FieldTextDropdown=e}(pxtblockly||(pxtblockly={})),function(t){class e extends Blockly.FieldTextInput{constructor(t,e,i){super(t,i),this.isFieldCustom_=!0}}t.FieldTextInput=e}(pxtblockly||(pxtblockly={})),function(t){class e extends t.FieldAssetEditor{getInitText(){return this.initText}getTileset(){var t;return null===(t=this.asset)||void 0===t?void 0:t.data.tileset}getAssetType(){return"tilemap"}createNewAsset(t=""){t&&(t=t.replace(/&#96;/g,"`"));const e=pxt.react.getTilemapProject(),i=pxt.lookupProjectAssetByTSReference(t,e);if(i)return i;const o=pxt.sprite.decodeTilemap(t,"typescript",e)||e.blankTilemap(this.params.tileWidth,this.params.initWidth,this.params.initHeight);let s;if(function(t){return!!(t&&t.tilemap&&t.tilemap.width&&t.tilemap.height)&&(!(!t.layers||t.layers.width!==t.tilemap.width||t.layers.height!==t.tilemap.height)&&!!t.tileset)}(o)){this.initText=t,this.isGreyBlock=!1;const[i]=e.createNewTilemapFromData(o);s=e.getTilemap(i)}else t.trim()&&(this.isGreyBlock=!0,this.valueText=t);return s}onEditorClose(t){pxt.sprite.updateTilemapReferencesFromResult(pxt.react.getTilemapProject(),t)}getValueText(){return this.isGreyBlock?pxt.Util.htmlUnescape(this.valueText):this.asset?pxt.getTSReferenceForAsset(this.asset):this.getInitText()}parseFieldOptions(t){return function(t){const e={initWidth:16,initHeight:16,disableResize:!1,tileWidth:16,lightMode:!1};if(!t)return e;e.lightMode=t.lightMode,t.filter&&(e.filter=t.filter);if(t.tileWidth)if("number"==typeof t.tileWidth)switch(t.tileWidth){case 8:e.tileWidth=8;break;case 16:e.tileWidth=16;break;case 32:e.tileWidth=32}else{switch(t.tileWidth.trim().toLowerCase()){case"8":case"eight":e.tileWidth=8;break;case"16":case"sixteen":e.tileWidth=16;break;case"32":case"thirtytwo":e.tileWidth=32}}return e.initWidth=i(t.initWidth,e.initWidth),e.initHeight=i(t.initHeight,e.initHeight),e;function i(t,e){const i=parseInt(t);return isNaN(i)?e:i}}(t)}}t.FieldTilemap=e}(pxtblockly||(pxtblockly={})),function(t){const e=32;class i extends t.FieldImages{constructor(e,s,l){super(e,s,l),this.isFieldCustom_=!0,this.menuGenerator_=()=>{var e,s;return(null===(e=this.sourceBlock_)||void 0===e?void 0:e.workspace)&&t.needsTilemapUpgrade(null===(s=this.sourceBlock_)||void 0===s?void 0:s.workspace)?[o()]:i.getReferencedTiles(this.sourceBlock_.workspace)},this.assetChangeListener=()=>{this.doValueUpdate_(this.getValue()),this.forceRerender()},this.blocksInfo=s.blocksInfo}static getReferencedTiles(o){const r=pxt.react.getTilemapProject();if(r.revision()!==i.cachedRevision||o.id!=i.cachedWorkspaceId){i.cachedRevision=r.revision(),i.cachedWorkspaceId=o.id;const a=t.getAllReferencedTiles(o),c=[16,8,32];for(const t of c){const e=r.getProjectTiles(t,16===t);if(e)for(const t of e.tiles)a.find((e=>e.id===t.id))||a.push(t)}let u={};a.sort(((t,e)=>t.id===e.id?0:t.bitmap.width!==e.bitmap.width?t.bitmap.width-e.bitmap.width:t.isProjectTile!==e.isProjectTile?t.isProjectTile?-1:1:(u[t.id]||(u[t.id]=l(t.id)))-(u[e.id]||(u[e.id]=l(e.id)))));const d=i=>l(i.id)<=2?s(i.bitmap.width):t.bitmapToImageURI(pxt.sprite.Bitmap.fromData(i.bitmap),e,!1);i.referencedTiles=a.map((t=>[{src:d(t),width:e,height:e,alt:n(t)},t.id,t]))}return i.referencedTiles}initView(){super.initView(),this.sourceBlock_&&this.sourceBlock_.isInFlyout&&this.setValue(this.getOptions()[0][1])}getValue(){if(this.selectedOption_){let t=this.selectedOption_[2];return t=pxt.react.getTilemapProject().lookupAsset(t.type,t.id),pxt.getTSReferenceForAsset(t)}const t=super.getValue();return"string"==typeof t&&-1===t.indexOf(".")&&-1===t.indexOf("`")?`img\`${t}\``:t}getText(){const t=this.getValue();return"string"==typeof t&&-1!==t.indexOf("`")?t:super.getText()}render_(){if(this.value_&&this.selectedOption_&&this.selectedOption_[1]!==this.value_){const o=pxt.react.getTilemapProject().resolveTile(this.value_);i.cachedRevision=-1,o&&(this.selectedOption_=[{src:t.bitmapToImageURI(pxt.sprite.Bitmap.fromData(o.bitmap),e,!1),width:e,height:e,alt:n(o)},this.value_,o])}super.render_()}doValueUpdate_(t){super.doValueUpdate_(t);const e=this.getOptions(!0);if(t){const i=pxt.parseAssetTSReference(t);i&&(t=i.name),t=t.trim();for(const i of e)if(t===i[2].id||t===i[2].meta.displayName||t===pxt.getShortIDForAsset(i[2]))return this.selectedOption_=i,this.value_=this.getValue(),void this.updateAssetListener();this.selectedOption_=null,this.updateAssetListener()}}getOptions(t){return"function"!=typeof this.menuGenerator_?(this.transparent=o(),[this.transparent]):this.menuGenerator_.call(this)}dispose(){super.dispose(),pxt.react.getTilemapProject().removeChangeListener("tile",this.assetChangeListener)}updateAssetListener(){const t=pxt.react.getTilemapProject();t.removeChangeListener("tile",this.assetChangeListener),this.selectedOption_&&t.addChangeListener(this.selectedOption_[2],this.assetChangeListener)}}function o(){const t=pxt.react.getTilemapProject().getTransparency(16);return[{src:s(16),width:e,height:e,alt:pxt.U.lf("transparency")},t.id,t]}function s(t){const e=document.createElement("canvas"),i=e.getContext("2d");e.width=t,e.height=t,i.fillStyle="#aeaeae",i.fillRect(0,0,t,t),i.fillStyle="#dedede";for(let e=0;e<t;e+=4)for(let o=0;o<t;o+=4)e+o>>2&1&&i.fillRect(e,o,4,4);return e.toDataURL()}function l(t){switch(t){case"myTiles.transparency16":return 1;case"myTiles.transparency8":case"myTiles.transparency32":return 2;default:if(t.startsWith("myTiles.tile")){const e=parseInt(t.slice(12));if(!Number.isNaN(e))return e+2}return 9999999999}}function n(t){return t.meta.displayName||pxt.getShortIDForAsset(t)}t.FieldTileset=i}(pxtblockly||(pxtblockly={})),function(t){class e extends Blockly.FieldNumber{constructor(t,e,i){super(t,void 0,void 0,void 0,i),this.isFieldCustom_=!0,this.CURSOR="pointer",this.params=e,this.setValue(t),this.addArgType("toggle"),this.type_=e.type}initView(){if(!this.fieldGroup_)return;null!==this.getArgTypes()&&(this.sourceBlock_.isShadow()?this.sourceBlock_.svgGroup_.setAttribute("data-argument-type",this.getArgTypes()):this.fieldGroup_.setAttribute("data-argument-type",this.getArgTypes())),!this.sourceBlock_.isShadow()&&this.sourceBlock_.inputList&&this.sourceBlock_.inputList.length>1&&(this.borderRect_=Blockly.utils.dom.createSvgElement("rect",{rx:Blockly.BlockSvg.CORNER_RADIUS,ry:Blockly.BlockSvg.CORNER_RADIUS,x:0,y:0,width:this.size_.width,height:this.size_.height,fill:this.sourceBlock_.getColour(),stroke:this.sourceBlock_.getColourTertiary()},null),this.fieldGroup_.insertBefore(this.borderRect_,this.textElement_));const t=this.getSize();switch(this.checkElement_=Blockly.utils.dom.createSvgElement("g",{class:"blocklyToggle "+(this.state_?"blocklyToggleOn":"blocklyToggleOff"),transform:`translate(8, ${t.height/2})`},this.fieldGroup_),this.getOutputShape()){case Blockly.OUTPUT_SHAPE_HEXAGONAL:this.toggleThumb_=Blockly.utils.dom.createSvgElement("polygon",{class:"blocklyToggleRect",points:"-7,-14 -21,0 -7,14 7,14 21,0 7,-14",cursor:"pointer"},this.checkElement_);break;case Blockly.OUTPUT_SHAPE_ROUND:this.toggleThumb_=Blockly.utils.dom.createSvgElement("rect",{class:"blocklyToggleCircle",x:-6,y:-14,height:28,width:28,rx:14,ry:14,cursor:"pointer"},this.checkElement_);break;case Blockly.OUTPUT_SHAPE_SQUARE:this.toggleThumb_=Blockly.utils.dom.createSvgElement("rect",{class:"blocklyToggleRect",x:-6,y:-14,height:28,width:28,rx:3,ry:3,cursor:"pointer"},this.checkElement_)}let e=this.sourceBlock_.RTL?-t.width/2:t.width/2;this.textElement_=Blockly.utils.dom.createSvgElement("text",{class:"blocklyText",x:e,dy:"0.6ex",y:t.height/2},this.fieldGroup_),this.updateEditable();const i=this.sourceBlock_.getSvgRoot();i.appendChild(this.fieldGroup_),i.querySelector(".blocklyBlockBackground").setAttribute("fill",this.sourceBlock_.getColourTertiary()),this.switchToggle(this.state_),this.setValue(this.getValue()),this.markDirty()}getDisplayText_(){return this.state_?this.getTrueText():this.getFalseText()}getTrueText(){return lf("True")}getFalseText(){return lf("False")}updateSize_(){switch(this.getOutputShape()){case Blockly.OUTPUT_SHAPE_ROUND:this.size_.width=2*this.getInnerWidth()-7;break;case Blockly.OUTPUT_SHAPE_HEXAGONAL:this.size_.width=2*this.getInnerWidth()+8-Math.floor(this.getInnerWidth()/2);break;case Blockly.OUTPUT_SHAPE_SQUARE:this.size_.width=9+2*this.getInnerWidth()}}getInnerWidth(){return 10*this.getMaxLength()}getMaxLength(){return Math.max(this.getTrueText().length,this.getFalseText().length)}getOutputShape(){return this.sourceBlock_.isShadow()?this.sourceBlock_.getOutputShape():Blockly.OUTPUT_SHAPE_SQUARE}doClassValidation_(t){return"boolean"==typeof this.fromVal(t)?t:"false"}applyColour(){let t=this.sourceBlock_.getColourTertiary();this.borderRect_?this.borderRect_.setAttribute("stroke",t):this.sourceBlock_.pathObject.svgPath.setAttribute("fill",t)}getValue(){return this.toVal(this.state_)}doValueUpdate_(t){let e=this.fromVal(t);this.state_!==e&&(this.sourceBlock_&&Blockly.Events.isEnabled()&&Blockly.Events.fire(new Blockly.Events.BlockChange(this.sourceBlock_,"field",this.name,this.state_,e)),this.state_=e,this.switchToggle(this.state_),this.isDirty_=!0)}switchToggle(t){if(this.checkElement_){this.updateSize_();const e=this.getSize(),i=this.getInnerWidth();t?(pxt.BrowserUtils.addClass(this.checkElement_,"blocklyToggleOn"),pxt.BrowserUtils.removeClass(this.checkElement_,"blocklyToggleOff")):(pxt.BrowserUtils.removeClass(this.checkElement_,"blocklyToggleOn"),pxt.BrowserUtils.addClass(this.checkElement_,"blocklyToggleOff"));const o=this.getOutputShape();let s=0,l=0,n=0,r=0;switch(o){case Blockly.OUTPUT_SHAPE_HEXAGONAL:s=i,l=s/2;let t=l/2;n=-l+t,r=-t;const e=-t,a=l;this.toggleThumb_.setAttribute("points",`${e},-14 ${e-14},0 ${e},14 ${a},14 ${a+14},0 ${a},-14`);break;case Blockly.OUTPUT_SHAPE_ROUND:case Blockly.OUTPUT_SHAPE_SQUARE:s=5+i,l=s/2,this.toggleThumb_.setAttribute("width",""+s),this.toggleThumb_.setAttribute("x",`-${l}`),n=r=o==Blockly.OUTPUT_SHAPE_SQUARE?2:-6}this.checkElement_.setAttribute("transform",`translate(${t?r+i+l:l+n}, ${e.height/2})`)}}render_(){if(this.visible_&&this.textElement_){goog.dom.removeChildren(this.textElement_);let t=document.createTextNode(this.getDisplayText_());this.textElement_.appendChild(t),pxt.BrowserUtils.addClass(this.textElement_,"blocklyToggleText"),this.updateSize_();let e=this.size_.width,i=(this.state_?e+e/8:e/2)-e/2;this.textElement_.setAttribute("x",`${i}`)}this.borderRect_&&(this.borderRect_.setAttribute("width",`${this.size_.width}`),this.borderRect_.setAttribute("height",`${this.size_.height}`))}showEditor_(){let t=!this.state_;null!==t&&this.setValue(this.toVal(t))}toVal(t){return"number"==this.type_?String(t?"1":"0"):String(t?"true":"false")}fromVal(t){return"string"==typeof t?"1"==t||"TRUE"==t.toUpperCase():!!t}}t.FieldToggle=e}(pxtblockly||(pxtblockly={})),function(t){class e extends t.FieldToggle{constructor(t,e,i){super(t,e,i),this.isFieldCustom_=!0}getTrueText(){return lf("HIGH")}getFalseText(){return lf("LOW")}}t.FieldToggleHighLow=e}(pxtblockly||(pxtblockly={})),function(t){class e extends t.FieldToggle{constructor(t,e,i){super(t,e,i),this.isFieldCustom_=!0}getTrueText(){return lf("ON")}getFalseText(){return lf("OFF")}}t.FieldToggleOnOff=e}(pxtblockly||(pxtblockly={})),function(t){class e extends t.FieldToggle{constructor(t,e,i){super(t,e,i),this.isFieldCustom_=!0}getTrueText(){return lf("UP")}getFalseText(){return lf("DOWN")}}t.FieldToggleUpDown=e;class i extends t.FieldToggle{constructor(t,e,i){super(t,e,i),this.isFieldCustom_=!0}getTrueText(){return lf("DOWN")}getFalseText(){return lf("UP")}}t.FieldToggleDownUp=i}(pxtblockly||(pxtblockly={})),function(t){class e extends t.FieldToggle{constructor(t,e,i){super(t,e,i),this.isFieldCustom_=!0}getTrueText(){return lf("WIN")}getFalseText(){return lf("LOSE")}}t.FieldToggleWinLose=e}(pxtblockly||(pxtblockly={})),function(t){class e extends t.FieldToggle{constructor(t,e,i){super(t,e,i),this.isFieldCustom_=!0}getTrueText(){return lf("Yes")}getFalseText(){return lf("No")}}t.FieldToggleYesNo=e}(pxtblockly||(pxtblockly={})),function(t){class e extends Blockly.FieldTextInput{constructor(){super(...arguments),this.isFieldCustom_=!0,this.pythonMode=!1}updateEditable(){let t=this.fieldGroup_;this.EDITABLE&&t&&(this.sourceBlock_.isEditable()?(pxt.BrowserUtils.addClass(t,"blocklyEditableText"),pxt.BrowserUtils.removeClass(t,"blocklyGreyExpressionBlockText"),this.fieldGroup_.style.cursor=this.CURSOR):(pxt.BrowserUtils.addClass(t,"blocklyGreyExpressionBlockText"),pxt.BrowserUtils.removeClass(t,"blocklyEditableText"),this.fieldGroup_.style.cursor=""))}setPythonEnabled(t){t!==this.pythonMode&&(this.pythonMode=t,this.forceRerender())}getText(){return this.pythonMode?pxt.Util.lf("<python code>"):this.getValue()}applyColour(){this.sourceBlock_&&this.constants_.FULL_BLOCK_FIELDS&&this.borderRect_&&this.borderRect_.setAttribute("stroke",this.sourceBlock_.style.colourTertiary)}}t.FieldTsExpression=e}(pxtblockly||(pxtblockly={})),function(t){class e extends Blockly.FieldSlider{constructor(t,e,i){super(String(t),"-200","200","1","10","TurnRatio",i),this.isFieldCustom_=!0,this.params=e,this.sliderColor_="#a8aaa8"}createLabelDom_(t){let i=document.createElement("div"),o=Blockly.utils.dom.createSvgElement("svg",{xmlns:"http://www.w3.org/2000/svg","xmlns:html":"http://www.w3.org/1999/xhtml","xmlns:xlink":"http://www.w3.org/1999/xlink",version:"1.1",height:e.HALF+e.HANDLE_RADIUS+10+"px",width:2*e.HALF+"px"},i),s=Blockly.utils.dom.createSvgElement("defs",{},o),l=Blockly.utils.dom.createSvgElement("marker",{id:"head",orient:"auto",markerWidth:"2",markerHeight:"4",refX:"0.1",refY:"1.5"},s);Blockly.utils.dom.createSvgElement("path",{d:"M0,0 V3 L1.5,1.5 Z",fill:"#f12a21"},l);this.reporter_=pxsim.svg.child(o,"text",{x:e.HALF,y:96,"text-anchor":"middle","dominant-baseline":"middle",style:"font-size: 50px",class:"sim-text inverted number"}),this.path_=Blockly.utils.dom.createSvgElement("path",{x1:e.HALF,y1:e.HALF,"marker-end":"url(#head)",style:"fill: none; stroke: #f12a21; stroke-width: 10"},o),this.updateGraph_();let n=document.createElement("span");return n.setAttribute("class","blocklyFieldSliderReadout"),[i,n]}updateGraph_(){if(!this.path_)return;let t=goog.math.clamp(this.getValue()||0,-200,200);const i=t/100,o=Math.max(-1,Math.min(1,i)),s=Math.max(o)*Math.PI/2,l=e.RADIUS-6;let n=e.HALF;const r=e.HALF-22;Math.abs(i)>1&&(n-=(i-(i>0?1:-1))*l/2);const a=.2+.5*Math.abs(o),c=l*a,u=l*Math.sin(Math.PI/2-s),d=l*Math.cos(Math.PI/2-s),p=u-l*a*Math.cos(2*s),h=`M ${n} ${r} C ${n} ${r-c} ${n+(d-l*a*Math.sin(2*s))} ${r-p} ${n+d} ${r-u}`;this.path_.setAttribute("d",h),this.reporter_.textContent=`${t}`}setReadout_(t,e){this.updateGraph_()}}e.HALF=80,e.HANDLE_RADIUS=30,e.RADIUS=e.HALF-e.HANDLE_RADIUS-1,t.FieldTurnRatio=e}(pxtblockly||(pxtblockly={})),function(t){class e extends Blockly.FieldDropdown{constructor(t){super(function(t){return function(){const e=[],i=this;if(i.sourceBlock_&&i.sourceBlock_.workspace){i.sourceBlock_.workspace.getVariablesOfType(t.name).forEach((t=>{const i=t.name.replace(/^\d+/,"");e.push([i,t.name])}))}else t.initialMembers.forEach((t=>e.push([t,t])));return e.push([lf("Add a new {0}...",t.memberName),"CREATE"]),e}}(t)),this.opts=t}init(){super.init(),this.initVariables()}onItemSelected_(t,e){"CREATE"===e.getValue()?i(this.sourceBlock_.workspace,this.opts,lf("New {0}:",this.opts.memberName),(t=>t&&this.setValue(t))):super.onItemSelected_(t,e)}doClassValidation_(t){var e;return(null===(e=this.opts)||void 0===e?void 0:e.initialMembers)&&!this.opts.initialMembers.find((e=>e==t))&&this.getOptions(),super.doClassValidation_(t)}initVariables(){if(this.sourceBlock_&&this.sourceBlock_.workspace){const t=this.sourceBlock_.workspace,e=s(t,this.opts.name);if(this.opts.initialMembers.forEach((i=>{e.some((([t,e])=>t===i))||n(t,this.opts,i)})),"CREATE"===this.getValue()){const e=function(t,e,i){const s=t.getVariablesOfType(e);if(s&&s.length)for(let t=0;t<s.length;t++){const[e]=o(s[t]);if(e===i)return s[t].name}return}(t,this.opts.name,this.opts.initialMembers[0]);e&&this.setValue(e)}}}}function i(t,e,o,l){Blockly.prompt(o,null,(r=>{if(r){let a=!1;if(pxtc.isIdentifierStart(r.charCodeAt(0),2)){a=!0;for(let t=1;t<r.length;t++)pxtc.isIdentifierPart(r.charCodeAt(t),2)||(a=!1)}if(!a)return void Blockly.alert(lf("Names must start with a letter and can only contain letters, numbers, '$', and '_'."),(()=>i(t,e,o,l)));const c=s(t,e.name);for(let s=0;s<c.length;s++){const[n,a]=c[s];if(n===r)return void Blockly.alert(lf("A {0} named '{1}' already exists.",e.memberName,r),(()=>i(t,e,o,l)))}l(n(t,e,r))}}),{placeholder:e.promptHint})}function o(t){const e=/^(\d+)([^0-9].*)$/.exec(t.name);return e?[e[2],parseInt(e[1])]:[t.name,-1]}function s(t,e){const i=t.getVariablesOfType(e);return i&&i.length?i.map(o):[]}function l(t,e){const i=t.map((([t,e])=>e));if(e.isBitMask){for(let t=0;t<i.length;t++){let e=1<<t;if(i.indexOf(e)<0)return e}return 1<<i.length}if(e.isHash)return 0;{const t=e.firstValue||0;for(let e=0;e<i.length;e++)if(i.indexOf(t+e)<0)return t+e;return t+i.length}}function n(t,e,i){const o=l(s(t,e.name),e)+i;return Blockly.Variables.getOrCreateVariablePackage(t,null,o,e.name),o}t.FieldUserEnum=e,t.getNextValue=l}(pxtblockly||(pxtblockly={})),function(t){let e;function i(t,e){const i=t.getVariablesOfType(pxt.sprite.BLOCKLY_TILESET_TYPE);for(const o of i)if(parseInt(o.name.substr(0,o.name.indexOf(";")))===e.projectId){t.deleteVariableById(o.getId());break}}function o(e){return l(e,(e=>e instanceof t.FieldTilemap&&!e.isGreyBlock))}function s(e){return l(e,(e=>e instanceof t.FieldTileset))}function l(t,e){const i=[];return t.getTopBlocks(!1).forEach((t=>o(t))),i;function o(t){for(const s of t.inputList){for(const o of s.fieldRow)e(o)&&i.push({block:t,field:o.name,ref:o});s.connection&&s.connection.targetBlock()&&o(s.connection.targetBlock())}t.nextConnection&&t.nextConnection.targetBlock()&&o(t.nextConnection.targetBlock())}}!function(t){t.hasClass=function(t,e){return pxt.BrowserUtils.containsClass(t,e)},t.addClass=function(t,e){pxt.BrowserUtils.addClass(t,e)},t.removeClass=function(t,e){pxt.BrowserUtils.removeClass(t,e)}}(e=t.svg||(t.svg={})),t.parseColour=function(t){const e=Number(t);return isNaN(e)?goog.isString(t)&&t.match(/^#[0-9a-fA-F]{6}$/)?t:"#000":Blockly.hueToRgb(e)},t.bitmapToImageURI=function(t,e,i){const o=pxt.appTarget.runtime.palette.slice(1),s=document.createElement("canvas");s.width=e,s.height=e;const l=Math.min(e/t.width,e/t.height),n=Math.max(Math.floor(e*(1-t.width/t.height)/2),0),r=Math.max(Math.floor(e*(1-t.height/t.width)/2),0);let a;i?(a=s.getContext("2d",{alpha:!1}),a.fillStyle="#dedede",a.fillRect(0,0,e,e)):a=s.getContext("2d");for(let e=0;e<t.width;e++)for(let s=0;s<t.height;s++){const c=t.get(e,s);c?(a.fillStyle=o[c-1],a.fillRect(n+e*l,r+s*l,l,l)):i&&(a.fillStyle="#dedede",a.fillRect(n+e*l,r+s*l,l,l))}return s.toDataURL()},t.tilemapToImageURI=function(t,e,i){const o=pxt.appTarget.runtime.palette.slice(),s=document.createElement("canvas");s.width=e,s.height=e;const l=Math.min(e/t.tilemap.width,e/t.tilemap.height),n=Math.max(Math.floor(e*(1-t.tilemap.width/t.tilemap.height)/2),0),r=Math.max(Math.floor(e*(1-t.tilemap.height/t.tilemap.width)/2),0);let a;i?(a=s.getContext("2d",{alpha:!1}),a.fillStyle="#dedede",a.fillRect(0,0,e,e)):a=s.getContext("2d");let c=[];for(let e=0;e<t.tilemap.width;e++)for(let s=0;s<t.tilemap.height;s++){const u=t.tilemap.get(e,s);if(u){if(!c[u]){const e=t.tileset.tiles[u];c[u]=e?pxt.sprite.computeAverageColor(pxt.sprite.Bitmap.fromData(e.bitmap),o):"#dedede"}a.fillStyle=c[u],a.fillRect(n+e*l,r+s*l,l,l)}else i&&(a.fillStyle="#dedede",a.fillRect(n+e*l,r+s*l,l,l))}return s.toDataURL()},t.getAllBlocksWithTilemaps=o,t.getAllBlocksWithTilesets=s,t.needsTilemapUpgrade=function(t){return!!t.getVariablesOfType(pxt.sprite.BLOCKLY_TILESET_TYPE).map((t=>pxt.sprite.legacy.blocklyVariableToTile(t.name))).length},t.upgradeTilemapsInWorkspace=function(t,e){const l=t.getVariablesOfType(pxt.sprite.BLOCKLY_TILESET_TYPE).map((t=>pxt.sprite.legacy.blocklyVariableToTile(t.name)));if(l.length)try{Blockly.Events.disable();let n=[];for(const o of l)o.qualifiedName?n[o.projectId]=e.resolveTile(o.qualifiedName):o.data&&(n[o.projectId]=e.createNewTile(o.data,"myTiles.tile"+o.projectId)),i(t,o);const r=o(t);for(const t of r){const i=pxt.sprite.legacy.decodeTilemap(t.ref.getInitText(),"typescript"),o=[],s=new pxt.sprite.TilemapData(i.tilemap,{tileWidth:i.tileset.tileWidth,tiles:i.tileset.tiles.map(((t,i)=>null!=t.projectId?n[t.projectId]:(o[i]||(o[i]=e.resolveTile(t.qualifiedName)),o[i])))},i.layers);t.ref.setValue(pxt.sprite.encodeTilemap(s,"typescript"))}const a=s(t);for(const t of a)t.ref.doValueUpdate_(t.ref.getValue()),t.ref.isDirty_&&t.ref.forceRerender()}finally{Blockly.Events.enable()}},t.getAllReferencedTiles=function(t,e){var i;let l={};const n=o(t),r=pxt.react.getTilemapProject();for(const t of n)if(t.block.id!==e)for(const e of(null===(i=t.ref.getTileset())||void 0===i?void 0:i.tiles)||[])l[e.id]=r.lookupAsset("tile",e.id);const a=r.getAssets("tilemap");for(const t of a)for(const e of t.data.tileset.tiles)l[e.id]=r.lookupAsset("tile",e.id);const c=s(t);for(const t of c){const e=t.ref.getValue(),i=/^\s*assets\s*\.\s*tile\s*`([^`]*)`\s*$/.exec(e);if(i){const t=r.lookupAssetByName("tile",i[1]);t&&!l[t.id]&&(l[t.id]=t)}else l[e]||(l[e]=r.resolveTile(e))}return Object.keys(l).map((t=>l[t])).filter((t=>!!t))},t.getTemporaryAssets=function(e,i){switch(i){case"image":return l(e,(e=>e instanceof t.FieldSpriteEditor&&e.isTemporaryAsset())).map((t=>t.ref.getAsset()));case"animation":return l(e,(e=>e instanceof t.FieldAnimationEditor&&e.isTemporaryAsset())).map((t=>t.ref.getAsset()));default:return[]}}}(pxtblockly||(pxtblockly={}));